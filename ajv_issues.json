[{"body":"I was struggling for hours with an error only happening in my deployed function, but not locally.\nTurns out, since I generate the schema programmatically, I had some optional property that was undefined in the schema. This causes AJV to throw `TypeError: Cannot convert undefined or null to object`.\n\nI logged my schema and data, copy pasted it in a local test program and spent HOURS not understanding what was happening. Why was it working locally but not when running in my deployed function?\nTurns out the schema had an `undefined` in it, which was of course trimmed away silently when logging to cloud watch, hence not ending up in my local test program.\n\nis there any reason Ajv could not ignore undefineds? I assume it does something like iterate properties using `Object.keys` or `for const k in obj`, and just checking `if obj[k] === undefined {<skip this>}` seems harmless?\n\n<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\najv 8.17.1 - latest\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\n{strictSchema: false}\n\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n  type: \"object\", \n  properties: {\n    foo: {type: \"string\"},\n    bar: undefined\n  }\n}\n\n```\n\n**Sample data**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{foo:  \"FOO\"}\n\n```\n\n**Your code**\n\n<!--\nPlease:\n- make it as small as possible to reproduce the issue\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\n- use `options`, `schema` and `data` as variables, do not repeat their values here\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\n\nIt would make understanding your problem easier and the issue more useful to others.\nThank you!\n-->\n\n```javascript\nnew Ajv({strictSchema: false}).validate(schema, data);\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```\nTypeError: Cannot convert undefined or null to object\n```\n\n**What results did you expect?**\n\nI expected `undefined` values in schemas to be ignored silently and the object to match the schema.\n\n**Are you going to resolve the issue?**\n\nI'm happy to attempt at a PR\n","comments":[],"createdAt":"2026-01-28T15:59:01Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2578,"title":"undefined values in schemas are not ignored but throws TypeError"},{"body":"I am encountering issues with the JSON Schema validation for both the `date-time` and `time` formats. The validator is incorrectly accepting invalid strings that should be rejected according to the ISO 8601 standard.\n\n### 1. Invalid `date-time` Format:\n\nThe following date-time string is being accepted as valid, but it should be considered invalid:\n\n- Valid date-time: `2024-06-01T12:34:56Z`\n- Invalid date-time (but accepted): `2024-06-01T12:34:56ZAS`\n\nThe `ZAS` suffix is not part of the correct ISO 8601 format, yet the validator allows it.\n\n### 2. Invalid `time` Format (with Offset):\n\nThe following time string with an offset is accepted as valid, which is correct:\n\n- Valid time with offset: `12:34:56+12:44`\n\nHowever, the following string is also accepted, which should **not** be valid:\n\n- Invalid time with extraneous characters: `12:34:56+12:44AS`\n\nThe `AS` suffix is not part of the valid ISO 8601 time format with offset, but the validator incorrectly allows it.\n\n### Expected Behavior:\n1. For the `date-time` format, only valid ISO 8601 date-time strings (e.g., `2024-06-01T12:34:56Z`) should be accepted, and any additional suffixes (like `ZAS`) should be rejected.\n2. For the `time` format with offset, only valid time strings with an offset (e.g., `12:34:56+12:44`) should be accepted. Any extra characters (like `AS` in `12:34:56+12:44AS`) should cause the string to fail validation.\n\n### Steps to Reproduce:\n1. Use a JSON Schema validator that supports the `date-time` and `time` formats (e.g., AJV, Joi, etc.).\n2. Provide the following strings as input:\n   - `2024-06-01T12:34:56ZAS` for `date-time`.\n   - `12:34:56+12:44AS` for `time` with offset.\n3. Both strings should be rejected, but the validator accepts them as valid.\n\n### Version of the Validator:\n- Version: 1.4.0\n\n### Additional Notes:\n- The issue arises when extra characters are appended to valid time strings, which should be rejected.\n- This behavior could be problematic when ensuring strict ISO 8601 conformance for both `date-time` and `time` fields with offsets.\n\nThanks for investigating this!","comments":[],"createdAt":"2026-01-08T10:38:52Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2572,"title":"Issue: Invalid `date-time` and `time` Formats Accepted"},{"body":"It is heavily used library, and with browsers moving more towards native, the require() usage in Ajv becomes invalid.\n\nFor example native-federation uses ESM modules through importMaps.\nBrowser does not support commonJs modules in this case - require() is primarily for nodejs.\n\nThe flags in new Ajv() for esm etc do not apply - since the code itself fails to parse before it is executed. It does runtime imports of dependencies.\n\nRight now i use a custom hack where i use esbuild t orecompile the dist/ajv.js, then use a wrapper .msj that reexports the Ajv.\nAnd use the native federation sharing functionality to rewrite the provided code entrypoints for Ajv package.\n\n","comments":[],"createdAt":"2025-12-12T14:40:52Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2569,"title":"ESM native Ajv support in the (near)future or will it remain commonjs/require based?"},{"body":"No activity in a year, does this need more maintainers?","comments":[{"id":"IC_kwDOAiQBJM7civCd","author":{"login":"mahnunchik"},"authorAssociation":"NONE","body":"?","createdAt":"2025-12-30T18:04:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2568#issuecomment-3700093085","viewerDidAuthor":false}],"createdAt":"2025-12-07T15:54:19Z","labels":[],"number":2568,"title":"Last commit Dec 16, 2024?"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n8.17.1 - currently latest available version\n\n**Ajv options object**\n\n```typescript\n// not needed, just Typescript Types\n```\n\n**JSON Schema**\n\n```json\n{\n    \"type\": \"object\",\n    \"discriminator\": {\n        \"propertyName\": \"animal\"\n    },\n    \"required\": [\"animal\"],\n    \"oneOf\": [\n        {\n            \"title\": \"Cat\",\n            \"properties\": {\n                \"animal\": {\n                    \"const\": \"Cat\"\n                },\n                \"food\": {\n                    \"enum\": [\"meat\", \"grass\", \"fish\"],\n                    \"type\": \"string\"\n                }\n            },\n            \"required\": [\"food\"]\n        },\n        {\n            \"title\": \"Fish\",\n            \"properties\": {\n                \"animal\": {\n                    \"const\": \"Fish\"\n                },\n                \"food\": {\n                    \"enum\": [\"insect\", \"worms\"],\n                    \"type\": \"string\"\n                },\n                \"water\": {\n                    \"enum\": [\"lake\", \"sea\"],\n                    \"type\": \"string\"\n                }\n            },\n            \"required\": [\"food\", \"water\"]\n        }\n    ]\n}\n```\n\n**Sample data**\n\n```typescript\n// not needed, just Typescript Types\n```\n\n**Your code**\n\n```typescript\ntype AnimalExampleType =\n    | {\n          animal: \"Cat\";\n          ears: number; // missing in schema intentionally\n          food: \"fish\" | \"grass\" | \"meat\";\n      }\n    | {\n          animal: \"Fish\";\n          food: \"insect\" | \"worms\";\n          water: \"lake\" | \"sea\";\n      };\n\n// should report error in tsc, because 'ears' are missing in 'Cat'\nconst AnimalExampleSchema_OneOf: JSONSchemaType<AnimalExampleType> = {\n    type: \"object\",\n    discriminator: {\n        propertyName: \"animal\",\n    },\n    required: [\"animal\"],\n    oneOf: [\n        {\n            title: \"Cat\",\n            properties: {\n                animal: {\n                    const: \"Cat\",\n                },\n                food: {\n                    enum: [\"meat\", \"grass\", \"fish\"],\n                    type: \"string\",\n                },\n            },\n            required: [\"food\"],\n        },\n        {\n            title: \"Fish\",\n            properties: {\n                animal: {\n                    const: \"Fish\",\n                },\n                food: {\n                    enum: [\"insect\", \"worms\"],\n                    type: \"string\",\n                },\n                water: {\n                    enum: [\"lake\", \"sea\"],\n                    type: \"string\",\n                },\n            },\n            required: [\"food\", \"water\"],\n        },\n    ],\n};\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```typescript\n// no tsc errors appear, even the 'ears' for 'Cat' are missing\n```\n\n**What results did you expect?**\ntsc to report Type mismatch","comments":[{"id":"IC_kwDOAiQBJM7daSjv","author":{"login":"Suhas-098"},"authorAssociation":"NONE","body":"I've verified this locally on v8.17.1 (the latest available version) and confirmed it is indeed not working as expected.\n\nIn my test setup (TS 5.9.3, strict mode on), I created a union type with required properties. Even when I intentionally left those properties out of the schema's one Of branches, tsc reported 0 errors. However, as a control test, I changed the top-level type from \"object\" to \"string\", and TypeScript correctly flagged that as an error. This confirms that the type-checking logic is specifically failing to distribute the strictness across the union branches.\n\n<img width=\"1034\" height=\"1086\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/a2da13ba-14f3-40c5-9f4a-75ea39aad14c\" />","createdAt":"2026-01-06T13:14:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2567#issuecomment-3714656495","viewerDidAuthor":false}],"createdAt":"2025-10-27T09:28:01Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2567,"title":"JSONSchemaType not matching Typescript Type on oneOf with objects"},{"body":"## Overview\n\nAs the most popular JSON Schema validator with 100M+ downloads per month, Ajv is a critical piece of infrastructure for countless applications. While Ajv is already the fastest validator available, there are several additional optimization opportunities that could provide meaningful performance improvements for high-throughput validation scenarios.\n\nI've been exploring performance optimizations in a fork and wanted to share some ideas that could benefit the broader Ajv community. These suggestions focus on areas not yet fully optimized while maintaining full JSON Schema spec compliance and backward compatibility.\n\n## Proposed Optimizations\n\n### 1. Validation Result Memoization for Immutable Data\n\n**Problem**: When validating the same data against the same schema multiple times (common in caching layers, batch processing, or middleware pipelines), Ajv re-validates from scratch each time.\n\n**Solution**: Add an optional validation result cache using a WeakMap to store validation results for immutable data objects.\n\n**Implementation approach**:\n```javascript\nclass Ajv {\n  constructor(opts = {}) {\n    // ... existing code ...\n    if (opts.memoizeValidation) {\n      this._validationCache = new WeakMap(); // schema -> WeakMap<data, result>\n    }\n  }\n\n  validate(schema, data) {\n    if (this._validationCache) {\n      const schemaCache = this._validationCache.get(schema);\n      if (schemaCache?.has(data)) {\n        return schemaCache.get(data);\n      }\n    }\n    \n    const result = this._performValidation(schema, data);\n    \n    if (this._validationCache && typeof data === 'object' && data !== null) {\n      let schemaCache = this._validationCache.get(schema);\n      if (!schemaCache) {\n        schemaCache = new WeakMap();\n        this._validationCache.set(schema, schemaCache);\n      }\n      schemaCache.set(data, result);\n    }\n    \n    return result;\n  }\n}\n```\n\n**Performance impact**: 10-100x faster for repeated validation of the same data objects. No memory leaks since WeakMap allows garbage collection.\n\n**Use cases**: \n- API middleware that validates the same config objects repeatedly\n- Batch processors validating arrays of similar objects\n- GraphQL resolvers with cached data\n\n---\n\n### 2. Compiled Error Message Templates\n\n**Problem**: Error message generation involves string concatenation and template evaluation on every validation failure, which can be expensive in high-error scenarios.\n\n**Solution**: Pre-compile error message templates during schema compilation and use optimized string builders.\n\n**Implementation approach**:\n```javascript\n// During schema compilation\nfunction compileErrorTemplate(keyword, schemaPath) {\n  // Pre-allocate string parts that never change\n  const staticParts = {\n    prefix: \\`data\\${schemaPath}\\`,\n    keyword: keyword\n  };\n  \n  // Generate optimized error function\n  return (params) => {\n    // Use array join instead of repeated concatenation\n    const parts = [staticParts.prefix, ' ', getErrorMessage(keyword, params)];\n    return parts.join('');\n  };\n}\n\n// In generated validation code\nconst errorTemplate = compileErrorTemplate('type', '/properties/age');\nif (!isValid) {\n  errors.push({\n    message: errorTemplate({type: schema.type, actual: typeof data}),\n    // ... other error properties\n  });\n}\n```\n\n**Performance impact**: 20-40% faster error generation, especially with \\`allErrors: true\\` option.\n\n---\n\n### 3. Type-Checking Fast Paths for Common Patterns\n\n**Problem**: The generated validation code checks types using generic \\`typeof\\` and \\`Array.isArray()\\` even for schemas where the type is statically known.\n\n**Solution**: Generate specialized validation functions for common type patterns.\n\n**Implementation approach**:\n```javascript\n// Current approach (generic)\nfunction validate(data) {\n  if (typeof data !== \"object\" || Array.isArray(data) || data === null) {\n    return false;\n  }\n  // ... property validation\n}\n\n// Optimized approach (when schema.type === \"object\" && no other types)\nfunction validate(data) {\n  // Fast path: single type check with all conditions\n  const isObject = data !== null && typeof data === \"object\" && !Array.isArray(data);\n  if (!isObject) return false;\n  \n  // Direct property access without additional type checks\n  const age = data.age;\n  if (typeof age !== \"number\") return false;\n  // ... continue validation\n}\n```\n\n**Performance impact**: 5-15% faster for object-heavy schemas (the most common case).\n\n**Additional optimization**: For schemas with \\`properties\\` but no \\`additionalProperties\\` or \\`patternProperties\\`, generate code that only checks known properties instead of iterating all keys.\n\n---\n\n### 4. Format Validation Result Caching\n\n**Problem**: Format validators (email, uri, date-time, etc.) use expensive regex operations that are re-executed for identical strings.\n\n**Solution**: Cache format validation results for recently seen string values.\n\n**Implementation approach**:\n```javascript\nclass FormatCache {\n  constructor(maxSize = 1000) {\n    this.cache = new Map();\n    this.maxSize = maxSize;\n  }\n  \n  validate(format, value, validator) {\n    const key = \\`\\${format}:\\${value}\\`;\n    \n    if (this.cache.has(key)) {\n      return this.cache.get(key);\n    }\n    \n    const result = validator(value);\n    \n    // LRU eviction when cache is full\n    if (this.cache.size >= this.maxSize) {\n      const firstKey = this.cache.keys().next().value;\n      this.cache.delete(firstKey);\n    }\n    \n    this.cache.set(key, result);\n    return result;\n  }\n}\n\n// Usage in generated code\nconst formatCache = new FormatCache();\nif (schema.format) {\n  if (!formatCache.validate('email', data, formats.email)) {\n    // ... error handling\n  }\n}\n```\n\n**Performance impact**: 30-70% faster format validation for schemas with many format checks on duplicate values (e.g., validating arrays of emails).\n\n**Configuration**: Add option \\`formatCache: boolean | number\\` where number specifies cache size.\n\n---\n\n### 5. Schema Traversal Optimization via Schema Analysis\n\n**Problem**: For complex schemas with many \\`oneOf\\`/\\`anyOf\\` branches, Ajv validates all branches sequentially even when early analysis could eliminate branches.\n\n**Solution**: Add a pre-validation analysis phase that examines the data structure to eliminate impossible schema branches.\n\n**Implementation approach**:\n```javascript\n// For schema with oneOf based on discriminator-like patterns\nconst schema = {\n  oneOf: [\n    {properties: {type: {const: \"cat\"}, meow: {type: \"string\"}}},\n    {properties: {type: {const: \"dog\"}, bark: {type: \"string\"}}}\n  ]\n};\n\n// Generate discriminator fast-path\nfunction validate(data) {\n  // Pre-check discriminator\n  const discriminator = data?.type;\n  \n  if (discriminator === \"cat\") {\n    return validateCat(data);  // Only check cat schema\n  } else if (discriminator === \"dog\") {\n    return validateDog(data);  // Only check dog schema\n  }\n  \n  // Fallback to full oneOf validation if discriminator missing\n  return validateOneOf(data);\n}\n```\n\n**Performance impact**: 40-80% faster for schemas with discriminator patterns (very common in API validation).\n\n**Note**: The existing \\`discriminator\\` keyword could be enhanced with auto-detection for common patterns.\n\n---\n\n## Implementation Considerations\n\n### Backward Compatibility\n- All optimizations should be opt-in via options (except safe optimizations like type-checking fast paths)\n- Maintain full JSON Schema spec compliance\n- Ensure identical validation results (optimizations affect only performance, not correctness)\n\n### Memory Management\n- Use WeakMap for object-based caches to prevent memory leaks\n- Provide configurable cache size limits\n- Document memory/performance tradeoffs\n\n### Benchmarking\nI'd be happy to:\n- Create comprehensive benchmarks comparing baseline vs optimized implementations\n- Test against real-world schemas from popular APIs\n- Provide performance regression tests\n\n### Testing\n- All optimizations should pass existing test suite\n- Add specific tests for cache invalidation and edge cases\n- Verify no behavioral changes under spec compliance\n\n---\n\n## Real-World Impact\n\nGiven Ajv's usage in:\n- **API validation** (Express, Fastify, etc.) - where validation is often the bottleneck\n- **Config validation** - where the same schemas validate similar data repeatedly  \n- **Data pipelines** - processing millions of records\n- **GraphQL** - validating complex nested structures\n\nEven small percentage improvements can translate to:\n- Reduced server costs\n- Lower latency for end users\n- Better resource utilization\n- Improved developer experience\n\n---\n\n## Next Steps\n\nI'm happy to:\n1. Contribute PRs for any/all of these optimizations\n2. Create detailed benchmarks showing performance improvements\n3. Write documentation and migration guides\n4. Collaborate on implementation approach and code review\n\nPlease let me know which optimizations would be most valuable to the project, and I'll prioritize accordingly.\n\nThank you for maintaining such a critical piece of the JavaScript ecosystem!","comments":[],"createdAt":"2025-10-05T00:19:17Z","labels":[],"number":2565,"title":"Performance optimization opportunities for JSON Schema validation"},{"body":"Recent [supply chain attacks on npm](https://github.blog/security/supply-chain-security/our-plan-for-a-more-secure-npm-supply-chain/) have highlighted the need for stronger package publishing security. The September 2025 Shai-Hulud worm compromised 500+ packages through stolen maintainer tokens, showing the risks of token-based publishing.\n\nTrusted publishing helps by eliminating long-lived tokens that can be stolen or accidentally exposed; generating automatic provenance provides cryptographic proof of where/how packages are built; and is an industry standard adopted by PyPI, RubyGems, crates.io, NuGet, etc.\n\nHere's the short version:\n\n1. [Configure a trusted publisher on npmjs.com](https://docs.npmjs.com/trusted-publishers#github-actions-configuration)\n1. Add `id-token: write` permission to your workflow\n1. Remove `NODE_AUTH_TOKEN` from your workflow\n\nnpm is [planning to deprecate legacy tokens](https://github.blog/security/supply-chain-security/our-plan-for-a-more-secure-npm-supply-chain/#h-npm-s-roadmap-for-hardening-package-publication) and make trusted publishing the preferred method.\n\nWould you consider adopting trusted publishing to help secure the npm ecosystem?\n\nReferences:\n\n- [npm trusted publishing documentation](https://docs.npmjs.com/trusted-publishers)\n- [Announcement blog post](https://github.blog/changelog/2025-07-31-npm-trusted-publishing-with-oidc-is-generally-available/)\n- [Provenance statements guide](https://docs.npmjs.com/generating-provenance-statements)","comments":[],"createdAt":"2025-09-27T18:04:08Z","labels":[],"number":2564,"title":"Consider adopting npm trusted publishing"},{"body":"`JTDSchemaType` has no `id` or `$id` property","comments":[{"id":"IC_kwDOAiQBJM7C6mXn","author":{"login":"olfek"},"authorAssociation":"NONE","body":"Which I'd like to use to do this -\n\nhttps://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/core.ts#L127\n\nhttps://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/core.ts#L484-L493\n\nAnd with all due respect, the typing in this library feels like a mess ðŸ˜¢","createdAt":"2025-09-09T10:55:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2563#issuecomment-3270141415","viewerDidAuthor":false}],"createdAt":"2025-09-09T10:47:30Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2563,"title":"`JTDSchemaType` has no `id` or `$id` property"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\nLatest (v8.17.1)\n\n**Ajv options object**\n\nAny options.\n\n**JSON Schema**\n\n```json\n{ \"multipleOf\": 1 }\n```\n\n**Sample data**\n\n```json\n1e21\n```\n\n**What results did you expect?**\n\n1e21 should validate against `multipleOf: 1`, but it doesn't.\n\n**Are you going to resolve the issue?**\n\nYup: https://github.com/ajv-validator/ajv/pull/2562","comments":[],"createdAt":"2025-09-09T04:00:26Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2561,"title":"`multipleOf` validation is incorrect for large integers"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for change proposals.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv you are you using?**\n\n^8.17.1\n\n**What problem do you want to solve?**\n\nI work on a back-end framework with a fetching library that performs Zod validation on server-side and Ajv validation on the client-side. The JSON schema is generated using the built-in zod@4 `toJSONSchema` function that converts `z.file()` schema into OAS-compatible format:\n\n```ts\n{ type: \"string\", format: \"binary\", contentEncoding: \"binary\" }\n```\n\nSee https://zod.dev/json-schema?id=file-schemas\n\nThe problem is that on the client-side the `File` and `Blob` instances that are sent with `FormData`, as expected, are interpreted as objects. I tried to add a custom format to handle that case:\n\n```ts\najv.addFormat('binary', {\n    type: 'string',\n    validate: (data) => data instanceof Blob,\n  });\n```\n\nBut AJV still treats the field as a string, ignoring the `validate` option and throwing the same validation error: `data/file must be string`\n\nI attempted to fix that by replacing the `format: \"binary\"` schemas with `type: \"object\"` and using `addFormat` to define the format of the object, but AJV doesn't support `addFormat` for object types.\n\nThe only workaround worked is modifying the input data itself and replacing `File` and `Blob` by a hard-coded string.\n \n**What do you think is the correct solution to problem?**\n\nAJV should support hooking into the format interpretation, avoiding preliminary checks of an actual type. How to do that is up to the authors, but it might be another method such as `addFormatInterpretation` or an option like `ignoreActualType` for `addFormat` method.\n\n**Will you be able to implement it?**\n\nNo. This change requires to adjust the design of AJV library, but I'm also not familiar with the AJV code.\n","comments":[],"createdAt":"2025-08-13T20:44:12Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2560,"title":"Support OAS-compatible file schema"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\nIssue is present in latest version (8.17.1) all the way back to when unevaluatedProperties was first supported in 7.0.0.\n\n**Ajv options object**\n\nIssue can be reproduced with no/default options object. Same issue occurs with `{ code: { source: true } }` (while I was tracing through the generated code).\n\n**JSON Schema**\n\n```json\n{\n    \"type\": \"object\",\n    \"$ref\": \"#/$defs/parent\",\n    \"oneOf\": [\n        {\n            \"type\": \"object\",\n            \"required\": [\"propFrom1stOneOf\"],\n            \"properties\": {\n                \"propFrom1stOneOf\": true\n            }\n        },\n        {\n            \"type\": \"object\",\n            \"required\": [\"propFrom2ndOneOf\"],\n            \"properties\": {\n                \"propFrom2ndOneOf\": true\n            }\n        }\n    ],\n    \"unevaluatedProperties\": false,\n    \"$defs\": {\n        \"parent\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"propFromParent\": true\n            }\n        }\n    }\n}\n```\n\n**Sample data**\n\nWorks as expected:\n\n```json\n{ \"propFromParent\": true, \"propFrom1stOneOf\": true }\n```\n\nFails with unevaluatedProperties error for propFromParent:\n\n```json\n{ \"propFromParent\": true, \"propFrom2ndOneOf\": true }\n```\n\n**Your code**\n\n```javascript\nconst assert = require(\"node:assert\");\nconst { writeFileSync } = require(\"node:fs\");\n\nconst Ajv = require(\"ajv/dist/2020\");\nconst standaloneCode = require(\"ajv/dist/standalone\");\n\nconst ajv = new Ajv(options);\nconst validate = ajv.compile(schema);\n// writeFileSync(\"./compiled.js\", standaloneCode(ajv, validate));\n\nassert(validate({ propFromParent: true, propFrom1stOneOf: true }));\nassert(validate({ propFromParent: true, propFrom2ndOneOf: true })); // ! Fails with unevaluatedProperties error for propFromParent.\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```json\n[\n  {\n    \"instancePath\": \"\",\n    \"schemaPath\": \"#/unevaluatedProperties\",\n    \"keyword\": \"unevaluatedProperties\",\n    \"params\": {\n      \"unevaluatedProperty\": \"propFromParent\"\n    },\n    \"message\": \"must NOT have unevaluated properties\"\n  }\n]\n```\n\n**What results did you expect?**\n\nProperties defined in the parent/`$ref` should be considered \"evaluated\" regardless of if or how the `oneOf` is satisfied.\n\n**Are you going to resolve the issue?**\n\nI've tried to dig into where the problem might be coming from, but I'm honestly a bit stumped.\n\nWhat I can say from looking at the compiled standalone code is that `propFromParent` is only added to the set of evaluated props if the first branch of the `oneOf` is satisfied.\n\nHere is the standalone code, formatted, and with a couple of comments highlighting what I think is going wrong:\n\n```js\n\"use strict\";\nmodule.exports = validate20;\nmodule.exports.default = validate20;\nconst schema31 = {\n    type: \"object\",\n    $ref: \"#/$defs/parent\",\n    oneOf: [\n        { type: \"object\", required: [\"propFrom1stOneOf\"], properties: { propFrom1stOneOf: true } },\n        { type: \"object\", required: [\"propFrom2ndOneOf\"], properties: { propFrom2ndOneOf: true } },\n    ],\n    unevaluatedProperties: false,\n    $defs: { parent: { type: \"object\", properties: { propFromParent: true } } },\n};\nconst schema32 = { type: \"object\", properties: { propFromParent: true } };\nfunction validate20(\n    data,\n    {\n        instancePath = \"\",\n        parentData,\n        parentDataProperty,\n        rootData = data,\n        dynamicAnchors = {},\n    } = {},\n) {\n    let vErrors = null;\n    let errors = 0;\n    const evaluated0 = validate20.evaluated;\n    if (evaluated0.dynamicProps) {\n        evaluated0.props = undefined;\n    }\n    if (evaluated0.dynamicItems) {\n        evaluated0.items = undefined;\n    }\n    const _errs0 = errors;\n    if (errors === _errs0) {\n        if (!(data && typeof data == \"object\" && !Array.isArray(data))) {\n            validate20.errors = [\n                {\n                    instancePath,\n                    schemaPath: \"#/$defs/parent/type\",\n                    keyword: \"type\",\n                    params: { type: \"object\" },\n                    message: \"must be object\",\n                },\n            ];\n            return false;\n        }\n    }\n// ! While evaluating the `$ref` (just the type assertion above, in this minimal example), propFromParent should be noted as an evaluated property.\n    var valid0 = _errs0 === errors;\n    if (valid0) {\n        const _errs3 = errors;\n        let valid1 = false;\n        let passing0 = null;\n        const _errs4 = errors;\n        if (errors === _errs4) {\n            if (data && typeof data == \"object\" && !Array.isArray(data)) {\n                let missing0;\n                if (data.propFrom1stOneOf === undefined && (missing0 = \"propFrom1stOneOf\")) {\n                    const err0 = {\n                        instancePath,\n                        schemaPath: \"#/oneOf/0/required\",\n                        keyword: \"required\",\n                        params: { missingProperty: missing0 },\n                        message: \"must have required property '\" + missing0 + \"'\",\n                    };\n                    if (vErrors === null) {\n                        vErrors = [err0];\n                    } else {\n                        vErrors.push(err0);\n                    }\n                    errors++;\n                }\n            } else {\n                const err1 = {\n                    instancePath,\n                    schemaPath: \"#/oneOf/0/type\",\n                    keyword: \"type\",\n                    params: { type: \"object\" },\n                    message: \"must be object\",\n                };\n                if (vErrors === null) {\n                    vErrors = [err1];\n                } else {\n                    vErrors.push(err1);\n                }\n                errors++;\n            }\n        }\n        var _valid0 = _errs4 === errors;\n        if (_valid0) {\n            valid1 = true;\n            passing0 = 0;\n            var props0 = {};\n            props0.propFrom1stOneOf = true;\n// ! propFromParent is marked as evaluated here, if and only if the 1st oneOf branch is satisfied.\n            props0.propFromParent = true;\n        }\n        const _errs6 = errors;\n        if (errors === _errs6) {\n            if (data && typeof data == \"object\" && !Array.isArray(data)) {\n                let missing1;\n                if (data.propFrom2ndOneOf === undefined && (missing1 = \"propFrom2ndOneOf\")) {\n                    const err2 = {\n                        instancePath,\n                        schemaPath: \"#/oneOf/1/required\",\n                        keyword: \"required\",\n                        params: { missingProperty: missing1 },\n                        message: \"must have required property '\" + missing1 + \"'\",\n                    };\n                    if (vErrors === null) {\n                        vErrors = [err2];\n                    } else {\n                        vErrors.push(err2);\n                    }\n                    errors++;\n                }\n            } else {\n                const err3 = {\n                    instancePath,\n                    schemaPath: \"#/oneOf/1/type\",\n                    keyword: \"type\",\n                    params: { type: \"object\" },\n                    message: \"must be object\",\n                };\n                if (vErrors === null) {\n                    vErrors = [err3];\n                } else {\n                    vErrors.push(err3);\n                }\n                errors++;\n            }\n        }\n        var _valid0 = _errs6 === errors;\n        if (_valid0 && valid1) {\n            valid1 = false;\n            passing0 = [passing0, 1];\n        } else {\n            if (_valid0) {\n                valid1 = true;\n                passing0 = 1;\n                if (props0 !== true) {\n                    props0 = props0 || {};\n                    props0.propFrom2ndOneOf = true;\n                }\n            }\n        }\n        if (!valid1) {\n            const err4 = {\n                instancePath,\n                schemaPath: \"#/oneOf\",\n                keyword: \"oneOf\",\n                params: { passingSchemas: passing0 },\n                message: \"must match exactly one schema in oneOf\",\n            };\n            if (vErrors === null) {\n                vErrors = [err4];\n            } else {\n                vErrors.push(err4);\n            }\n            errors++;\n            validate20.errors = vErrors;\n            return false;\n        } else {\n            errors = _errs3;\n            if (vErrors !== null) {\n                if (_errs3) {\n                    vErrors.length = _errs3;\n                } else {\n                    vErrors = null;\n                }\n            }\n        }\n    }\n    if (errors === 0) {\n        if (data && typeof data == \"object\" && !Array.isArray(data)) {\n            if (props0 !== true) {\n                for (const key0 in data) {\n                    if (!props0 || !props0[key0]) {\n                        validate20.errors = [\n                            {\n                                instancePath,\n                                schemaPath: \"#/unevaluatedProperties\",\n                                keyword: \"unevaluatedProperties\",\n                                params: { unevaluatedProperty: key0 },\n                                message: \"must NOT have unevaluated properties\",\n                            },\n                        ];\n                        return false;\n                        break;\n                    }\n                }\n            }\n        } else {\n            validate20.errors = [\n                {\n                    instancePath,\n                    schemaPath: \"#/type\",\n                    keyword: \"type\",\n                    params: { type: \"object\" },\n                    message: \"must be object\",\n                },\n            ];\n            return false;\n        }\n    }\n    validate20.errors = vErrors;\n    return errors === 0;\n}\nvalidate20.evaluated = { props: true, dynamicProps: false, dynamicItems: false };\n```","comments":[{"id":"IC_kwDOAiQBJM6ykybj","author":{"login":"dylankerr-bis"},"authorAssociation":"NONE","body":"Looking at the implementation of `$ref`, it seems to be using `cxt.mergeEvaluated` to copy the props from the ref schema into `it` (the root schema) but not writing any generated code - possibly because `cxt.mergeEvaluated`'s 2nd parameter `toName` isn't being passed.\nThen when the `oneOf` is compiled, the props from the oneOf schema are merged into `it.props` *and* the merge result is written to the generated code.\nI'm not certain what would be correct, but this definitely seems wrong. The props from different scopes (the ref schema vs. the oneOf schema) are being mixed together.","createdAt":"2025-06-23T11:07:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2559#issuecomment-2995988195","viewerDidAuthor":false}],"createdAt":"2025-06-20T17:28:51Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2559,"title":"unevaluatedProperties can conflict with oneOf"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\n8.17.1\n\n**TypeScript version**\n\n5.8.3\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\n// none\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\nFor the bug report, I used the JSON from the documentation https://ajv.js.org/guide/typescript.html#utility-types-for-schemas\n\n```json\n{\n    \"type\": \"object\",\n    \"properties\": {\n        \"foo\": { \"type\": \"integer\" },\n        \"bar\": { \"type\": \"string\", \"nullable\": true }\n    },\n    \"required\": [\"foo\"],\n    \"additionalProperties\": false\n}\n```\n\n**Sample data**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\nIt's only about typing.\n\n**Your code**\n\n<!--\nPlease:\n- make it as small as possible to reproduce the issue\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\n- use `options`, `schema` and `data` as variables, do not repeat their values here\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\n\nIt would make understanding your problem easier and the issue more useful to others.\nThank you!\n-->\n\nIt's similar to the code in the documentation  https://ajv.js.org/guide/typescript.html#utility-types-for-schemas, except that the JSON string is not written as string literal as part of the initialization, but separately\n\n```typescript\nconst schemaFromObject = {\n        \"type\": \"object\",\n        \"properties\": {\n            \"foo\": { \"type\": \"integer\" },\n            \"bar\": { \"type\": \"string\", \"nullable\": true }\n        },\n        \"required\": [\"foo\"],\n        \"additionalProperties\": false\n    }\nconst schema: JSONSchemaType<MyData> = schemaFromObject;\n```\n\nI also have variants reading the JSON from other files etc., which are also not working. But this is the smallest change compared to the documentation.\n\n**Expected Result**\n\nThis code should work similar to https://ajv.js.org/guide/typescript.html#utility-types-for-schemas\n\n**Actual Result**\n\nA type error is emitted (by tsc):\n\n```markdown\nType '{ type: string; properties: { foo: { type: string; }; bar: { type: string; nullable: boolean; }; }; required: string[]; additionalProperties: boolean; }' is not assignable to type 'JSONSchemaType<MyData>'.\n  Type '{ type: string; properties: { foo: { type: string; }; bar: { type: string; nullable: boolean; }; }; required: string[]; additionalProperties: boolean; }' is not assignable to type '({ anyOf: readonly UncheckedJSONSchemaType<MyData, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<...>> | undefined; definitions?: Record<...> | undefined; }) | ({ ...; } & { ...; })'.\n    Type '{ type: string; properties: { foo: { type: string; }; bar: { type: string; nullable: boolean; }; }; required: string[]; additionalProperties: boolean; }' is not assignable to type '{ oneOf: readonly UncheckedJSONSchemaType<MyData, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<...>> | undefined; definitions?: Record<...> | undefined; }'.\n      Property 'oneOf' is missing in type '{ type: string; properties: { foo: { type: string; }; bar: { type: string; nullable: boolean; }; }; required: string[]; additionalProperties: boolean; }' but required in type '{ oneOf: readonly UncheckedJSONSchemaType<MyData, false>[]; }'.ts(2322)\njson-schema.d.ts(25, 5): 'oneOf' is declared here.\n---\nconst schema: JSONSchemaType<MyData>\n```\n\n**Remarks**\n\nThere are a lot of related reports, here is only a list of some of them:\n- #2521\n- #2518\n- #2283\n- #2227\n- #2043\n- #2040\n- #1988\n- #1845\n- #1664\n- #1521\n\nWhile one can argue in some cases that the schema has to be defined differently, I would say due to the large number of reports and even the example in the documentation failing, there is a fundamental problem in the type definition somewhere.\n\nFortunately there is a simple workaround:\n```typescript\nconst schema = schemaFromObject  as JSONSchemaType<MyData>;\n```\nOf course, this does not check the schema at all.","comments":[{"id":"IC_kwDOAiQBJM7NpWRg","author":{"login":"ldrick"},"authorAssociation":"NONE","body":"You could use `as const` like this, to keep Typechecks in place:\n\n```typescript\ninterface MyData {\n    bar?: string;\n    foo: number;\n}\n\nconst schemaFromObject = {\n    additionalProperties: false,\n    properties: {\n        bar: { nullable: true, type: \"string\" },\n        foo: { type: \"integer\" },\n    },\n    required: [\"foo\"],\n    type: \"object\",\n} as const; // <-- here\nconst schema: JSONSchemaType<MyData> = schemaFromObject;\n```","createdAt":"2025-10-27T09:01:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2558#issuecomment-3450168416","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7PNlTP","author":{"login":"jpilgrim"},"authorAssociation":"NONE","body":"@ldrick Thank you! Of course, const assertions! Alas that's not working in my real example, which I would consider a typical, if not even THE typical use case:\n\n```typescript\nimport { type MyData } from \"./my.schema\"; // Root of my model\nimport schemaJson from \"./my.schema.json\"; // Real schema, also used by other tools (e.g., VS Code editor)\n...\nconst schema: JSONSchemaType<MyData> = schemaJson as const; // not working:\n  // \"A 'const' assertions can only be applied to references to enum members, or string, number, boolean, array, or object literals.\"\n```\n\nThe npm [ts-json-as-const](https://www.npmjs.com/package/ts-json-as-const) may be used as a workaround, though.","createdAt":"2025-11-01T15:06:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2558#issuecomment-3476444367","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7PNnmq","author":{"login":"ldrick"},"authorAssociation":"NONE","body":"@jpilgrim This is exactly what I would also love to see, too. Requires Typescript to allow const import - having additional lib to workaround is not suitable for my team [https://github.com/microsoft/TypeScript/issues/32063](https://github.com/microsoft/TypeScript/issues/32063) or have the Types here working without const - you're right.","createdAt":"2025-11-01T15:19:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2558#issuecomment-3476453802","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7PSzD8","author":{"login":"jpilgrim"},"authorAssociation":"NONE","body":"@ldrick Just as a follow up: Instead of using a library to prepare the json file, a single script in the package.json file would do the trick as well (not tested on windows, so instead of a (*nix) bash script you may want to use a javascript script):\n\n```jsonc\n\"scripts\": {\n   // ...\n   \"genjsonconst\": \"JSON=src/folder/my.schema.json; echo \\\"/* Generated, do not modify */\\nexport default \\\" >$JSON.const.ts && cat $JSON >> $JSON.const.ts && echo \\\" as const;\\\" >> $JSON.const.ts\",\n   // ...\n}\n```\n\nAnd you have to change the import:\n```diff\n- import schemaJson from \"./my.schema.json\";\n+ import schemaJson from \"./my.schema.json.const\";\n```\n\nWhile this solves the const assertions problem, it does not solve all the other type related problems I mentioned above.","createdAt":"2025-11-02T09:53:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2558#issuecomment-3477811452","viewerDidAuthor":false}],"createdAt":"2025-06-16T19:38:46Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2558,"title":"JSONSchemaType with TypeScript is broken"},{"body":"We recently updated our code to use v8.17.1 from v6.12.6 and found it has introduced a memory leak related to the validate() function. We separately use compile() elsewhere which appears to be unaffected.\n\nIt was quite serious as it nearly brought our service down.\n\n\n\n","comments":[{"id":"IC_kwDOAiQBJM6_hdlx","author":{"login":"andreasvoigt"},"authorAssociation":"NONE","body":"In one of my projects, we run into a huge memory leak using ajv. In our case we used the ajv instance on a static class member. Using `compile` on this static instance object creates a memory leak. I didn't had the time to look completely into the code of ajv. Maybe there is a known reason behind this and this behavior is intended? I would have expected that the validation function created as the output of compile hold's \"all the magic\" and the used memory will be freed by GC after leaving the scope.\n\nI tried with the latest versions of ajv: 8.17.1 and 8.16.0","createdAt":"2025-08-22T06:37:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2557#issuecomment-3213220209","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7BYGQ5","author":{"login":"roger-soler-deel"},"authorAssociation":"NONE","body":"We are also experiencing memory leaks with AJV.\n\nWe created a test setup where we create a schema, we compile it, validate data, and then we call `removeSchema` and GC. And memory increases indefinitely.\n\n","createdAt":"2025-09-02T08:24:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2557#issuecomment-3244319801","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7Faia2","author":{"login":"marcbachmann"},"authorAssociation":"NONE","body":"Please see https://github.com/ajv-validator/ajv/issues/1413#issuecomment-867064234","createdAt":"2025-09-19T12:46:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2557#issuecomment-3312068278","viewerDidAuthor":false}],"createdAt":"2025-06-13T09:27:45Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2557,"title":"Memory leak introduced by recent update"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n`8.17.1`\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\nconst ajv = new Ajv()\n```\n\n**JSON Schema**\n\n```json\n{\n    \"$id\": \"http://example.com/example.json\",\n    \"type\": \"object\",\n    \"definitions\": {},\n    \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n    \"properties\": {\n        \"exampleProperty\": {\n            \"$id\": \"/properties/exampleProperty\",\n            \"type\": \"string\",\n            \"title\": \"An example property\",\n            \"default\": \"This is an example property\",\n        },\n    },\n}\n```\n\n**Your code**\n\n```javascript\najv.addSchema(someSchema, 'exampleSchema')\n```\n\n**Caching**\n\nOutput from logging `ajv` internal cache keys (stored in `ajv._cache`):\n```\n{\"$schema\":\"http://json-schema.org/draft-07/schema#\",\"$id\":\"http://json-schema.org/draft-07/schema#\",\"title\":\"Core schema meta-schema\",\"definitions\":{\"schemaArray\":{\"type\":\"array\",\"minItems\":1,\"items\":{\"$ref\":\"#\"}},\"nonNegativeInteger\": {\"type\":\"integer\",\"minimum\":0},\"nonNegativeIntegerDefault0\":{\"allOf\":[{\"$ref\":\"#/definitions/nonNegativeInteger\"},{\"default\":0}]},\"simpleTypes\":{\"enum\":[\"array\",\"boolean\",\"integer\",\"null\",\"number\",\"object\",\"string\"]},\"stringArray\":{\"type\":\"array\",\"items\":{\"type\":\"string\"},\"uniqueItems\":true,\"default\":[]}},\"type\":[\"object\",\"boolean\"],\"properties\":{\"$id\":{\"type\":\"string\",\"format\":\"uri-reference\"},\"$schema\":{\"type\":\"string\",\"format\":\"uri\"},\"$ref\":{\"type\":\"string\",\"format\":\"uri-reference\"},\"$comment\":{\"type\":\"string\"},\"title\":{\"type\":\"string\"},\"description\":{\"type\":\"string\"},\"default\":true,\"readOnly\":{\"type\":\"boolean\",\"default\":false},\"examples\":{\"type\":\"array\",\"items\":true},\"multipleOf\":{\"type\":\"number\",\"exclusiveMinimum\":0},\"maximum\":{\"type\":\"number\"},\"exclusiveMaximum\":{\"type\":\"number\"},\"minimum\":{\"type\":\"number\"},\"exclusiveMinimum\":{\"type\":\"number\"},\"maxLength\":{\"$ref\":\"#/definitions/nonNegativeInteger\"},\"minLength\":{\"$ref\":\"#/definitions/nonNegativeIntegerDefault0\"},\"pattern\":{\"type\":\"string\",\"format\":\"regex\"},\"additionalItems\":{\"$ref\":\"#\"},\"items\":{\"anyOf\":[{\"$ref\":\"#\"},{\"$ref\":\"#/definitions/schemaArray\"}],\"default\":true},\"maxItems\":{\"$ref\":\"#/definitions/nonNegativeInteger\"},\"minItems\":{\"$ref\":\"#/definitions/nonNegativeIntegerDefault0\"},\"uniqueItems\":{\"type\":\"boolean\",\"default\":false},\"contains\":{\"$ref\":\"#\"},\"maxProperties\":{\"$ref\":\"#/definitions/nonNegativeInteger\"},\"minProperties\":{\"$ref\":\"#/definitions/nonNegativeIntegerDefault0\"},\"required\":{\"$ref\":\"#/definitions/stringArray\"},\"additionalProperties\":{\"$ref\":\"#\"},\"definitions\":{\"type\":\"object\",\"additionalProperties\":{\"$ref\":\"#\"},\"default\":{}},\"properties\":{\"type\":\"object\",\"additionalProperties\":{\"$ref\":\"#\"},\"default\":{}},\"patternProperties\":{\"type\":\"object\",\"additionalProperties\":{\"$ref\":\"#\"},\"propertyNames\":{\"format\":\"regex\"},\"default\":{}},\"dependencies\":{\"type\":\"object\",\"additionalProperties\":{\"anyOf\":[{\"$ref\":\"#\"},{\"$ref\":\"#/definitions/stringArray\"}]}},\"propertyNames\":{\"$ref\":\"#\"},\"const\":true,\"enum\":{\"type\":\"array\",\"items\":true,\"minItems\":1,\"uniqueItems\":true},\"type\":{\"anyOf\":[{\"$ref\":\"#/definitions/simpleTypes\"},{\"type\":\"array\",\"items\":{\"$ref\":\"#/definitions/simpleTypes\"},\"minItems\":1,\"uniqueItems\":true}]},\"format\":{\"type\":\"string\"},\"contentMediaType\":{\"type\":\"string\"},\"contentEncoding\":{\"type\":\"string\"},\"if\":{\"$ref\":\"#\"},\"then\":{\"$ref\":\"#\"},\"else\":{\"$ref\":\"#\"},\"allOf\":{\"$ref\":\"#/definitions/schemaArray\"},\"anyOf\":{\"$ref\":\"#/definitions/schemaArray\"},\"oneOf\":{\"$ref\":\"#/definitions/schemaArray\"},\"not\":{\"$ref\":\"#\"}},\"default\":true}\n{\"$id\":\"http://example.com/example.json\",\"type\":\"object\",\"properties\":{\"exampleProperty\":{\"$id\":\"/properties/exampleProperty\",\"type\":\"string\",\"title\":\"An example property\",\"default\":\"This is an example property\"}}}\n```\n\nOutput from `console.log(ajv.schemas)`:\n```\n{\n  'http://json-schema.org/draft-07/schema': <ref *1> SchemaEnv {\n    refs: {\n      'http://json-schema.org/draft-07/schema#/definitions/nonNegativeInteger': [Object],\n      'http://json-schema.org/draft-07/schema#/definitions/nonNegativeIntegerDefault0': [SchemaEnv],\n      'http://json-schema.org/draft-07/schema#/definitions/schemaArray': [SchemaEnv],\n      'http://json-schema.org/draft-07/schema#/definitions/stringArray': [Object],\n      'http://json-schema.org/draft-07/schema#/definitions/simpleTypes': [Object]\n    },\n    dynamicAnchors: {},\n    schema: {\n      '$schema': 'http://json-schema.org/draft-07/schema#',\n      '$id': 'http://json-schema.org/draft-07/schema#',\n      title: 'Core schema meta-schema',\n      definitions: [Object],\n      type: [Array],\n      properties: [Object],\n      default: true\n    },\n    schemaId: '$id',\n    root: [Circular *1],\n    baseId: 'http://json-schema.org/draft-07/schema',\n    schemaPath: undefined,\n    localRefs: {},\n    meta: true,\n    '$async': undefined,\n    validateName: ValueScopeName {\n      str: 'validate0',\n      prefix: 'validate',\n      value: [Object],\n      scopePath: [_Code]\n    },\n    validate: [Function: validate0] {\n      errors: null,\n      schema: [Object],\n      schemaEnv: [Circular *1]\n    }\n  },\n  exampleSchema: <ref *2> SchemaEnv {\n    refs: {},\n    dynamicAnchors: {},\n    schema: {\n      '$id': 'http://example.com/example.json',\n      type: 'object',\n      properties: [Object]\n    },\n    schemaId: '$id',\n    root: [Circular *2],\n    baseId: 'http://example.com/example.json',\n    schemaPath: undefined,\n    localRefs: {},\n    meta: undefined,\n    '$async': undefined\n  }\n}\n\n```\n\n**What results did you expect?**\nI would expect the `SchemaEnv` object to only be cached in one place, when adding a schema through `addSchema` function the schema is cached twice:\n- Within `this._cache` in `_addSchema` call [here](https://github.com/ajv-validator/ajv/blob/9050ba1359fb87cd7c143f3c79513ea7624ea443/lib/core.ts#L719).\n- Within `this.schemas` in `addSchema` call [here](https://github.com/ajv-validator/ajv/blob/9050ba1359fb87cd7c143f3c79513ea7624ea443/lib/core.ts#L490).\n\nFor extremely large schemas the entry in `this._cache` is particularly memory intensive since it stores the `SchemaEnv` object using the entire schema as a key. It would be preferable to be able to use `addSchema` to cache the `SchemaEnv` object **only once** using the key provided in the `addSchema` call to optimise the memory used by caching.\n\n**Are you going to resolve the issue?**\nYes\n","comments":[],"createdAt":"2025-05-21T12:00:22Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2554,"title":"SchemaEnv cached twice when using `addSchema`"},{"body":"\n\n**What version of Ajv you are you using?**\n\nLatest\n\n**What problem do you want to solve?**\n\nI want to addSchema on the fly when a ProtoDeclare property key and associated property object value is found, which is like an extension to allow for property keys with associated validateable object to be validated later on in the document.\n\nNote that ProtoDeclare object should be processed to determine correct schema to build.\n\n**What do you think is the correct solution to problem?**\n\nAdd a hook to allow additional schema to be added when a property key is found, which affects keyed objects later in the document.\n\n**Will you be able to implement it?**\n\nNot soon\n\n\nThe alternative is to convert to DOM (something serverside).","comments":[],"createdAt":"2025-05-11T18:56:02Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2553,"title":"Add schema in the middle of validation"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for change proposals.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv you are you using?**\n\n8.17.1 (JSON Type Definition)\n\n**What problem do you want to solve?**\n\nValidate IXDTF timestamps which include time zone, per RFC9557.\n\n**What do you think is the correct solution to problem?**\n\n[RFC9557](https://datatracker.ietf.org/doc/rfc9557/) extends [RFC3339](https://datatracker.ietf.org/doc/rfc3339/) with optional time zone information; it would be useful for `ajv` to be able to parse IXDTF timestamps which include a suffixed time zone.\n\n**Will you be able to implement it?**\n\nNo\n\n**Further information**\n\n    npm install ajv\n    npm install ajv-cli\n\n    echo '{ \"properties\": { \"ts\": { \"type\": \"timestamp\" } } }'  > schema.json\n    echo '{ \"ts\": \"2025-07-01T12:34:00+01:00\" }'                > ts1.json\n    echo '{ \"ts\": \"2025-07-01T12:34:00+01:00[Europe/London]\" }' > ts2.json\n\n    ajv --spec=jtd -s schema.json -d ts1.json -d ts2.json\n\n... results in\n\n    ts1.json valid\n    ts2.json invalid\n    [\n      {\n        instancePath: '/ts',\n        schemaPath: '/properties/ts/type',\n        keyword: 'type',\n        params: { type: 'timestamp', nullable: false },\n        message: 'must be timestamp'\n      }\n    ]","comments":[],"createdAt":"2025-05-04T15:48:48Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2551,"title":"JTD: Support RFC9557 timestamp with time zone (IXDTF, extends RFC3339)"},{"body":"An issue occurs in bundling ESLint for WebExtension use.\n\nIt appears that ESLint is depending [Ajv](https://github.com/eslint/eslint/blob/910bd13c4cb49001f2a9f172229360771b857585/package.json#L120) to [validate ESLint configurations](https://github.com/eslint/eslint/blob/910bd13c4cb49001f2a9f172229360771b857585/lib/config/rule-validator.js#L158) by matching them to a JSON schema. Ajv [uses Function()](https://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/compile/index.ts#L171) to compile JSON schemas into JavaScript functions.\n\nThe `new Function()` is blocked by the browser CSP which results in a `throw`.\n\nAn alternative method (for the WebExtension context) would be greatly beneficial.\n\nSee also: [Errors with eslint-linter-browserify](https://github.com/UziTech/eslint-linter-browserify/issues/519)\n\n","comments":[],"createdAt":"2025-04-18T18:06:16Z","labels":[],"number":2547,"title":"makeValidate is blocked in WebExtension context"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n```\n    \"ajv\": \"^8.17.1\",\n    \"ajv-formats\": \"^3.0.1\",\n```\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\n{ keywords: ['example'], removeAdditional: \"all\", allErrors: true }\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n  allOf: [\n    {\n      type: \"object\",\n      properties: {\n        test1: {\n          type: \"string\",\n          description: \"Test 1\",\n        }\n      }\n    },\n    {\n      type: \"object\",\n      properties: {\n        test2: {\n          type: \"number\",\n          description: \"Test 2\",\n        }\n      }\n    }\n  ]\n}\n```\n\n**Sample data**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n  test1: \"test\",\n  test2: 123,\n}\n```\n\n**Your code**\n\n<!--\nPlease:\n- make it as small as possible to reproduce the issue\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\n- use `options`, `schema` and `data` as variables, do not repeat their values here\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\n\nIt would make understanding your problem easier and the issue more useful to others.\nThank you!\n-->\n\n```javascript\nimport Ajv from \"ajv\";\nimport AjvAddFormats from \"ajv-formats\";\n\nexport const ajv = new Ajv({ keywords: ['example'], removeAdditional: \"all\", allErrors: true });\nAjvAddFormats(ajv);\n\nconst validate = ajv.compile(/*sample schema*/);\n\nconst data = /*sample data*/;\n\nconsole.log(\"Before:\", data);\n\nvalidate(data);\n\nconsole.log(\"After:\", data);\nconsole.log(\"Errors:\", validate.errors);\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```\nBefore: {\n  test1: \"test\",\n  test2: 123,\n}\nAfter: {}\nErrors: null\n```\n\n**What results did you expect?**\nI expected that the sample data would not be modified because it fits the schema.\n\n**Are you going to resolve the issue?**\nMost likely not.","comments":[],"createdAt":"2025-04-14T21:44:48Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2546,"title":"Unexpected behavior when using `removeAdditional`"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\nLatest version (8.17.1)\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\nconst ajvOptions = {\n    unicodeRegExp: false,\n    allErrors: true,\n    strict: 'log',\n    allowUnionTypes: true\n}\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n  \"$id\": \"https://example.com/schema/1.0\",\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"id\": {\n      \"description\": \"unique ID of this event\",\n      \"properties\": {}\n    },\n    \"ref\": {\n      \"$ref\": \"#/definitions/ref\"\n    },\n    \"anotherRef\": {\n      \"$ref\": \"#/definitions/anotherRef\"\n    }\n  },\n  \"required\": [\n    \"id\"\n  ],\n  \"definitions\": {\n    \"anotherRef\": {\n      \"allOf\": [\n        {\n          \"type\": \"string\"\n        },\n        {\n          \"properties\": {}\n        }\n      ]\n    },\n    \"ref\": {\n      \"allOf\": [\n        {\n          \"$ref\": \"#/definitions/anotherRef\"\n        },\n        {\n          \"properties\": {}\n        }\n      ]\n    }\n  }\n}\n```\n\n**Error messages of strict valdation**\n\n```\nstrict mode: missing type \"object\" for keyword \"properties\" at \"https://example.com/schema/1.0#/properties/id\" (strictTypes)\n\nstrict mode: missing type \"object\" for keyword \"properties\" at \"https://example.com/schema/1.0#/definitions/anotherRef/allOf/1\" (strictTypes)\n\nstrict mode: missing type \"object\" for keyword \"properties\" at \"https://example.com/schema/1.0#/allOf/1\" (strictTypes)\n```\n\n**What results did you expect?**\nLast error message does not contain the whole path, so the user does not know where to look for the mentioned error. Especially with a big schema it can be a problem.\n\nMessage should contain whole path and look like:\n```\nstrict mode: missing type \"object\" for keyword \"properties\" at \"https://example.com/schema/1.0#/definitions/ref/allOf/1\" (strictTypes)\n```","comments":[],"createdAt":"2025-04-10T13:24:04Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2545,"title":"Error message from strict schema validation does not contain whole path"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\n\nThis template is for issues about missing or incorrect type definition and other typescript-related issues.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\nRelated #2209\n\ncc @jasoniangreen\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\n**Your typescript code**\n\n<!--\nPlease make it as small as possible to reproduce the issue\n-->\n\n```typescript\n\n```\n\n**Typescript compiler error messages**\n\n```\n\n```\n\n**Describe the change that should be made to address the issue?**\n\n**Are you going to resolve the issue?**\n","comments":[],"createdAt":"2025-04-03T04:32:30Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2544,"title":"The package is commonjs, its type definition for ESM package is wrong"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for installation and dependency issues.\nFor other issues please see https://ajv.js.org/contributing/\n\nBefore submitting the issue, please try the following:\n- use the latest stable Node.js and npm\n- use yarn instead of npm - the issue can be related to https://github.com/npm/npm/issues/19877\n- remove node_modules and package-lock.json and run install again\n-->\n\ncc @jasoniangreen\n\n**The version of Ajv you are using**\n\n**Operating system and node.js version**\n\n**Package manager and its version**\n\n**Link to (or contents of) package.json**\n\n**Error messages**\n\n**The output of `npm ls`**\n","comments":[],"createdAt":"2025-04-03T04:30:02Z","labels":[{"id":"MDU6TGFiZWwxMTc5MDg1NDk1","name":"installation","description":"","color":"4121BE"}],"number":2543,"title":"Why `lib` source is included in npm package?"},{"body":"Hi everyone,\n\nAfter upgrading Ajv from 6.12.13 Ajv 8.17.1, our system started to crash on validation. We were able to narrow down and isolate the issue, and it looks like Ajv8 is using a lot more CPU/memory than Ajv6 in this specific use case. We wish to have your opinion on it (it could also indicate a leak).\n\n\n# Here are the reproduction steps:\n\n- We started a virtual machine with \"low\" memory and cpu (16Gb, 2cpus, running Fedora)\n- We have a large schema (see `schema.json`) [schema.json](https://github.com/user-attachments/files/19564063/schema.json)\n- We attached a piece of data to be validated (see `data.json`) [data.json](https://github.com/user-attachments/files/19564313/data.json)\n\n- We ran a simple script, that just registers the schema and performs 40.000 validations with the validation function (close to our use case):\n```\nconst ajvInstance = new Ajv({strict: false})\najvInstance.addSchema(schema, 'some-key')\nconst validate = ajvInstance.getSchema('some-key')\nfor (let i = 0; i < 40_000; i++) {\n    validate(data)\n}\n```\n\n# Results:\n\n- When using Ajv6 it takes about 1 second\n- When using Ajv8 it takes about 5 seconds\n- When looking at the CPU and memory usage, we also see a large extra usage of the CPU (which seems to be causing the crash in production)\n- We also noticed it does not matter if the data we pass is valid or not (the sample attached is valid)\n\nWe are working on reducing our schemas, but still we think your opinion on this could be interesting, and it may indicate an issue.\n\nThank you in advance!","comments":[],"createdAt":"2025-04-02T08:13:28Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2542,"title":"Large extra-CPU usage and extra delay when validating, after upgrading from Ajv6 to Ajv8"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\nlatest (8.17.1)\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\n{ removeAdditional: \"all\" }\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n```json\n{\n  \"type\": \"object\",\n  \"minProperties\": 1,\n  \"properties\": {\n    \"foo\": {\n      \"type\": \"string\"\n    },\n    \"bar\": {\n      \"type\": \"string\"\n    }\n  }\n}\n```\n\n**Sample data**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```javascript\nconst shouldError1 = {};\nconst shouldError2 = { foobar: \"baz\" };\nconst shouldPass = { foo: \"bar\" };\n```\n\n**Your code**\n**Validation result, data AFTER validation, error messages**\n\n<!--\nPlease:\n- make it as small as possible to reproduce the issue\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\n- use `options`, `schema` and `data` as variables, do not repeat their values here\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\n\nIt would make understanding your problem easier and the issue more useful to others.\nThank you!\n-->\n\n```javascript\nconst validate = new Ajv(options).compile(schema);\n\nconst shouldError1 = {};\nconsole.log(validate(shouldError1), shouldError1); // valid = false, data = {}\n\nconst shouldError2 = { foobar: \"baz\" };\nconsole.log(validate(shouldError2), shouldError2); // valid = true, data = {}\n\nconst shouldPass = { foo: \"bar\" };\nconsole.log(validate(shouldPass), shouldPass); // valid = true, data = { foo: \"bar\" }\n```\n\n**What results did you expect?**\n\nThe object with only additional properties is expected to have error for not satisfy the `minProperties` constraint after additional properties has been removed.\n\n**Are you going to resolve the issue?**\n\nCurrently not yet.","comments":[],"createdAt":"2025-03-17T06:12:20Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2541,"title":"`minProperties` and `removeAdditional` does not collaborate well"},{"body":"# Quick description of the issue\n\nIn\nhttps://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/vocabularies/format/format.ts#L82-L87\n`strictSchema === false` logs an error, whereas `strictSchema === \"log\"` throws\n\nBased on the docs in\nhttps://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/docs/options.md?plain=1#L96-L104\n\nI would expect `strictSchema === \"log\"` to log and `strictSchema === true` to throw.\n\n# Issue template\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\n\n8.17.1\nYes\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\n{ strictSchema: \"log\" }\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$id\": \"https://json.schemastore.org/ruff.json\",\n  \"title\": \"Options\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"Flake8CopyrightOptions\": {\n      \"description\": \"Options for the `flake8-copyright` plugin.\",\n      \"type\": \"object\",\n      \"properties\": {\n        \"min-file-size\": {\n          \"description\": \"A minimum file size (in bytes) required for a copyright notice to be enforced. By default, all files are validated.\",\n          \"type\": [\n            \"integer\",\n            \"null\"\n          ],\n          \"format\": \"uint\",\n          \"minimum\": 0\n        }\n      }\n    }\n  }\n}\n```\n\n**Sample data**\n\nirrelevant\n\n**Your code**\n\n```javascript\nimport Ajv from \"ajv\";\n\nconst ajv = new Ajv({ allErrors: true, strictSchema: \"log\" });\n\nconst schema = {\n  $schema: \"http://json-schema.org/draft-07/schema#\",\n  $id: \"https://json.schemastore.org/ruff.json\",\n  title: \"Options\",\n  type: \"object\",\n  properties: {\n    Flake8CopyrightOptions: {\n      description: \"Options for the `flake8-copyright` plugin.\",\n      type: \"object\",\n      properties: {\n        \"min-file-size\": {\n          description:\n            \"A minimum file size (in bytes) required for a copyright notice to be enforced. By default, all files are validated.\",\n          type: [\"integer\", \"null\"],\n          format: \"uint\",\n          minimum: 0,\n        },\n      },\n    },\n  },\n};\n\nconst validate = ajv.compile(schema);\n\nconst data = {\n  foo: 1,\n  bar: \"abc\",\n}; // this doesn't matter\n\nvalidate(data);\nconsole.log(validate.errors);\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```\n                throw new Error(unknownMsg());\n                      ^\nError: unknown format \"uint\" ignored in schema at path \"#/properties/Flake8CopyrightOptions/properties/min-file-size\"\n```\n\n**What results did you expect?**\n\nWith `{ strictSchema: \"log\" }`, I would expect this error to be logged (like it is when `strictSchema` is `false`), not thrown as an exception.\n\n**Are you going to resolve the issue?**\n\nI have not contributed before, but I would be happy to try and submit a PR if you agree this is a bug.\n","comments":[{"id":"IC_kwDOAiQBJM6il0GD","author":{"login":"mpal15"},"authorAssociation":"NONE","body":"Hi, can you assign to me .i want to try to solve this problem ","createdAt":"2025-03-17T01:43:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2538#issuecomment-2727821699","viewerDidAuthor":false}],"createdAt":"2025-03-07T20:35:38Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2538,"title":"`strictSchema: \"log\"` throws on some schema compile errors"},{"body":"**What version of Ajv you are you using?**\n8.11\n\n**What problem do you want to solve?**\nWhen using AJV in the context of an OpenAPI based web server, you have a complete schema system you would like to manage in as single AJV instance since a query parameter may have a schema in common with a JSON request body.\n\nThat said, you probably don't want to coerce types of JSON payloads (request body / response body) but you want to do so for parameters that comes in as strings only (related https://github.com/ajv-validator/ajv/issues/1031).\n\nCurrently, I had to workaround by coercing values myself which is probably not a good approach (see https://github.com/nfroidure/whook/blob/main/packages/whook/src/libs/validation.ts#L403-L460).\n\nI could have 2 different Ajv instances : one for payload and another for parameter but it would increase memory footprint and API startup time. Also, building the project taking advantage of AJV compilation (https://github.com/nfroidure/whook/issues/118) would necessit to have 2 separated builds and increase the bundle size.\n\n**What do you think is the correct solution to problem?**\n\nAllow to pass an option to validators to enable/disable coercion would solve the problem.\n\n**Will you be able to implement it?**\n\nI'm not sur I have sufficient AJV code base knowledge to do so, but if you think that it can take a few day with some directions, I could give it a try.\n","comments":[],"createdAt":"2025-02-26T10:38:12Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2536,"title":"Coerce types at the validator level"},{"body":"=> Failed to build the preview\nError: Cannot find module 'ajv/dist/compile/codegen'\nRequire stack:\n- .\\node_modules\\ajv-keywords\\dist\\definitions\\typeof.js\n- .\\node_modules\\ajv-keywords\\dist\\keywords\\typeof.js\n- .\\node_modules\\ajv-keywords\\dist\\keywords\\index.js\n- .\\node_modules\\ajv-keywords\\dist\\index.js\n- .\\node_modules\\schema-utils\\dist\\validate.js\n- .\\node_modules\\schema-utils\\dist\\index.js\n- .\\node_modules\\@storybook\\builder-webpack5\\node_modules\\webpack-dev-middleware\\dist\\index.js\n- .\\node_modules\\@storybook\\builder-webpack5\\dist\\index.js\n- .\\node_modules\\@storybook\\react-webpack5\\dist\\preset.js\n- .\\node_modules\\@storybook\\react-webpack5\\preset.js\n- .\\node_modules\\@storybook\\core\\dist\\common\\index.cjs\n- .\\node_modules\\storybook\\dist\\proxy.cjs\n- .\\node_modules\\storybook\\bin\\index.cjs\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1140:15)\n    at Module._resolveFilename (.\\node_modules\\esbuild-register\\dist\\node.js:4794:36)\n    at Module._load (node:internal/modules/cjs/loader:981:27)\n    at Module.require (node:internal/modules/cjs/loader:1231:19)\n    at require (node:internal/modules/helpers:177:18)\n    at Object.<anonymous> (.\\node_modules\\ajv-keywords\\src\\definitions\\typeof.ts:2:1)\n    at Module._compile (node:internal/modules/cjs/loader:1364:14)\n    at Module._extensions..js (node:internal/modules/cjs/loader:1422:10)\n    at Object.newLoader (.\\node_modules\\esbuild-register\\dist\\node.js:2262:9)\n    at extensions..js (.\\node_modules\\esbuild-register\\dist\\node.js:4833:24)\n\nWARN Broken build, fix the error above.\nWARN You may need to refresh the browser.","comments":[],"createdAt":"2025-02-19T07:28:16Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2535,"title":"Cannot find module 'ajv/dist/compile/codegen'"},{"body":"I am using latest version of AJV in an Angular 18 project. I have a single file that imports the AJV libary, sets up its options and uses it to validate my app's JSON. I can provide more implementation details if needed.\n\nAnyway, I'm not specifically referencing any ajv/dist/runtime modules but when I build my project, I'm seeing 4 different ones referenced as what appear to be dynamic includes in the vendor.js file.\n\nThis is preventing my exported web component from running in Salesforce.com as a LWC due to the apparent use of dynamic imports:\n\nHere are the references from vendor.js:\n\n`code: e._'require(\"ajv/dist/runtime/validation_error\").default' }));`\n`e.code = 'require(\"ajv/dist/runtime/equal\").default',`\n`s.code = 'require(\"ajv/dist/runtime/ucs2length\").default'`\n`e.code = 'require(\"ajv/dist/runtime/uri\").default',`\n\nIs there a flag I can pass in the options to prevent this or perhaps another workaround?","comments":[],"createdAt":"2025-01-29T17:38:56Z","labels":[{"id":"MDU6TGFiZWwxMTc5MDg1NDk1","name":"installation","description":"","color":"4121BE"}],"number":2531,"title":"Apparent dynamic imports from ajv/dist/runtime in vendor.js build from Angular 18 using latest 8.17.1"},{"body":"<!--\nFrequently Asked Questions: https://ajv.js.org/faq.html\nPlease provide all info and reduce your schema and data to the smallest possible size.\n\nThis template is for bug or error reports.\nFor other issues please see https://ajv.js.org/contributing/\n-->\n\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\nI use Ajv Version 8.17.1 and the issue still happens\n\n**Ajv options object**\n\n<!-- See https://ajv.js.org/options.html -->\n\n```javascript\nconst ajv = new Ajv({ strict: false });\n```\n\n**JSON Schema**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n{\n\t\"$schema\": \"http://json-schema.org/draft-07/schema#\",\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"select_string_type\": {\n\t\t\t\"type\": \"string\",\n\t\t\t\"oneOf\": [\n\t\t\t\t{\n\t\t\t\t\t\"const\": \"test_1\",\n\t\t\t\t\t\"title\": \"test_1\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"const\": \"test_2\",\n\t\t\t\t\t\"title\": \"test_2\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_3\",\n\t\t\t\t\t\"title\": \"test_3\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_4\",\n\t\t\t\t\t\"title\": \"test_4\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_5\",\n\t\t\t\t\t\"title\": \"test_5\"\n\t\t\t\t},\n                                ...\n                                {\n\t\t\t\t\t\"const\": \"test_294\",\n\t\t\t\t\t\"title\": \"test_294\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_295\",\n\t\t\t\t\t\"title\": \"test_295\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_296\",\n\t\t\t\t\t\"title\": \"test_296\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_297\",\n\t\t\t\t\t\"title\": \"test_297\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_298\",\n\t\t\t\t\t\"title\": \"test_298\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_299\",\n\t\t\t\t\t\"title\": \"test_299\"\n\t\t\t\t},{\n\t\t\t\t\t\"const\": \"test_300\",\n\t\t\t\t\t\"title\": \"test_300\"\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"title\": \"__(SELECT_STRING)\",\n\t\t\t\"x-jsf-presentation\": {\n\t\t\t\t\"inputType\": \"select\"\n\t\t\t}\n\t\t},\n\t\t\"select_number_type\": {\n\t\t\t\"type\": \"number\",\n\t\t\t\"oneOf\": [\n\t\t\t\t{\n\t\t\t\t\t\"const\": 0,\n\t\t\t\t\t\"title\": \"one\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"const\": 1,\n\t\t\t\t\t\"title\": \"two\"\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"title\": \"__(SELECT_NUMBER)\",\n\t\t\t\"x-jsf-presentation\": {\n\t\t\t\t\"inputType\": \"select\"\n\t\t\t}\n\t\t},\n\t\t\"string_type\": {\n\t\t\t\"type\": \"string\",\n\t\t\t\"title\": \"__(STRING)\",\n\t\t\t\"maxLength\": 64,\n\t\t\t\"x-jsf-presentation\": {\n\t\t\t\t\"inputType\": \"text\"\n\t\t\t}\n\t\t}\n\t},\n\t\"allOf\": [\n\t\t{\n\t\t\t\"if\": {\n\t\t\t\t\"properties\": {\n\t\t\t\t\t\"select_number_type\": {\n\t\t\t\t\t\t\"const\": 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"then\": {\n\t\t\t\t\"properties\": {\n\t\t\t\t\t\"string_type\": {\n\t\t\t\t\t\t\"minLength\": 1,\n\t\t\t\t\t\t\"maxLength\": 64\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"required\": [\n\t\t\t\t\t\"string_type\"\n\t\t\t\t]\n\t\t\t},\n\t\t\t\"else\": {\n\t\t\t\t\"properties\": {\n\t\t\t\t\t\"string_type\": {\n\t\t\t\t\t\t\"x-jsf-presentation\": {\n\t\t\t\t\t\t\t\"inputType\": \"hidden\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t],\n\t\"required\": [\n\t\t\"select_string_type\",\n\t\t\"select_number_type\"\n\t]\n}\n```\n\n**Sample data**\n\n<!-- Please make it as small as possible to reproduce the issue -->\n\n```json\n {\n    \"select_string_type\": \"test_1\",\n    \"select_number_type\": 0,\n    \"string_type\": \"string example\"\n  }\n\n```\n\n**Your code**\n\n<!--\nPlease:\n- make it as small as possible to reproduce the issue\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\n- use `options`, `schema` and `data` as variables, do not repeat their values here\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\n\nIt would make understanding your problem easier and the issue more useful to others.\nThank you!\n-->\n\n```javascript\n<script setup>\nimport { ref } from \"vue\";\nimport Ajv from \"ajv\";\nimport schema from \"./../assets/schema/schema.json?raw\";\n\nconst elements_select_string = ref([\n  \"test_1\",\n  \"test_2\",\n  \"test_3\",\n  \"test_4\",\n  ...\n  \"test_297\",\n  \"test_298\",\n  \"test_299\",\n  \"test_300\",\n]);\n\nconst selectStringElement = ref(\"\");\nconst selectNumberElement = ref(0);\nconst stringElement = ref(\"string example\");\n\nasync function createJSON() {\n  let config = {\n    jsonFile: {\n      version: \"0.1.0\",\n      form: {\n        select_string_type: selectStringElement.value,\n        select_number_type: selectNumberElement.value,\n        string_type: stringElement.value,\n      },\n    },\n  };\n\n  await validateJSON(config);\n}\n\nasync function validateJSON(config) {\n  const ajv = new Ajv({ strict: false });\n\n  try {\n    const validate = ajv.compile(JSON.parse(schema));\n    const valid = validate(config.jsonFile.form);\n\n    if (valid) {\n      console.log(\"JSON valid\");\n    } else {\n      console.log(\"JSON invalid\", validate.errors);\n    }\n  } catch (error) {\n    console.error(\"Error:\", error);\n  }\n}\n</script>\n\n<template>\n  <div>\n    <h1>Example</h1>\n    <form>\n      <label for=\"select_string_type\">Choose Select String Type:</label>\n      <select v-model=\"selectStringElement\" id=\"select_string_type\">\n        <option\n          v-for=\"select in elements_select_string\"\n          :key=\"select\"\n          :value=\"select\"\n        >\n          {{ select }}\n        </option>\n      </select>\n      <br />\n\n      <label for=\"select_number_type\">Choose Select Number Type:</label>\n      <select v-model=\"selectNumberElement\" id=\"select_number_type\">\n        <option value=\"0\">one</option>\n        <option value=\"1\">two</option>\n      </select>\n      <br />\n\n      <label for=\"string_type\">String Type: </label>\n      <input\n        v-model=\"stringElement\"\n        id=\"string_type\"\n        name=\"string_type\"\n        type=\"text\"\n      />\n      <br />\n\n      <input\n        type=\"button\"\n        name=\"submit_form\"\n        id=\"submit_form\"\n        value=\"Submit Form\"\n        @click=\"createJSON\"\n      />\n    </form>\n  </div>\n</template>\n\n```\n\n**Validation result, data AFTER validation, error messages**\n\n```\nError: InternalError: function nested too deeply\n    validateJSON HelloWorld.vue:333\n    createJSON HelloWorld.vue:325\n    callWithErrorHandling runtime-core.esm-bundler.js:199\n    callWithAsyncErrorHandling runtime-core.esm-bundler.js:206\n    invoker runtime-dom.esm-bundler.js:729\n    addEventListener runtime-dom.esm-bundler.js:680\n    patchEvent runtime-dom.esm-bundler.js:698\n    patchProp runtime-dom.esm-bundler.js:775\n    mountElement runtime-core.esm-bundler.js:4873\n    processElement runtime-core.esm-bundler.js:4820\n    patch runtime-core.esm-bundler.js:4688\n    mountChildren runtime-core.esm-bundler.js:4932\n    mountElement runtime-core.esm-bundler.js:4855\n    processElement runtime-core.esm-bundler.js:4820\n    patch runtime-core.esm-bundler.js:4688\n    mountChildren runtime-core.esm-bundler.js:4932\n    mountElement runtime-core.esm-bundler.js:4855\n    processElement runtime-core.esm-bundler.js:4820\n    patch runtime-core.esm-bundler.js:4688\n    componentUpdateFn runtime-core.esm-bundler.js:5326\n    run reactivity.esm-bundler.js:225\n    setupRenderEffect runtime-core.esm-bundler.js:5454\n    mountComponent runtime-core.esm-bundler.js:5229\n    processComponent runtime-core.esm-bundler.js:5182\n    patch runtime-core.esm-bundler.js:4700\n    componentUpdateFn runtime-core.esm-bundler.js:5326\n    run reactivity.esm-bundler.js:225\n    setupRenderEffect runtime-core.esm-bundler.js:5454\n    mountComponent runtime-core.esm-bundler.js:5229\n    processComponent runtime-core.esm-bundler.js:5182\n    patch runtime-core.esm-bundler.js:4700\n    render2 runtime-core.esm-bundler.js:5979\n    mount runtime-core.esm-bundler.js:3941\n    mount runtime-dom.esm-bundler.js:1767\n    <anonymous> main.js:11\nHelloWorld.vue:341:12\n\n```\n\n**What results did you expect?**\nWhen using Chrome, the validation works without any problems. When using Firefox, this issue occurs without any changes made. I tried different approaches with the parameters, but nothing seems to work. As soon as there are more than 250 options, this error occurs.\n\nThis issue is happening when using AJV in a Vue.js project with Composition API.\n\nI've added the Vue project below. You can unpack it and run ```npm run dev``` in the folder where the entire project is located.\n\n[ajv_error.zip](https://github.com/user-attachments/files/18573986/ajv_error.zip)","comments":[{"id":"IC_kwDOAiQBJM6grfko","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"This is likely related to how AJV builds efficient and fast precomputed validation functions using its codegen module. Making any change to avoid this issue would likely impact performance and given this is an edge case I don't think we'll be open to that. There are different ways to do something similar to this schema without creating const options for every possible value.","createdAt":"2025-03-03T22:57:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2530#issuecomment-2695756072","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6rhKe-","author":{"login":"dholbert"},"authorAssociation":"NONE","body":"Hi folks! I work on Firefox, and we got a report of this same issue affecting a site in the wild:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=1965201\n\nI'm interested to see what it'd take to get Firefox to the same experience that Chrome has here, whether that's via changes to Firefox or the server-side components involved here.  (Based on [another thread](https://jsonforms.discourse.group/t/function-nested-too-deeply-error-when-enum-has-many-options/1451/7), it sounds like Chrome runs into this same issue, but you have to throw more data at them before they'll hit it; I'm curious what the explanation for that delta is.)\n\nIn the interests of looking into that, I'm hoping to find a minimal testcase that reproduces the issue.  I tried the attached `ajv_error.zip` in the hopes that it might serve as such a testcase, but I'm not sure what to do with it -- I unpacked it and ran `npm run dev`, inside of a freshly installed Ubuntu environment (in a VM) where I've installed `npm`, `nodejs`, and `vite`.  But that just seems to launch the `vite` graphical application; no web server gets stood up that I've been able to find, and I'm not sure what to do next.\n\n@mariada-ta could you double-check that the attached zip file is the right one, and (assuming it is) please list whatever additional steps might be necessary (maybe some additional tool/dependency needs to be installed or launched, what local port a web serer might start listening, etc)?  (Sorry if it's something that seems trivial/obvious; I don't work with npm/node super often, and have never touched alone vue/ajv/vite.)\n\nThanks in advance for the help!","createdAt":"2025-05-13T18:45:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2530#issuecomment-2877597630","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6rhMMu","author":{"login":"dholbert"},"authorAssociation":"NONE","body":"(or maybe the code-quotes from comment 0 need to be copypasted into local files inside of the unpacked `ajv_error.zip` file's directory? not sure. In any case: explicit instructions for how to trigger the issue in Firefox would be great, and maybe that'll help us identify the right team/individuals to look at this on the Firefox side. thanks!)","createdAt":"2025-05-13T18:48:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2530#issuecomment-2877604654","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6rhTl-","author":{"login":"dholbert"},"authorAssociation":"NONE","body":"Ah, never mind - I managed to reproduce the issue with the linked zip testcase after all.\n\nNot sure what happened, but after I deleted `node_modules` and ran `npm install`, then I was able to `npm run dev` and reach a screen that showed a web server running on port 5173.  At that point I'm able to trigger the issue by visiting `localhost:5173` and checking my web console.","createdAt":"2025-05-13T18:59:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2530#issuecomment-2877634942","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6rhe2H","author":{"login":"jrmuizel"},"authorAssociation":"NONE","body":"I've filed https://bugzilla.mozilla.org/show_bug.cgi?id=1966196 about changing Firefox's behaviour","createdAt":"2025-05-13T19:18:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2530#issuecomment-2877681031","viewerDidAuthor":false}],"createdAt":"2025-01-28T13:21:36Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2530,"title":"Firefox: Select with over 250 options - InternalError: function nested too deeply"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nlatest: 8.17.1\r\n\r\n**Your typescript code**\r\n```typescript\r\n//defining the options config\r\nconst ajv = new Ajv({\r\n  ...\r\n  $comment:         false,\r\n  ...\r\n});\r\n```\r\n\r\n**Typescript compiler error messages**\r\n```\r\nType 'false' is not assignable to type 'true | ((comment: string, schemaPath?: string | undefined, rootSchema?: AnySchemaObject | undefined) => unknown) | undefined'\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\nNot sure what is the source of truth here or the expected behavior.\r\nThe documention for the [$comment](https://ajv.js.org/options.html#comment) states\r\n```\r\nOption values:\r\n\r\n    false (default): ignore $comment keyword.\r\n    true: log the keyword value to console.\r\n    function: pass the keyword value, its schema path and root schema to the specified function\r\n```\r\nBut the type does not contain 'false' as an  option. \r\n\r\n**Are you going to resolve the issue?**\r\nNot sure. If the documentation is correct, then update the type. If documentation is incorrect, update documentation. \r\n","comments":[],"createdAt":"2025-01-13T16:34:25Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2529,"title":"config option for `$comment` is showing incorrect type differs from documentation"},{"body":"### What version of Ajv are you using?  \r\n8.17.1\r\n\r\n### What problem do you want to solve?  \r\n\r\nCurrently, using AJV on sites with Content Security Policy (CSP) rules that disallow `unsafe-eval` is not feasible due to its reliance on `new Function`. This limitation is documented here: https://ajv.js.org/security.html#content-security-policy  \r\n\r\nAnd the suggested approach around this limitation is a two-step process:  \r\n1. Generate the `sourceCode` for the schema validation.  \r\n2. Serve the `sourceCode` as a standard `.js` file, which can then be included alongside other JavaScript assets on the site.  \r\n\r\nHowever, unfortunately, **purely doing the first stepâ€”JUST generating the `sourceCode`â€”is currently impossible too**. Because `compileSchema()` generates the `sourceCode` but immediately attempts to create the `validate` function using `new Function()`, which violates CSP rules:  \r\n\r\nhttps://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/compile/index.ts#L167-L172  \r\n\r\nWhile in this two-step process, **the `validate` function isn't needed at all**, during the first step. (Additionally, this is an extra work).\r\n\r\nAnd the problem is in our case, we do the job in a service-worker which is subject to CSP regulations itself and so it can't execute `eval()` (or `new Function()`).\r\n\r\n### What do you think is the correct solution to the problem?  \r\n\r\nIntroduce a dedicated, pure function that generates only the `sourceCode`. This function should work independently of `compileSchema` and should not attempt to create a `validate` function. Such a function would be compatible with CSP-bound environments and could be used by both `compileSchema` and developers needing `sourceCode` generation.\r\n\r\n### Will you be able to implement it?  \r\nProbably yes.","comments":[{"id":"IC_kwDOAiQBJM6aH7UM","author":{"login":"mirismaili"},"authorAssociation":"NONE","body":"Temporary workaround I found:\r\n\r\nMock global `Function` to make `validate` function CSP-safe (and *does nothing* in step 1):\r\n```ts\r\n// Workaround for this issue: https://github.com/ajv-validator/ajv/issues/2527\r\n// @ts-expect-error // TS2322: Type `() => () => () => boolean` is not assignable to type `FunctionConstructor`\r\nglobalThis.Function = function () {\r\n  return function mockMakeValidate() {\r\n    return function mockValidate() {\r\n      return true\r\n    }\r\n  }\r\n}\r\n```","createdAt":"2025-01-12T15:04:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-2585769228","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6piAqK","author":{"login":"iamnexxed"},"authorAssociation":"NONE","body":"Is this enhancement being worked on?\nIf yes, how long might it take to be added?\nIf no, is there a plan to add it in the future?","createdAt":"2025-05-01T07:40:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":5}}],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-2844265098","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6sjiXP","author":{"login":"albanm"},"authorAssociation":"NONE","body":"This would be great ! And another possible step would be to support creating an inline script instead of using new Function. The creation of an inline script could accept a CSP nonce parameter and therefore be compatible with a strict CSP policy.\n\nRight now it seems that the choice is either to compile at build time or to accept a lenient CSP policy.","createdAt":"2025-05-20T15:53:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-2894996943","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM63ch1V","author":{"login":"Dharshan-J"},"authorAssociation":"NONE","body":"I'm encountering the CSP issue with Ajv in a browser-based app due to the 'unsafe-eval' requirement. I need a solution that supports these while being CSP-compliant. I've tried precompiling with `ajv-cli`, but dynamic schema loading is a challenge. Are there plans to support interpretive validation or other CSP-friendly approaches? Any updates on this issue?","createdAt":"2025-07-16T09:18:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-3077709141","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7KJaWW","author":{"login":"keeganwatkins"},"authorAssociation":"NONE","body":"I'm also working on a product that wants to avoid the `\"unsafe-eval\"` CSP directive. Is it possible to get an update on this thread?","createdAt":"2025-10-10T17:40:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-3391464854","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7RX5hp","author":{"login":"mirastroie"},"authorAssociation":"NONE","body":"Any updates on this? \n@jasoniangreen ","createdAt":"2025-11-10T16:31:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2527#issuecomment-3512703081","viewerDidAuthor":false}],"createdAt":"2025-01-12T10:56:52Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2527,"title":"Separate `eval` (`new Function`) from `sourceCode` generation (`CodeGen`)"},{"body":"### Discussed in https://github.com/ajv-validator/ajv/discussions/2497\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **AM1988** October  4, 2024</sup>\r\nHi there.\r\n\r\nI have a class for data validation\r\n`export class SchemaValidator {\r\n    static ajv = new Ajv({ allErrors: true, verbose: true });\r\n\r\n    public static validate<T>(schema: SchemaFile, data: T): boolean {\r\n        const schemaContent = JSON.parse(fs.readFileSync(path.join(__dirname, 'path', schema), 'utf-8'));\r\n        if (!this.ajv.validateSchema(schemaContent)) {\r\n            console.error(`Schema is not valid.`);\r\n        }\r\n        const isValid = this.ajv.validate(schemaContent, data);\r\n\r\n        if (!isValid) {\r\n            const errorMessages = this.ajv.errorsText();\r\n            logger.error(`Validation failed : ${errorMessages}`);\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n}`\r\nI use JSON schema described in a separate file.\r\nHow to get the full output when validation fails so that I can understand which part exactly does not match?\r\n\r\nFor example, values in the enum did not match, or input data had some additional properties, missing properties, etc.\r\n\r\nRight now I see only `data.payload.something should be equal to one of the allowed values`</div>\r\n\r\nIt does not have info about original data that does not pass schema validation.\r\n\r\nIt returns messages like\r\n`data.sources[0].version should match pattern \"^.{555}$\", data.sources[1].version should match pattern \"^.{555}$\", data.sources[2].version should match pattern \"^.{555}$\"` but you have no clue what exactly `data.sources[0].version` is.","comments":[],"createdAt":"2025-01-09T17:00:36Z","labels":[],"number":2526,"title":"Improvement: Display detailed messages when validation fails"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nv8.17.1\r\n\r\nCurrently, I am using \"validate\" function in a user defined keyword, which works fine but which needs to be replaced with \"code\" function as I am moving the schema compilation to build time due to _CSP Exceptions_ in runtime like mentioned here https://ajv.js.org/standalone.html. AJV standalone validation code with user defined keywords supports only \"code\" and \"macros\" functions, and I have few custom keywords in my application. I am a bit struggling in replacing the \"validate\" function as not sure how to read the data and do the comparison like below.\r\n\r\n**Schema:**\r\n```\r\n{\r\n    \"$schema\": \"http://json-schema.org/draft-07/schema\",\r\n    \"$id\": \"src/schemas/test.schema.json\",\r\n    \"type\": \"object\",\r\n    \"properties\": {\r\n        \"validFrom\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"ISO-8601\",\r\n            \"compareDates\": {\r\n                \"$data\": \"1/validTo\"\r\n            },\r\n            \"examples\": [\"2022-10-11T10:27:14Z\", \"2022-10-11T10:27Z\"]\r\n        },\r\n        \"validTo\": {\r\n            \"type\": \"string\",\r\n            \"format\": \"ISO-8601\",\r\n            \"examples\": [\"2022-10-11T10:27:14Z\", \"2022-10-11T10:27Z\"]\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**Current**: working keyword \"compareDates\"\r\n```\r\nconst ajv = new Ajv({\r\n                allErrors: true,\r\n                $data: true,\r\n                schemas: schemas\r\n            });\r\n...\r\najv.addKeyword({\r\n        keyword: 'compareDates',\r\n        type: 'string',\r\n        $data: true,\r\n        validate: (targetDate: Date, sourceDate: Date) => {\r\n            const timeForTargetDate = new Date(targetDate).getTime();\r\n            const timeForSourceDate = new Date(sourceDate).getTime();\r\n            if (timeForSourceDate >= timeForTargetDate) {\r\n                return false;\r\n            }\r\n            return true;\r\n        },\r\n        error: {\r\n            message: 'invalid dates'\r\n        }\r\n    })\r\n```\r\n**Required:**\r\n```\r\nconst ajv = new Ajv({\r\n                allErrors: true,\r\n                $data: true,\r\n                schemas: schemas,\r\n                code: {\r\n                    source: true,\r\n                    formats: require('./formats')\r\n                }\r\n            });\r\n...\r\najv.addKeyword({\r\n        keyword: 'compareDates',\r\n        type: 'boolean',\r\n        schemaType: 'boolean',\r\n        $data: true,\r\n        code(cxt) {\r\n            const { data, $data, schema } = cxt;\r\n            //$data does not have validTo property value(see screenshot)\r\n            const validFrom = data;\r\n            const validTo = $data;\r\n            gen.code(_`console.log(${validFrom})`); // prints '2022-01-01T00:00:01.000Z'\r\n            gen.code(_`console.log(${validTo})`); // prints \"1/validTo\" ???\r\n        },\r\n        errors: false\r\n    });\r\n```\r\ncontext screenshot: \r\n![image](https://github.com/user-attachments/assets/b15a419f-a19f-4fd9-8773-b9e98165b722)\r\n","comments":[],"createdAt":"2025-01-08T22:07:47Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2525,"title":"AJV user defined keyword using \"code\" function"},{"body":"## Context\r\n\r\nI am defining a schema for an interface that has a property of type [`Date`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date). I use the type safety provided by AJV and Typescript by specifying that the type of my schema is `JSONSchemaType<MyInterface>`.\r\n\r\n## Expected behaviour\r\n\r\nI can define the date property in the schema like this\r\n\r\n```json\r\n{\r\n    \"dateProperty\": {\r\n        \"type\": \"string\",\r\n        \"format\": \"date-time\",\r\n    }\r\n}\r\n```\r\n\r\nThis is how it is supposed to work according to json-schema.org, e.g. see: https://json-schema.org/learn/json-schema-examples#blog-post\r\n\r\n## Actual behaviour and Error Message\r\n\r\nWhen defining my schema like this i get this (typescript) error:\r\n```\r\nType '{ type: \"object\"; additionalProperties: false; required: \"dateProperty\"[]; properties: { dateProperty: { type: string; format: string; }; }; }' is not assignable to type 'JSONSchemaType<TypeWithDate>'.\r\n  Type '{ type: \"object\"; additionalProperties: false; required: \"dateProperty\"[]; properties: { dateProperty: { type: string; format: string; }; }; }' is not assignable to type '({ anyOf: readonly UncheckedJSONSchemaType<TypeWithDate, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; }) | ({ ...; } & { ...; }) | ({ ...; } & ... 2 more ... & { ...; })'.\r\n    Type '{ type: \"object\"; additionalProperties: false; required: \"dateProperty\"[]; properties: { dateProperty: { type: string; format: string; }; }; }' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }'.\r\n      Type '{ type: \"object\"; additionalProperties: false; required: \"dateProperty\"[]; properties: { dateProperty: { type: string; format: string; }; }; }' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; }'.\r\n        The types of 'properties.dateProperty' are incompatible between these types.\r\n          Type '{ type: string; format: string; }' is not assignable to type '{ $ref: string; } | (UncheckedJSONSchemaType<Date, false> & { nullable?: false | undefined; const?: Date | undefined; enum?: readonly Date[] | undefined; default?: Date | undefined; })'.\r\n            Type '{ type: string; format: string; }' is not assignable to type '({ anyOf: readonly UncheckedJSONSchemaType<Date, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<...>> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ({ ...; } & ... 1 more ... & { ...; })'.\r\n              Type '{ type: string; format: string; }' is not assignable to type '{ oneOf: readonly UncheckedJSONSchemaType<Date, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<...>> | undefined; definitions?: Record<...> | undefined; } & { ...; }'.\r\n                Property 'oneOf' is missing in type '{ type: string; format: string; }' but required in type '{ oneOf: readonly UncheckedJSONSchemaType<Date, false>[]; }'.ts(2322)\r\n```\r\n\r\nThe important line being this one:\r\n```\r\nProperty 'oneOf' is missing in type '{ type: string; format: string; }' but required in type '{ oneOf: readonly UncheckedJSONSchemaType<Date, false>[]; }'\r\n```\r\n\r\n## Minimal Reproducible Example\r\n\r\nSetup any project with typescript and AJV then paste this code:\r\n\r\n```ts\r\nimport type { JSONSchemaType } from \"ajv\";\r\n\r\ninterface TypeWithDate {\r\n    dateProperty: Date;\r\n}\r\n\r\nconst SCHEMA: JSONSchemaType<TypeWithDate> = {\r\n    type: \"object\",\r\n    additionalProperties: false,\r\n    required: [\"dateProperty\"],\r\n    properties: {\r\n        dateProperty: { type: \"string\", format: \"date-time\" },\r\n    },\r\n}\r\n```\r\n\r\n## Workaround\r\n\r\n```ts\r\nconst AJV_TYPESAFE_SCHEMA_DATETIME_BUGFIX = {\r\n  oneOf: [],\r\n};\r\n\r\n// Then when defining the schema\r\nconst SCHEMA: JSONSchemaType<TypeWithDate> = {\r\n    // ...\r\n    properties: {\r\n        dateProperty: { type: \"string\", format: \"date-time\", ...AJV_TYPESAFE_SCHEMA_DATETIME_BUGFIX  },\r\n    },\r\n}\r\n```\r\n\r\n## Versions\r\n\r\n### Typescript\r\n```\r\nVersion 5.6.3\r\n```\r\n\r\n### AJV\r\n```\r\najv@8.17.1 | MIT | deps: 4 | versions: 355\r\nAnother JSON Schema Validator\r\nhttps://ajv.js.org\r\n\r\nkeywords: JSON, schema, validator, validation, jsonschema, json-schema, json-schema-validator, json-schema-validation\r\n\r\ndist\r\n.tarball: https://registry.npmjs.org/ajv/-/ajv-8.17.1.tgz\r\n.shasum: 37d9a5c776af6bc92d7f4f9510eba4c0a60d11a6\r\n.integrity: sha512-B/gBuNg5SiMTrPkC+A2+cW0RszwxYmn6VYxB/inlBStS5nx6xHIt/ehKRhIMhqusl7a8LjQoZnjCs5vhwxOQ1g==\r\n.unpackedSize: 1.0 MB\r\n\r\ndependencies:\r\nfast-deep-equal: ^3.1.3      fast-uri: ^3.0.1             json-schema-traverse: ^1.0.0 require-from-string: ^2.0.2  \r\n\r\nmaintainers:\r\n- blakeembrey <hello@blakeembrey.com>\r\n- esp <e.poberezkin@me.com>\r\n\r\ndist-tags:\r\n4.x: 4.11.8     beta: 8.11.1    latest: 8.17.1  \r\n\r\npublished 5 months ago by esp <e.poberezkin@me.com>\r\n```\r\n\r\n## Cause and Fix\r\n\r\nIm quite new to AJV but i think the bug is caused by the code in `ajv/dist/types/json-schema.d.ts (line 21)`\r\n\r\n_Edit: fixed cause and fix heading_","comments":[],"createdAt":"2025-01-05T19:09:17Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2521,"title":"A schema for a TypeScript interface with a Date property falsely expects oneOf in the schema"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nversion: 8.17.1 (latest)\r\n\r\n**Ajv options object**\r\n\r\n```typescript\r\nconst ajv = new Ajv({\r\n  strict: true\r\n})\r\n```\r\n\r\n**JSON Schema**\r\n\r\n```javascript\r\nconst schema = {\r\n  type: 'object',\r\n  properties: {\r\n    name: {\r\n      type: 'string'\r\n    },\r\n    age: {\r\n      type: 'number'\r\n    }\r\n  },\r\n  required: [ 'name' ],\r\n  if: {\r\n    properties: {\r\n      name: { type: 'string', minLength: 3 }\r\n    }\r\n  },\r\n  then: {\r\n    properties: {\r\n      age: { type: 'number', minimum: 10 }\r\n    },\r\n    required: [ 'age' ]\r\n  }\r\n}\r\n```\r\n\r\n**Sample data**\r\n```json\r\nconst data = {\r\n  name: undefined,\r\n  age: undefined\r\n}\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n[\r\n  {\r\n    instancePath: '',\r\n    keyword: 'required',\r\n    message: 'must have required property `age`',\r\n    params: {\r\n      missingProperty: 'age'\r\n    },\r\n    schemaPath: '#/then/required'\r\n  }\r\n]\r\n```\r\n\r\n**What results did you expect?**\r\n\r\n```\r\n[\r\n  {\r\n    instancePath: '',\r\n    keyword: 'required',\r\n    message: 'must have required property `name`',\r\n    params: {\r\n      missingProperty: 'name'\r\n    },\r\n    schemaPath: '#/then/required'\r\n  }\r\n]\r\n```\r\n\r\nSo, I'm trying validate the data by this `schema`. And faced with unexpected behavior. In this example I've got error with `age` field instead of `name`. So I expect that `name` field at first level in object must be validated before `age`.\r\nBy the way, in another example, if I've got an empty string in `name` field, I have a valid `data`.\r\n\r\nI've tried to change the schema like this using `allOf`:\r\n\r\n```javascript\r\nconst schema = {\r\n  type: 'object',\r\n  properties: {\r\n    name: {\r\n      type: 'string'\r\n    },\r\n    age: {\r\n      type: 'number'\r\n    }\r\n  },\r\n  required: [ 'name' ],\r\n  allOf: [\r\n    {\r\n      if: {\r\n        properties: {\r\n          name: { type: 'string', minLength: 3 }\r\n        }\r\n      },\r\n      then: {\r\n        properties: {\r\n          age: { type: 'number', minimum: 10 }\r\n        },\r\n        required: [ 'age' ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nSame result.\r\n\r\n**Are you going to resolve the issue?**\r\nI'm asking your comment and advice first of all.\r\n","comments":[{"id":"IC_kwDOAiQBJM6kYdDD","author":{"login":"lynoure"},"authorAssociation":"NONE","body":"Seems this also happens with a JSON such as \nconst test = {\n\n};\n\n(without the unknown-to-JSON undefined)\n\nBut with \nconst test = {\nage: null,\nname: null\n};\n\nit gives what you'd expect.\n\nI am not yet familiar enough with the schema format to say anything about that.\n","createdAt":"2025-03-27T12:31:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2520#issuecomment-2757873859","viewerDidAuthor":false}],"createdAt":"2024-12-29T23:46:04Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2520,"title":"Bug in conditions `if/then`."},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports. For other issues please use:\r\n- security vulnerability: https://tidelift.com/security)\r\n- a new feature/improvement: https://ajv.js.org/contributing/#changes\r\n- browser/compatibility issues: https://ajv.js.org/contributing/#compatibility\r\n- JSON-Schema standard: https://ajv.js.org/contributing/#json-schema\r\n- Ajv usage questions: https://gitter.im/ajv-validator/ajv\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.17.1, Yes\r\n\r\nHere is a link to the documentation:\r\nhttps://json-schema.org/understanding-json-schema/reference/type\r\n\r\nThe syntax I have given is valid and supported by ajv and works. Error only in JSONSchemaType:\r\n\r\n```typescript\r\nimport type { JSONSchemaType } from 'ajv';\r\n\r\ntype NullInTypeFieldArray = { someField: number | null };\r\nconst nullInTypeFieldArraySchema: JSONSchemaType<NullInTypeFieldArray> = {\r\n  type: 'object',\r\n  required: ['someField'],\r\n  properties: {\r\n    someField: { type: ['number', 'null'] },\r\n  },\r\n};\r\n\r\ntype ObjectInTypeFieldArray = { someField: { anotherField: number } | null };\r\nconst objectInTypeFieldArraySchema: JSONSchemaType<ObjectInTypeFieldArray> = {\r\n  type: 'object',\r\n  required: ['someField'],\r\n  properties: {\r\n    someField: {\r\n      type: ['object', 'null'],\r\n      properties: {\r\n        anotherField: { type: 'number' },\r\n      },\r\n    },\r\n  },\r\n};\r\n\r\ntype ArrayInTypeFieldAArray = { someField: string[] | null };\r\nconst schemaWithArrayInType: JSONSchemaType<ArrayInTypeFieldAArray> = {\r\n  type: 'object',\r\n  required: ['someField'],\r\n  properties: {\r\n    someField: {\r\n      type: ['array', 'null'],\r\n      items: { type: 'string' },\r\n    },\r\n  },\r\n};\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\nVery long typescript type check error:\r\n```\r\n1. Type '{ type: \"object\"; required: \"someField\"[]; properties: { someField: { type: string[]; properties: { anotherField: { type: \"number\"; }; }; }; }; }' is not assignable to type 'JSONSchemaType<ObjectInTypeFieldArray>'.\r\n     Type '{ type: \"object\"; required: \"someField\"[]; properties: { someField: { type: string[]; properties: { anotherField: { type: \"number\"; }; }; }; }; }' is not assignable to type '({ anyOf: readonly UncheckedJSONSchemaType<ObjectInTypeFieldArray, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }) | ({ oneOf: readonly UncheckedJSONSchemaType<ObjectInTypeFieldArray, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }) | ({ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; properties?: UncheckedPropertiesSchema<ObjectInTypeFieldArray> | undefined; patternProperties?: Record<string, UncheckedJSONSchemaType<unknown, false>> | undefined; propertyNames?: (Omit<UncheckedJSONSchemaType<string, false>, \"type\"> & { type?: \"string\" | undefined; }) | undefined; dependencies?: { someField?: readonly \"someField\"[] | UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; dependentRequired?: { someField?: readonly \"someField\"[] | undefined; } | undefined; dependentSchemas?: { someField?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; minProperties?: number | undefined; maxProperties?: number | undefined; } & { required: readonly \"someField\"[]; } & { allOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; anyOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; oneOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; if?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; then?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; else?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; not?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; })'.\r\n       Type '{ type: \"object\"; required: \"someField\"[]; properties: { someField: { type: string[]; properties: { anotherField: { type: \"number\"; }; }; }; }; }' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; properties?: UncheckedPropertiesSchema<ObjectInTypeFieldArray> | undefined; patternProperties?: Record<string, UncheckedJSONSchemaType<unknown, false>> | undefined; propertyNames?: (Omit<UncheckedJSONSchemaType<string, false>, \"type\"> & { type?: \"string\" | undefined; }) | undefined; dependencies?: { someField?: readonly \"someField\"[] | UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; dependentRequired?: { someField?: readonly \"someField\"[] | undefined; } | undefined; dependentSchemas?: { someField?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; minProperties?: number | undefined; maxProperties?: number | undefined; } & { required: readonly \"someField\"[]; } & { allOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; anyOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; oneOf?: readonly UncheckedPartialSchema<ObjectInTypeFieldArray>[] | undefined; if?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; then?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; else?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; not?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }'.\r\n         Type '{ type: \"object\"; required: \"someField\"[]; properties: { someField: { type: string[]; properties: { anotherField: { type: \"number\"; }; }; }; }; }' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; properties?: UncheckedPropertiesSchema<ObjectInTypeFieldArray> | undefined; patternProperties?: Record<string, UncheckedJSONSchemaType<unknown, false>> | undefined; propertyNames?: (Omit<UncheckedJSONSchemaType<string, false>, \"type\"> & { type?: \"string\" | undefined; }) | undefined; dependencies?: { someField?: readonly \"someField\"[] | UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; dependentRequired?: { someField?: readonly \"someField\"[] | undefined; } | undefined; dependentSchemas?: { someField?: UncheckedPartialSchema<ObjectInTypeFieldArray> | undefined; } | undefined; minProperties?: number | undefined; maxProperties?: number | undefined; }'.\r\n           The types of 'properties.someField' are incompatible between these types.\r\n             Type '{ type: string[]; properties: { anotherField: { type: \"number\"; }; }; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; }) | ({ oneOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; }) | ({ type: readonly never[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; }) | ({ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; properties?: UncheckedPropertiesSchema<{ anotherField: number; }> | undefined; patternProperties?: Record<string, UncheckedJSONSchemaType<unknown, false>> | undefined; propertyNames?: (Omit<UncheckedJSONSchemaType<string, false>, \"type\"> & { type?: \"string\" | undefined; }) | undefined; dependencies?: { anotherField?: readonly \"anotherField\"[] | UncheckedPartialSchema<{ anotherField: number; }> | undefined; } | undefined; dependentRequired?: { anotherField?: readonly \"anotherField\"[] | undefined; } | undefined; dependentSchemas?: { anotherField?: UncheckedPartialSchema<{ anotherField: number; }> | undefined; } | undefined; minProperties?: number | undefined; maxProperties?: number | undefined; } & { required: readonly \"anotherField\"[]; } & { allOf?: readonly UncheckedPartialSchema<{ anotherField: number; } | null>[] | undefined; anyOf?: readonly UncheckedPartialSchema<{ anotherField: number; } | null>[] | undefined; oneOf?: readonly UncheckedPartialSchema<{ anotherField: number; } | null>[] | undefined; if?: UncheckedPartialSchema<{ anotherField: number; } | null> | undefined; then?: UncheckedPartialSchema<{ anotherField: number; } | null> | undefined; else?: UncheckedPartialSchema<{ anotherField: number; } | null> | undefined; not?: UncheckedPartialSchema<{ anotherField: number; } | null> | undefined; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; })'.\r\n               Type '{ type: string[]; properties: { anotherField: { type: \"number\"; }; }; }' is not assignable to type '({ anyOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; }) | ({ oneOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; })'.\r\n                 Type '{ type: string[]; properties: { anotherField: { type: \"number\"; }; }; }' is not assignable to type '{ oneOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; } & { nullable?: false | undefined; const?: { anotherField: number; } | null | undefined; enum?: readonly ({ anotherField: number; } | null)[] | undefined; default?: { anotherField: number; } | null | undefined; }'.\r\n                   Property 'oneOf' is missing in type '{ type: string[]; properties: { anotherField: { type: \"number\"; }; }; }' but required in type '{ oneOf: readonly UncheckedJSONSchemaType<{ anotherField: number; } | null, false>[]; }'. [2322]\r\n```\r\n\r\n**What results did you expect?**\r\nNo typing errors\r\n\r\n**Are you going to resolve the issue?**\r\nYes","comments":[{"id":"IC_kwDOAiQBJM6g1Nr0","author":{"login":"victorialangrula"},"authorAssociation":"NONE","body":"Any updates on this? Any workarounds you suggest in the meantime?","createdAt":"2025-03-04T16:46:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2518#issuecomment-2698304244","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6vve8S","author":{"login":"utrumo"},"authorAssociation":"NONE","body":"> Any updates on this? Any workarounds you suggest in the meantime?\n\nSorry, i was forgot answering you.\nIn my work project i made a patch for this library. You can try it too.\n\n```\ncat .yarn/patches/ajv-npm-8.17.1-12ade7edc6.patch\n```\n\n```\ndiff --git a/dist/types/json-schema.d.ts b/dist/types/json-schema.d.ts\nindex a391fef7229a2a6298642ae1e872d74270963c51..6ab2c0a7725a85ffddf741a165d7d9541b3b13f5 100644\n--- a/dist/types/json-schema.d.ts\n+++ b/dist/types/json-schema.d.ts\n@@ -24,7 +24,7 @@ type UncheckedJSONSchemaType<T, IsPartial extends boolean> = (// these two union\n } | {\n     oneOf: readonly UncheckedJSONSchemaType<T, IsPartial>[];\n } | ({\n-    type: readonly (T extends number ? JSONType<\"number\" | \"integer\", IsPartial> : T extends string ? JSONType<\"string\", IsPartial> : T extends boolean ? JSONType<\"boolean\", IsPartial> : never)[];\n+    type: readonly (T extends number ? JSONType<\"number\" | \"integer\", IsPartial> : T extends string ? JSONType<\"string\", IsPartial> : T extends boolean ? JSONType<\"boolean\", IsPartial> : T extends readonly any[] ? JSONType<\"array\", IsPartial> : T extends Record<string, any> ? JSONType<\"object\", IsPartial> : T extends null ? JSONType<\"null\", IsPartial> : never)[];\n } & UnionToIntersection<T extends number ? NumberKeywords : T extends string ? StringKeywords : T extends boolean ? {} : never>) | ((T extends number ? {\n     type: JSONType<\"number\" | \"integer\", IsPartial>;\n } & NumberKeywords : T extends string ? {\n\n```","createdAt":"2025-06-06T08:16:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2518#issuecomment-2948460306","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7RLE-w","author":{"login":"ezpuzz"},"authorAssociation":"NONE","body":"Thank you @utrumo, this solved my problem!","createdAt":"2025-11-10T04:27:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2518#issuecomment-3509342128","viewerDidAuthor":false}],"createdAt":"2024-12-24T18:00:06Z","labels":[],"number":2518,"title":"UncheckedJSONSchemaType ['type'] field does not support 'array', 'object', and 'null' in an array"},{"body":"If a callback function inputted to the `validate` property is self contained, then it could be used to generate the standalone code.\r\n\r\nWhy not allow the client to specify a flag that would use the validate callback to generate standalone code?\r\n\r\n```\r\najv.addKeyword({\r\n  keyword: \"even\",\r\n  type: \"number\",\r\n  schemaType: \"boolean\",\r\n  // $data: true // to support [$data reference](./guide/combining-schemas.md#data-reference), ...\r\n  validate: (schema, data) => {\r\n    return true;\r\n  },\r\n  code(cxt) {\r\n    const { data, schema } = cxt;\r\n    const op = schema ? Ajv._`!==` : Ajv._`===`;\r\n    cxt.fail(Ajv._`${data} %2 ${op} 0`); // ... the only code change needed is to use `cxt.fail$data` here\r\n  },\r\n});\r\n```","comments":[],"createdAt":"2024-12-23T11:47:19Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2517,"title":"ability to generate standalone code from the callback specified in the validate property"},{"body":"https://ajv.js.org/keywords.html#define-keyword-with-code-generation-function\r\n\r\nIn the very first example of the above:\r\n\r\n```\r\nimport {_, KeywordCxt} from Ajv\r\n\r\najv.addKeyword({\r\n  keyword: \"even\",\r\n  type: \"number\",\r\n  schemaType: \"boolean\",\r\n  // $data: true // to support [$data reference](./guide/combining-schemas.md#data-reference), ...\r\n  code(cxt: KeywordCxt) {\r\n    const {data, schema} = cxt\r\n    const op = schema ? _`!==` : _`===`\r\n    cxt.fail(_`${data} %2 ${op} 0`) // ... the only code change needed is to use `cxt.fail$data` here\r\n  },\r\n})\r\n\r\nconst schema = {even: true}\r\nconst validate = ajv.compile(schema)\r\nconsole.log(validate(2)) // true\r\nconsole.log(validate(3)) // false\r\n```\r\n\r\nThis also returns true:\r\n\r\n```\r\nconsole.log(validate({})) // true\r\n```\r\n\r\nHere is the compiled validator code:\r\n\r\n\r\n```\r\n\"use strict\";\r\nmodule.exports = validate16;\r\nmodule.exports.default = validate16;\r\nconst schema34 = { even: true };\r\nfunction validate16(\r\n  data,\r\n  { instancePath = \"\", parentData, parentDataProperty, rootData = data } = {}\r\n) {\r\n  let vErrors = null;\r\n  let errors = 0;\r\n  if (typeof data == \"number\" && isFinite(data)) {\r\n    if (data % 2 !== 0) {\r\n      const err0 = {\r\n        instancePath,\r\n        schemaPath: \"#/even\",\r\n        keyword: \"even\",\r\n        params: {},\r\n        message: 'must pass \"even\" keyword validation',\r\n      };\r\n      if (vErrors === null) {\r\n        vErrors = [err0];\r\n      } else {\r\n        vErrors.push(err0);\r\n      }\r\n      errors++;\r\n    }\r\n  }\r\n  validate16.errors = vErrors;\r\n  return errors === 0;\r\n}\r\n```\r\n\r\nThe bug is caused by the fact that there is no `else` statement to handle the `if (typeof data == \"number\" && isFinite(data))`.\r\n\r\nSo when the `if (typeof data == \"number\" && isFinite(data))` fails, the validator just returns without any errors, when in fact there should be an error.\r\n\r\nI am using `\"ajv\": \"^8.11.0\"`.\r\n\r\nI believe that this is a bug.","comments":[],"createdAt":"2024-12-18T11:22:51Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2516,"title":"bug in AJV custom keyword validator"},{"body":"**What version of Ajv you are you using?**\r\n\r\nv8.17.1\r\n\r\n**What problem do you want to solve?**\r\n\r\nIt may be better to keep error messages consistent in terms of expression/format. More specifically, I found a minor issue that properties in dependency errors are not enclosed with quotes (like `must have properties X when property Y is present`) while required properties are enclosed like `must have property 'X'`.\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nEnclose properties with quotes in the case of dependency errors.\r\n\r\n**Will you be able to implement it?**\r\n\r\nI plan to make a PR.\r\n","comments":[],"createdAt":"2024-12-16T09:17:20Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2514,"title":"Consistency of validation error messages"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n* v8.17.1\r\n* Yes\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\n\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\nN/A\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\nconst Error0 = require(\"ajv/dist/runtime/validation_error\").default;\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\n\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n\r\n```\r\n\r\n**What results did you expect?**\r\nThe standalone code should be truly standalone and portable. With this require statement added, it is no longer truly standalone:\r\n\r\nhttps://github.com/ajv-validator/ajv/blob/69568d08564303e2c32a2de61feb833b41075f96/lib/compile/index.ts#L120-L125\r\n\r\n**Are you going to resolve the issue?**\r\n","comments":[],"createdAt":"2024-11-22T02:22:34Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2509,"title":"Standalone code not truly standalone"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nUsing version `8.12.0` up to `8.16.0` works, latest version fails.\r\n\r\nUncaught (in promise) TypeError: Cannot read properties of undefined (reading 'toLowerCase')\r\n    at Object.urnSerialize [as serialize] (ajv_dist_2020.js?v=7ea982fe:3411:37)\r\n    at Object.serialize (ajv_dist_2020.js?v=7ea982fe:3592:67)\r\n    at _getFullPath (ajv_dist_2020.js?v=7ea982fe:2215:35)\r\n    at getFullPath (ajv_dist_2020.js?v=7ea982fe:2211:14)\r\n    at Ajv2020.getSchemaRefs (ajv_dist_2020.js?v=7ea982fe:2236:26)\r\n    at Ajv2020._addSchema (ajv_dist_2020.js?v=7ea982fe:4195:51)\r\n    at Ajv2020.addSchema (ajv_dist_2020.js?v=7ea982fe:3993:34)\r\n    at Ajv2020.addInitialSchemas (ajv_dist_2020.js?v=7ea982fe:4253:16)\r\n    at new Ajv (ajv_dist_2020.js?v=7ea982fe:3887:27)\r\n    at new Ajv2020 (ajv_dist_2020.js?v=7ea982fe:6903:9)\r\n\r\nThat is this line of code:\r\n```javascript\r\nfunction urnSerialize(urnComponents, options) {\r\n      const scheme = options.scheme || urnComponents.scheme || \"urn\";\r\n      const nid = urnComponents.nid.toLowerCase();\r\n```\r\n\r\nNot sure what `nid` is, but it's `undefined` and the code does not validate, hence the unexpected exception.  Previous versions did not call `toLowerCase`.\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\nconst options = {\r\n\t\t\t\tallErrors: true,\r\n\t\t\t\tverbose: true,\r\n\t\t\t\tallowUnionTypes: true,\r\n\t\t\t\tschemas: {\r\n\t\t\t\t\t\"/schemas/iw/rule/column/adorner\": sub_columnRuleAdorner,\r\n\t\t\t\t\t\"/schemas/iw/rule/column/class\": sub_columnRuleClass,\r\n\t\t\t\t\t\"/schemas/iw/source/command\": sub_command,\r\n\t\t\t\t\t\"/schemas/iw/column/computed\": sub_computedColumn,\r\n\t\t\t\t\t\"/schemas/iw/column/data\": sub_dataColumn,\r\n\t\t\t\t\t\"/schemas/iw/dateFormat\": sub_dateFormat,\r\n\t\t\t\t\t\"/schemas/iw/component/grid\": sub_grid,\r\n\t\t\t\t\t\"/schemas/iw/grid/group\": sub_gridGroup,\r\n\t\t\t\t\t\"/schemas/iw/component/grid/detail\": sub_detailGrid,\r\n\t\t\t\t\t\"/schemas/iw/source/entitySet/entityFilter\": sub_entityFilter,\r\n\t\t\t\t\t\"/schemas/iw/source/entitySet\": sub_entitySet,\r\n\t\t\t\t\t\"/schemas/iw/grid/expand\": sub_expand,\r\n\t\t\t\t\t\"/schemas/iw/grid/search\": sub_gridSearch,\r\n\t\t\t\t\t\"/schemas/iw/format\": sub_format,\r\n\t\t\t\t\t\"/schemas/iw/source/overlay\": sub_overlay,\r\n\t\t\t\t\t\"/schemas/iw/command/builtin\": sub_builtinCommand,\r\n\t\t\t\t\t\"/schemas/iw/command/page\": sub_pageCommand,\r\n\t\t\t\t\t\"/schemas/iw/command/row\": sub_rowCommand,\r\n\t\t\t\t\t\"/schemas/iw/rule/row/class\": sub_rowRuleClass,\r\n\t\t\t\t},\r\n\t\t\t};\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n\t\"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\r\n\t\"$id\": \"urn:pyramidsolutions.com/schemas/iw/rule/column/adorner\",\r\n\t\"type\": \"object\",\r\n\t\"description\": \"Adorner rule\",\r\n\t\"properties\": {\r\n\t\t\"name\": {\r\n\t\t\t\"type\": \"string\",\r\n\t\t\t\"description\": \"Name of rule used in diagnostics\"\r\n\t\t},\r\n\t\t\"type\": {\r\n\t\t\t\"type\": \"string\",\r\n\t\t\t\"description\": \"Type of rule 'adorner'\",\r\n\t\t\t\"const\": \"adorner\"\r\n\t\t},\r\n\t\t\"enabled\": {\r\n\t\t\t\"type\": \"boolean\",\r\n\t\t\t\"description\": \"Evaluate rule if set to true\"\r\n\t\t},\r\n\t\t\"field\": {\r\n\t\t\t\"type\": \"string\",\r\n\t\t\t\"description\": \"Field name to evaluate\"\r\n\t\t},\r\n\t\t\"position\": {\r\n\t\t\t\"type\": \"string\",\r\n\t\t\t\"description\": \"Adorner position\",\r\n\t\t\t\"enum\": [\"before\", \"after\"]\r\n\t\t},\r\n\t\t\"function\": {\r\n\t\t\t\"type\": \"string\",\r\n\t\t\t\"description\": \"Javascript must return formatting object(s) to trigger\"\r\n\t\t},\r\n\t\t\"template\": {\r\n\t\t\t\"type\": [\"number\", \"integer\", \"boolean\", \"string\", \"array\", \"object\"],\r\n\t\t\t\"description\": \"Data passed to the script function\"\r\n\t\t}\r\n\t},\r\n\t\"required\": [\"name\", \"type\", \"enabled\", \"field\", \"position\", \"function\"]\r\n}\r\n```\r\nNot sure if it is relevant.  All JSON schemas use similar techniques for `$schema` and `$id`.\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n\r\n```\r\n\r\nCrashes in constructor before any methods can be called.\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\nconst ajv = new Ajv2020(options);\r\n```\r\n\r\nCrashes in constructor.\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n\r\n```\r\nCrashes before any methods can be called.\r\n\r\n**What results did you expect?**\r\nExpect it to work the same as previous version.  **Expect you to check values for `null` or `undefined` before calling methods on them.**\r\n\r\n**Are you going to resolve the issue?**\r\nNo.","comments":[{"id":"IC_kwDOAiQBJM6R5Vky","author":{"login":"pyramid-johng"},"authorAssociation":"NONE","body":"After some reading, went in and added the `nid` to the `urn` values; according to spec this field is required, but earlier versions of the library tolerated it being omitted.  This tolerance should be preserved to avoid unexpected issues for users upgrading the version of this package, perhaps add an option setting to opt-in to the stricter behavior.\r\n\r\nIn any event there should be checks in place for `null` and `undefined` values; this is just good hygiene.\r\n\r\nIf the `nid` field is really required by the implementation, a specific actionable error message should be provided, not one from an indirect \"crash\".  This would save time on troubleshooting by users.","createdAt":"2024-10-30T16:27:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2503#issuecomment-2447726898","viewerDidAuthor":false}],"createdAt":"2024-10-30T15:55:40Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2503,"title":"urnSerialize Fails Unexpectedly"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?** reproduces for me on latest version\r\n\r\nI am seeing that for some reason when having a schema with an anyof between two objects the removeAdditionalProperties does not consider all the possible keys when removing the properties from the object and only looks at the first object in the anyOf\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n**jsfiddle with the issue reproduced:**\r\nhttps://jsfiddle.net/x7s85b3t/1/\r\n\r\n**Your code**\r\n```javascript\r\nconst schema = {\r\n  \"properties\": {\r\n    \"body\": {\r\n      \"type\": \"object\",\r\n      \"properties\": {\r\n        \"configuration\": {\r\n          \"anyOf\": [\r\n            {\r\n              \"type\": \"object\",\r\n              \"properties\": {\r\n                \"differentA\": {\r\n                  \"type\": \"string\"\r\n                },\r\n                \"differentB\": {\r\n                  \"type\": \"string\"\r\n                }\r\n              },\r\n              \"required\": [\r\n                \"differentA\",\r\n                \"differentB\"\r\n              ],\r\n              \"additionalProperties\": false\r\n            },\r\n            {\r\n              \"type\": \"object\",\r\n              \"properties\": {\r\n                \"propA\": {\r\n                  \"type\": \"string\"\r\n                },\r\n                \"propB\": {\r\n                  \"type\": \"string\"\r\n                }\r\n              },\r\n              \"required\": [\r\n                \"propA\",\r\n                \"propB\"\r\n              ],\r\n              \"additionalProperties\": false\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"required\": [\r\n        \"configuration\"\r\n      ],\r\n      \"additionalProperties\": false\r\n    }\r\n  },\r\n  \"required\": [\r\n    \"body\"\r\n  ],\r\n  \"additionalProperties\": true,\r\n  \"definitions\": {}\r\n}\r\n\r\nvar json = {\r\n  body:  {\r\n    \"configuration\": {\r\n        \"propA\": \"1\",\r\n        \"propB\": \"2\"\r\n    }\r\n    }\r\n};\r\nvar ajv = new Ajv({\r\n\tallErrors: true,\r\n\tremoveAdditional: true\r\n});\r\n\r\nvar result = ajv.validate(schema, json);\r\n\r\nconsole.log('Result: ', result);\r\nconsole.log('Errors: ', ajv.errors);\r\nconsole.log('Final Configuration object json: ', JSON.stringify(json.body.configuration));\r\n\r\n```\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n\"Errors: \", [{\r\n  dataPath: \".body.configuration\",\r\n  keyword: \"required\",\r\n  message: \"should have required property 'differentA'\",\r\n  params: {\r\n    missingProperty: \"differentA\"\r\n  },\r\n  schemaPath: \"#/properties/body/properties/configuration/anyOf/0/required\"\r\n}, {\r\n  dataPath: \".body.configuration\",\r\n  keyword: \"required\",\r\n  message: \"should have required property 'differentB'\",\r\n  params: {\r\n    missingProperty: \"differentB\"\r\n  },\r\n  schemaPath: \"#/properties/body/properties/configuration/anyOf/0/required\"\r\n}, {\r\n  dataPath: \".body.configuration\",\r\n  keyword: \"required\",\r\n  message: \"should have required property 'propA'\",\r\n  params: {\r\n    missingProperty: \"propA\"\r\n  },\r\n  schemaPath: \"#/properties/body/properties/configuration/anyOf/1/required\"\r\n}, {\r\n  dataPath: \".body.configuration\",\r\n  keyword: \"required\",\r\n  message: \"should have required property 'propB'\",\r\n  params: {\r\n    missingProperty: \"propB\"\r\n  },\r\n  schemaPath: \"#/properties/body/properties/configuration/anyOf/1/required\"\r\n}, {\r\n  dataPath: \".body.configuration\",\r\n  keyword: \"anyOf\",\r\n  message: \"should match some schema in anyOf\",\r\n  params: { ... },\r\n  schemaPath: \"#/properties/body/properties/configuration/anyOf\"\r\n}]\r\n\"Final Configuration object json: \", \"{}\"\r\n\r\n```\r\n\r\n**What results did you expect?**\r\nI expected that the remove additional properties will take all the possible object keys into consideration and not only the first one, so I am able to have a schema that allows any of the objects inside the anyof where in reality it fails for the second object\r\n","comments":[{"id":"IC_kwDOAiQBJM6SGdyX","author":{"login":"trevorparscal"},"authorAssociation":"NONE","body":"I think I bumped into the same issue today. Here's my scenario...\r\n\r\n```javascript\r\nconst a = {\r\n\ttype: 'object',\r\n\tproperties: {\r\n\t\tx: { type: 'number' }\r\n\t},\r\n\trequired: [ 'x' ],\r\n\tadditionalProperties: false\r\n};\r\n\r\nconst b = {\r\n\ttype: 'object',\r\n\tproperties: {\r\n\t\tx: { type: 'number' },\r\n\t\ty: { type: 'number' }\r\n\t},\r\n\trequired: [ 'x', 'y' ],\r\n\tadditionalProperties: false\r\n};\r\n\r\nconst any = {\r\n\tanyOf: [ a, b ]\r\n};\r\n```\r\n\r\nValidation against `any` only works for objects conforming to schema `a`. Objects conforming to schema `b` will fail because while checking `a`, the `y` property gets removed.","createdAt":"2024-11-01T02:19:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2500#issuecomment-2451168407","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6SKbIv","author":{"login":"trevorparscal"},"authorAssociation":"NONE","body":"After reading the docs more deeply, it seems this unexpected behavior is well know.\r\n\r\nhttps://ajv.js.org/guide/modifying-data.html#removing-additional-properties","createdAt":"2024-11-01T16:45:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2500#issuecomment-2452206127","viewerDidAuthor":false}],"createdAt":"2024-10-13T09:08:13Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2500,"title":"Unexpected behavior when validating a schema with anyOf between two objects"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?** I'm using the latest version.\r\n\r\nI'm getting \"can't resolve reference\" error when having a schema with a definition property using a uri-encoding like '%3C' or '%22'. I started seeing this while using a schema with the fields oneOf, allOf or anyOf inside the definition.\r\n\r\nThe following code, based on a template provided in this repo, was used to debug the error.\r\n\r\n```javascript\r\nconst Ajv = require(\"ajv\")\r\nconst ajv = new Ajv({allErrors: true})\r\n\r\n  const schema = {\r\n    title: 'object with $ref',\r\n    definitions: {\r\n      'Some%3Cloremipsum3E': {\r\n          additionalProperties: {\r\n\t\ttype: 'string',\r\n          },\r\n          type: 'object'\r\n      }\r\n    },\r\n    type: 'object',\r\n    properties: {\r\n      obj: {\r\n        $ref: '#/definitions/Some%3Cloremipsum3E'\r\n      }\r\n    }\r\n  }\r\n\r\n  const object = {\r\n    obj: {\r\n      str: 'test'\r\n    }\r\n  }\r\nconst validate = ajv.compile(schema)\r\n\r\ntest(object)\r\n\r\n\r\nfunction test(data) {\r\n  const valid = validate(data)\r\n  if (valid) console.log(\"Valid!\")\r\n  else console.log(\"Invalid: \" + ajv.errorsText(validate.errors))\r\n}\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nMissingRefError: can't resolve reference #/definitions/Some%3Cloremipsum3E from id #\r\n    at Object.code (./node_modules/ajv/dist/vocabularies/core/ref.js:43:19)\r\n    at keywordCode (./node_modules/ajv/dist/compile/validate/index.js:480:13)\r\n    at ./node_modules/ajv/dist/compile/validate/index.js:193:25\r\n    at CodeGen.code (./node_modules/ajv/dist/compile/codegen/index.js:440:13)\r\n    at CodeGen.block (./node_modules/ajv/dist/compile/codegen/index.js:570:18)\r\n    at schemaKeywords (./node_modules/ajv/dist/compile/validate/index.js:193:13)\r\n    at typeAndKeywords (./node_modules/ajv/dist/compile/validate/index.js:131:16)\r\n    at subSchemaObjCode (./node_modules/ajv/dist/compile/validate/index.js:117:5)\r\n    at subschemaCode (./node_modules/ajv/dist/compile/validate/index.js:92:13)\r\n    at KeywordCxt.subschema (./node_modules/ajv/dist/compile/validate/index.js:448:9) {\r\n  missingRef: '#/definitions/Some%3Cloremipsum3E',\r\n  missingSchema: ''\r\n}\r\n\r\n```\r\nThe error is thrown in the line ` if (schOrEnv === undefined) throw new MissingRefError(it.opts.uriResolver, baseId, $ref)`.\r\nThe strucutre up to \"it\" seems to be as it should, but the props passed to  derived from it \"resolveRef.call\" seem to be missing definitions, turning schOrEnv to undefined and leading to the error.\r\n\r\n```javascript\r\nconst def: CodeKeywordDefinition = {\r\n  keyword: \"$ref\",\r\n  schemaType: \"string\",\r\n  code(cxt: KeywordCxt): void {\r\n    const {gen, schema: $ref, it} = cxt\r\n    const {baseId, schemaEnv: env, validateName, opts, self} = it\r\n    const {root} = env\r\n    if (($ref === \"#\" || $ref === \"#/\") && baseId === root.baseId) return callRootRef()\r\n    const schOrEnv = resolveRef.call(self, root, baseId, $ref)\r\n    if (schOrEnv === undefined) throw new MissingRefError(it.opts.uriResolver, baseId, $ref)\r\n```\r\n","comments":[{"id":"IC_kwDOAiQBJM6N5RDe","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"So I think the issue is that the definition needs to be defined with the decoded version like so:\r\n\r\n```\r\ndefinitions: {\r\n  'Some<loremipsum3E': {\r\n      additionalProperties: {\r\ntype: 'string',\r\n      },\r\n      type: 'object'\r\n  }\r\n},\r\n```\r\n\r\nThe worked for me with your example. The reason is because the when we use fast-uri to resolve the uri in the ref, it does that conversion, so it's not looking for the encoded version, but the def how it should be.\r\n\r\nDoes that make sense?","createdAt":"2024-09-28T10:45:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2496#issuecomment-2380599518","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6OC-Yf","author":{"login":"JonathanMonroeU"},"authorAssociation":"NONE","body":"> The reason is because the when we use fast-uri to resolve the uri in the ref, it does that conversion, so it's not looking for the encoded version, but the def how it should be.\r\n\r\nYeah, it does make sense. But what if I'm doing the encoding precisely to avoid these symbols to go on the definitions and ref string and possibly cause any issues? I'm replacing **\"** with %22 and **'** with %27, for example.\r\n\r\n","createdAt":"2024-09-30T13:07:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2496#issuecomment-2383144479","viewerDidAuthor":false}],"createdAt":"2024-09-27T20:04:20Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2496,"title":"Error using stringify on schema with uri-encoded definition property"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nVersion: \"8.17.1\" (Currently latest)\r\n\r\n**Your typescript code**\r\n\r\n```typescript\r\ninterface A<T> {\r\n\tsomeFunction() : JSONSchemaType<T>\r\n}\r\n\r\nclass B<T> implements A<T> {\r\n\t\r\n\tprivate _schema: JSONSchemaType<T>;\r\n\r\n\tsomeFunction(): JSONSchemaType<T>\r\n\t{\r\n\t\t// gives error\r\n\t\ttest(this);\r\n\t\treturn this._schema;\r\n\t}\r\n}\r\n\r\nfunction test<T, TA extends A<T>>(a: TA): TA\r\n{\r\n\treturn a;\r\n}\r\n\r\nfunction testcase2<T, AT extends A<T>>(a: AT)\r\n{\r\n\t// gives error (exactly the same)\r\n\ttest(a);\r\n}\r\n\r\nfunction testcase3<T, AT extends B<T>>(a: AT)\r\n{\r\n\t// gives error (exactly the same)\r\n\ttest(a);\r\n}\r\n\r\nfunction testcase4<T>(a: A<T>)\r\n{\r\n\t// gives error (exactly the same)\r\n\ttest(a);\r\n}\r\n\r\nfunction testcase5<T>(a: B<T>)\r\n{\r\n\t// gives error (exactly the same)\r\n\ttest(a);\r\n}\r\n```\r\n\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nArgument of type 'this' is not assignable to parameter of type 'A<unknown>'.\r\n  Type 'B<T>' is not assignable to type 'A<unknown>'.\r\n    The types returned by 'someFunction()' are incompatible between these types.\r\n      Type 'JSONSchemaType<T>' is not assignable to type 'JSONSchemaType<unknown>'.\r\n        Type '{ anyOf: readonly UncheckedJSONSchemaType<T, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<...> | undefined; }' is not assignable to type 'JSONSchemaType<unknown>'.\r\n          Type '{ anyOf: readonly UncheckedJSONSchemaType<T, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<...> | undefined; }' is not assignable to type '{ type: readonly never[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<...> | undefined; }'.\r\n            Property 'type' is missing in type '{ anyOf: readonly UncheckedJSONSchemaType<T, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<...> | undefined; }' but required in type '{ type: readonly never[]; }'.ts(2345)\r\n```\r\n\r\n**Explanation of code**\r\nWhat I found out is that when the `T` parameter is not known/ is still a generic-type and it is passed to a generic function (like `test`). Somehow typescript cannot resolve this, eventhough in my mind everything should check out. I swapped the `JSONSchemaType` for other objects which includes generic-types. Couldn't find something simular (and less complex) which results in the same issue.\r\n\r\n**Question and/or bugreport**\r\nI am not sure if this is usererror (user = me), or this is because some complicated type defenition typescript cannot handle. I would love to get some feedback or hints about how to solve this.\r\n\r\nThanks in advance!","comments":[],"createdAt":"2024-09-12T20:50:38Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2495,"title":"type `JSONSchemaType` cannot be resolved in generic/nonresolved context"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.17.1\r\n\r\n**Ajv options object**\r\n\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\n{\r\nremoveAdditional: true\r\n}\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\nexport const schema = {\r\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\r\n  \"$ref\": \"#/definitions/ClassProperties\",\r\n  \"definitions\": {\r\n    \"ClassProperties\": {\r\n      \"type\": \"object\",\r\n      \"properties\": {\r\n\t\"additionalProperties\": false,\r\n        \"flags\": {\r\n          \"type\": \"array\",\r\n          \"items\": {\r\n            \"$ref\": \"#/definitions/Flags\"\r\n          }\r\n        },\r\n      },\r\n       \"propertyNames\": {\r\n          \"$ref\": \"#/definitions/StyleParams\"\r\n        }\r\n    },\r\n    \"StyleParams\": {\r\n\t  \"additionalProperties\": false,\r\n\t  \"type\": \"string\",\r\n      \"enum\": [\r\n\t\t\"flags\",\r\n\t\t...Object.keys(StyleParameters) // includes \"BACKGROUND_COLOR\" but not \"CHEESE\"\r\n\t  ]\r\n    },\r\n    \"Flags\": {\r\n\t  \"type\": \"string\",\r\n          \"enum\": [\r\n              \"FLAG_ONE\"\r\n              \"FLAG_TWO\"\r\n      ]\r\n    }\r\n  }\r\n} as const\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n         flags: [\"FLAG_ONE\"],\r\n         BACKGROUND_COLOR: '#FFFFFF',\r\n         CHEESE: 'CHEDDAR'\r\n    }\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\n\r\nimport Ajv from \"ajv\";\r\n\r\nexport class JsonValidationHelper {\r\n\r\n    enum StyleParameters {\r\n        BACKGROUND_COLOR = 'backgroundcolor'\r\n        // many more\r\n    }\r\n\r\n    private static JsonValidationHelper <T>(typeProperties: object, schema: JSONSchema) {\r\n\t const result = SchemaParser.ajv.validate(schema, typeProperties)\r\n\t return typeProperties;\r\n    }\r\n\r\n}\r\n\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nvalidation result: false\r\ndata: {\r\nflags: [\"FLAG_ONE\"],\r\nBACKGROUND_COLOR: '#FFFFFF',\r\nCHEESE: 'CHEDDAR'\r\n}\r\n```\r\n\r\n**What results did you expect?**\r\nSince removeAdditional is set to true in the options and additionalProperties are not allowed, all properties not defined in the schema should be removed and since there are no required properties set the validation result should always be true.\r\n\r\nIn short:\r\n- The validation result should be true.\r\n- property CHEESE schould have been removed from the data\r\n**Are you going to resolve the issue?**\r\n","comments":[{"id":"IC_kwDOAiQBJM6N5UGw","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"As this does not seem to be a TS issue, can you provide a working example that doesn't use TypeScript and is as simple as you can make it. For example, rather than having `...Object.keys(StyleParameters)` you should just write the schema as a simple object literal.","createdAt":"2024-09-28T11:41:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2494#issuecomment-2380612016","viewerDidAuthor":false}],"createdAt":"2024-09-09T17:42:47Z","labels":[{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2494,"title":"removeAdditional not workig as expected"},{"body":"\r\nThere is already an issue for this , https://github.com/ajv-validator/ajv/issues/2318, but it is closed. Suggestion there is not working when ajv is XX-layers down like eg: [async-parser](https://github.com/asyncapi/parser-js) -> [@stoplight/spectral](https://github.com/stoplightio/spectral)->ajv and dynamic schema is validated, there is not visible to generate and pass validation function all the way down.\r\n\r\n\r\n\r\n**The version of Ajv you are using**\r\nlatest\r\n\r\n**The environment you have the problem with**\r\ncloudflare worker\r\n\r\n**Your code (please make it as small as possible to reproduce the issue)**\r\nstandard example from async-parser [Example](https://github.com/asyncapi/parser-js?tab=readme-ov-file#example-with-parsing)\r\n\r\nWorks in every browser and node env, except of cloudflare worker. \r\n\r\n**Results and error messages in your platform**\r\n```\r\n Code generation from strings disallowed for this context\r\n\r\n      at new Function (<anonymous>)\r\n      at m.f\r\n```\r\n\r\nIf there is no way to drop `new Function` usage in general, maybe it could be made conditional? let's say if `option.workerSafe` is passed as true, do something worker safe instead of new function? \r\n","comments":[{"id":"IC_kwDOAiQBJM6JmaHh","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"I see, so the use of AJV within other projects preclude those projects from being used in cloudflare. I wonder if it would be possible for those projects to pre-build any schema based validations functions so that their code can be run on cloudflare? It won't always be possible but not out of the question depending on the usage.\r\n\r\nI say this because given how AJV works I can't think of a way to avoid using `new Function`. Also worth noting, just in case it was a concern, that while `new Function` is considered unsafe and not allowed on cloudflare, the way that AJV uses it is very safe and has been verified by many experts. Anything passed to `new Function` has had to go through the typesafe codegen package which protects against any injection attacks etc.\r\n\r\nAnyway, I am open to ideas but afaik we couldn't stop using `new Function`.","createdAt":"2024-08-24T21:38:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2308547041","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Jmbbx","author":{"login":"adamdehaven"},"authorAssociation":"NONE","body":"> I wonder if it would be possible for those projects to pre-build any schema based validations functions so that their code can be run on cloudflare?\r\n\r\nNo, since the source files are fetched at runtime, thereâ€™s bo way to pre-build. ","createdAt":"2024-08-24T22:01:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2308552433","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6KmNdv","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"I see. Well I will leave this open. If anyone has any ideas on how to work around this or any proposals, we can discuss it.","createdAt":"2024-09-02T20:24:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2325272431","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Ltkbc","author":{"login":"Justineo"},"authorAssociation":"NONE","body":"As Cloudflare doesn't allow `eval` or `new Function` for security reasons, it may someday support ShadowRealm API if it gets approved by TC39 (it's currently in [Stage 2.7](https://github.com/tc39/proposals?tab=readme-ov-file#stage-27) and [Bun already supported it](https://x.com/jarredsumner/status/1497351968112607234)). At that time ajv should be able to migrate to the new API to make it work on edge runtimes.","createdAt":"2024-09-11T15:21:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2343978716","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6N5Pie","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Thanks for the info @Justineo, I will keep an eye out for that.","createdAt":"2024-09-28T10:18:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2380593310","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6gbOPk","author":{"login":"ama-coder"},"authorAssociation":"NONE","body":"is there anyway to workaround this and make Ajv run on edge just for now?","createdAt":"2025-02-28T20:27:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-2691490788","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM7dPkk1","author":{"login":"cmsparks"},"authorAssociation":"NONE","body":"BTW there's a workaround for this: https://developers.cloudflare.com/workers/configuration/compatibility-flags/#enable-eval-during-startup\n\nAs long as you only compile during script startup, AJV is functional on Cloudflare Workers.","createdAt":"2026-01-05T19:42:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2491#issuecomment-3711846709","viewerDidAuthor":false}],"createdAt":"2024-08-22T17:37:55Z","labels":[{"id":"MDU6TGFiZWw0MjMzOTM2NzU=","name":"compatibility","description":"","color":"4121BE"}],"number":2491,"title":"Allow it to work on edge (e.g. cloudflare workers)"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\nCode sandbox: https://codesandbox.io/s/ajv-playground-forked-nz924l?file=/src/index.js\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\nLatest 8.17.1\r\n\r\n**Ajv options object**\r\n\r\nEmpty (no options)\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n  \"type\": \"object\",\r\n  \"properties\": {\r\n    \"name\": {\r\n      \"type\": \"string\"\r\n    },\r\n    \"link\": {\r\n      \"type\": \"boolean\"\r\n    }\r\n  },\r\n  \"required\": [\"name\"],\r\n  \"unevaluatedProperties\": false,\r\n  \"dependentSchemas\": {\r\n    \"link\": {\r\n      \"if\": {\r\n        \"properties\": {\r\n          \"link\": {\r\n            \"const\": true\r\n          }\r\n        }\r\n      },\r\n      \"then\": {\r\n        \"properties\": {\r\n          \"originalId\": {\r\n            \"type\": \"string\"\r\n          }\r\n        },\r\n        \"required\": [\"originalId\"]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n  \"name\": \"test\"\r\n}\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\nconst Ajv2020 = require(\"ajv/dist/2020\");\r\nconst ajv = new Ajv2020();\r\n\r\nconst schema = require(\"./schema.json\");\r\nconst validate = ajv.compile(schema);\r\n\r\nconst valid = validate({\r\n  name: \"test\"\r\n});\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```json\r\n{\r\n  \"instancePath\": \"\",\r\n  \"schemaPath\": \"#/unevaluatedProperties\",\r\n  \"keyword\": \"unevaluatedProperties\",\r\n  \"params\": {\r\n    \"unevaluatedProperty\": \"name\"\r\n  },\r\n  \"message\": \"must NOT have unevaluated properties\"\r\n}\r\n```\r\n\r\n**What results did you expect?**\r\n\r\nIf I understand the JSON Schema specification around `unevaluatedProperties` and sub-schemas applied conditionally, the validation should pass with no errors given that `name` is defined in `properties` adjacent to `unevaluatedProperties` and it is present in the data instance.\r\n\r\nInterestingly, the same example passes validation in https://www.jsonschemavalidator.net\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nLooking for clarification/analysis from maintainers or those who are well-versed in latest JSON Schema specifications.","comments":[{"id":"IC_kwDOAiQBJM6HGqW2","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"After looking at this issue for a while now I have to agree it does look like a bug. I have created this [runkit example](https://runkit.com/jasoniangreen/66ae040c5863d40008247edd) for convenience. \r\nIt does seem that `dependantSchema` is interfering with `name` being considered an evaluated property because if I (a) remove `dependentSchemas` or (b) use another keyword like `allOf` to do any other processing this passes.\r\n\r\nI will try and look into the `dependentSchemas` keyword to see if I can understand what's happening.","createdAt":"2024-08-03T10:39:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2483#issuecomment-2266670518","viewerDidAuthor":false}],"createdAt":"2024-08-01T15:02:30Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTE=","name":"bug","description":"","color":"fc2929"}],"number":2483,"title":"Unexpected behaviour of unevaluatedProperties when used with dependentSchemas"},{"body":"**What version of Ajv you are you using?**\r\n8.17.1\r\n\r\n**What problem do you want to solve?**\r\nTracking down invalid regex.\r\n\r\n**What do you think is the correct solution to problem?**\r\nAn invalid regex in the schema (in my case `^[0-9]{2-4}`) throws an error without any indication where in the schema or what pattern failed. When you have a large schema this makes it difficult to track down exactly where the bad pattern is. There's a [todo in the code](https://github.com/ajv-validator/ajv/blob/9050ba1359fb87cd7c143f3c79513ea7624ea443/lib/vocabularies/validation/pattern.ts#L21) about this.\r\n\r\nThis can be somewhat mitigated by use the `regExp` option.\r\n\r\n```\r\nnew Ajv({\r\n  code: {\r\n    regExp: (pattern: string, u: string) => {\r\n      try {\r\n        return new RegExp(pattern, u)\r\n      } catch (e) {\r\n        console.error('Bad RegExp: ', pattern, e)\r\n      }\r\n    },\r\n  }\r\n})\r\n```\r\n\r\nHowever this only displays the bad pattern not where in the schema it's used.\r\n\r\n**Will you be able to implement it?**\r\nNo.\r\n","comments":[{"id":"IC_kwDOAiQBJM6Fm241","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Hi @RedHatter, you are right, it's not very helpful in this situation. Thanks for sharing the mitigating approach. I will try and raise it with the author sometime but there are other priorities at the moment, though I am curious why it wasn't just wrapped at the time. There might be some good reason why not.\r\n\r\nI'll keep an eye on this issue too to see how requested a change in this area is.","createdAt":"2024-07-21T10:17:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2241556021","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6FnQJt","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"I'll try and find time to fit in a fix on this but have other priorities so I'm also happy to review a PR by someone else.","createdAt":"2024-07-21T15:15:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2241659501","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6GM496","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Sorry @RedHatter but I want to check something. You said that the existing error doesn't show you the failing `pattern` but I get an error message like this:\r\n```\r\nSyntaxError: Invalid regular expression: /^[0-9]{2-4}/: Incomplete quantifier\r\n```","createdAt":"2024-07-25T22:48:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2251526010","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6GM-Rb","author":{"login":"RedHatter"},"authorAssociation":"NONE","body":"The exact error message I got was\r\n```\r\nUncaught SyntaxError: incomplete quantifier in regular expression\r\n```\r\nNote that this was in firefox. I didn't check the error message in any other browsers at the time.","createdAt":"2024-07-25T23:09:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2251547739","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6GYwEc","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Ah I see. It seems in node (at least version 18) you get a more useful message that includes the expression. I'll still keep it in mind because we could include the json schema path of the expression.","createdAt":"2024-07-28T20:27:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2254635292","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6MHpyn","author":{"login":"dragonfleas"},"authorAssociation":"NONE","body":"> **What version of Ajv you are you using?** 8.17.1\r\n> \r\n> **What problem do you want to solve?** Tracking down invalid regex.\r\n> \r\n> **What do you think is the correct solution to problem?** An invalid regex in the schema (in my case `^[0-9]{2-4}`) throws an error without any indication where in the schema or what pattern failed. When you have a large schema this makes it difficult to track down exactly where the bad pattern is. There's a [todo in the code](https://github.com/ajv-validator/ajv/blob/9050ba1359fb87cd7c143f3c79513ea7624ea443/lib/vocabularies/validation/pattern.ts#L21) about this.\r\n> \r\n> This can be somewhat mitigated by use the `regExp` option.\r\n> \r\n> ```\r\n> new Ajv({\r\n>   code: {\r\n>     regExp: (pattern: string, u: string) => {\r\n>       try {\r\n>         return new RegExp(pattern, u)\r\n>       } catch (e) {\r\n>         console.error('Bad RegExp: ', pattern, e)\r\n>       }\r\n>     },\r\n>   }\r\n> })\r\n> ```\r\n> \r\n> However this only displays the bad pattern not where in the schema it's used.\r\n> \r\n> **Will you be able to implement it?** No.\r\n\r\nNo idea how you're doing this. This actually gives me a type error.\r\n```\r\nProperty 'code' is missing in type '(pattern: string, u: string) => RegExp | undefined' but required in type 'RegExpEngine'.\r\n```","createdAt":"2024-09-14T03:44:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2477#issuecomment-2350816423","viewerDidAuthor":false}],"createdAt":"2024-07-19T21:18:35Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2477,"title":"`regexp` should be wrapped in try/catchs"},{"body":"Hello , I m using AJV Compiler to validate JSON Data against a defined Schemas , and I m using Literal or Enum to allow only a specific Values :  \r\n```\r\ncomparator:\r\n       \"strictly-greater\" | \"strictly-lower\"  | \"greater-or-equal\" |\"lower-or-equal\" ;\r\n```\r\nHowever , during validation the compiler doesn't show all allowed values , it only shows : \r\n\r\n```\r\nmessage: \"must be equal to constant\"\r\nâ€‹â€‹\r\nparams: Object { allowedValue: \"strictly-greater\" }\r\n```\r\nCan anyone assist on that , is it related to my validation logic or the AJV Compiler does catch errros for enum or literal values only for the first value ?! ","comments":[{"id":"IC_kwDOAiQBJM6FcwiA","author":{"login":"Meriyemelhajoui"},"authorAssociation":"NONE","body":"@epoberezkin","createdAt":"2024-07-19T11:02:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2475#issuecomment-2238908544","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Fm1Xq","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Hi @Meriyemelhajoui can you please provide as simple an example as possible using [Runkit](https://runkit.com/jasoniangreen/ajv-issue) (it is limited to v8.12.0 but should be good for most issues). The simpler you can make the example the better the chance I have of understanding and investigating.","createdAt":"2024-07-21T09:56:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2475#issuecomment-2241549802","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6FqyHQ","author":{"login":"Meriyemelhajoui"},"authorAssociation":"NONE","body":"Given this example of schema that requires that the user should enter a specific value for a field : \r\n`address : \"address1\"  | \"address2\"  | \"address3\", `\r\nWhich is basically an enum values where the allowed values are address1 or address2 or address3. \r\nWhile trying to validate User input against my defined schema , the AJV Compiler , catch the error if the user enter a value for address like : \"address100\" , but the provided error catched doesn't provide enough information such as : the value for address should be one of these allowed values : address1 , address2 or address3 . Until I have defined the property address as an enum value , then it can catch the error as it should be , which means that define enums as literals doesn't really give a clear error information while catching the error ","createdAt":"2024-07-22T10:08:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2475#issuecomment-2242585040","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6GMlYH","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"This syntax `address : \"address1\"  | \"address2\"  | \"address3\"` is typescript, isn't it, not JSON Schema? You'll really need to provide an example in runkit so I can properly investigate.","createdAt":"2024-07-25T21:42:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2475#issuecomment-2251445767","viewerDidAuthor":false}],"createdAt":"2024-07-18T11:15:03Z","labels":[{"id":"MDU6TGFiZWwxMDU0MDgyMjAz","name":"missing info","description":"","color":"5319e7"},{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2475,"title":"Catch Enum Errors value "},{"body":"I manage to implement my own coercion rules. The values are correctly coerced. However, I have to define in the schema all the types that may be coerced or an error is thrown by [`reportTypeError`](https://github.com/ajv-validator/ajv/blob/master/lib/compile/validate/dataType.ts#L49). Here is how I format the error in [Nikita](https://nikita.js.org/):\r\n\r\n```\r\nError: NIKITA_SCHEMA_VALIDATION_CONFIG: one error was found in the configuration of root action: #/definitions/config/properties/from_string/type config/from_string must be number, type is [\"number\"].\r\n```\r\n\r\nPlease provide us a way to disable calling `reportTypeError`. For information, this issue has bugged me (and my libraries) for years and is related to issue #1437.\r\n","comments":[{"id":"IC_kwDOAiQBJM6CLG6j","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Can you provide a code sample, if possible in [runkit](https://runkit.com/jasoniangreen/ajv-issue)?","createdAt":"2024-06-22T08:50:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2363#issuecomment-2183949987","viewerDidAuthor":false}],"createdAt":"2024-01-02T17:02:05Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2363,"title":"Disable reportTypeError to enable users to implement their own coercion rule"},{"body":"\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.12.0\r\n\r\n**Ajv options object**\r\n\r\nnone\r\n\r\n**Your code**\r\n\r\n```javascript\r\ntype AB = 'a' | 'b'\r\nconst s1 = { enum: ['a', 'b'] } as const\r\nconst enum1: JTDSchemaType<AB> = s1\r\n// error: The type 'readonly [\"a\", \"b\"]' is 'readonly' and cannot be assigned to the mutable type 'AB[]'.\r\n```\r\n\r\n**What results did you expect?**\r\n\r\nAssignment should be possible.\r\n\r\n**Are you going to resolve the issue?**\r\nI can prepare a PR","comments":[{"id":"IC_kwDOAiQBJM5xBdOe","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"This is not something that is easy (or maybe even possible) to improve given typescript type system limitations.","createdAt":"2024-01-17T16:50:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2358#issuecomment-1896207262","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5xDCK6","author":{"login":""},"authorAssociation":"NONE","body":"Did you see https://github.com/ajv-validator/ajv/pull/2359? ","createdAt":"2024-01-17T20:15:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2358#issuecomment-1896620730","viewerDidAuthor":false}],"createdAt":"2023-12-20T18:34:37Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2358,"title":"JTDSchemaType derivation for enums is too strict"},{"body":"\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\najv-cli@5.0.0\r\n\r\n\r\n\r\nThe docs say:\r\n\r\n> pass the --code-esm (CLI) flag if you want ESM exported code.\r\n\r\nBut when I do this:\r\n\r\n```\r\najv compile -s numeric.json --code-esm -o validate_schema.js\r\n```\r\n\r\nIt gives this error:\r\n\r\n```\r\nerror: parameter --code-esm is unknown\r\n```\r\n\r\nIndeed, in `ajv help compile`, there is no option listed for `--code.esm`. So, the documentation here is incorrect: https://ajv.js.org/standalone.html\r\n\r\n\r\nMaybe related to #2209 -- is ESM module generation not working, and so the CLI option has been removed?","comments":[{"id":"IC_kwDOAiQBJM6CK9ed","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"It looks like this option is simply not supported, but I can see a promising PR that adds it in. I will follow up.\r\nhttps://github.com/ajv-validator/ajv-cli/pull/200\r\n\r\nThis will either be an enhancement or it's just that the docs are wrong.","createdAt":"2024-06-22T08:10:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2354#issuecomment-2183911325","viewerDidAuthor":false}],"createdAt":"2023-12-14T18:47:04Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"},{"id":"MDU6TGFiZWw3MDE1NzYyMzg=","name":"docs","description":"","color":"c2e0c6"}],"number":2354,"title":"Standalone esm option `--code-esm` is not recognized"},{"body":"Hello Team,\r\n\r\nRequesting you to please check this issue and help. Performing schema validation with oneOf, discriminator and mapping property in oas3.0.\r\n\r\n_**Error:**_\r\n{\r\n\"fault\": {\r\n\"faultstring\": \"OASValidation MAM-EXT-SpecValidation with resource \"oas://openapi.yaml\": failed with reason: \"[ERROR - An error occurred during schema validation - com.google.common.util.concurrent.UncheckedExecutionException: java.lang.NullPointerException.: []]\"\",\r\n\"detail\": {\r\n\"errorcode\": \"steps.oasvalidation.Failed\"\r\n}\r\n}\r\n}\r\n\r\n\r\n**_yaml file looks like:_**\r\n![image](https://github.com/ajv-validator/ajv/assets/96113675/24675a05-6763-45f7-b689-eab3265d59b9)\r\n\r\n![image](https://github.com/ajv-validator/ajv/assets/96113675/9664cd69-4743-451e-8fe3-b7af03196535)\r\n\r\n**_json payload looks like:_**\r\n\r\n--data '{ \"billableHeader\": { \"sourceSystem\": \"UPSTREAM_APP\", \"sourceTransactionType\": \"INVOICE\", \"eventType\": \"BATCH\", \"messageCreationDatetime\": \"20220811140203\", \"timeZoneCode\": \"GMT\", \"isBulkProcessing\": true, \"product\": \"Airlcl\" },","comments":[{"id":"IC_kwDOAiQBJM5tSIqT","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"According to the docs, mapping is not supported: https://ajv.js.org/json-schema.html#discriminator.\r\n\r\nIt's unclear clear why that's the case. If the author is open to a PR perhaps you could add the feature?","createdAt":"2023-11-30T10:17:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1833470611","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5tSKiq","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"It looks like somebody has already attempted that: https://github.com/ajv-validator/ajv/pull/2262/files","createdAt":"2023-11-30T10:22:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1833478314","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5tSn_g","author":{"login":"RPS044"},"authorAssociation":"NONE","body":"@mefellows then only with **oneOf with discriminator** is possible?","createdAt":"2023-11-30T11:38:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1833598944","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5tWWL5","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"I don't think mapping is supported at all.","createdAt":"2023-11-30T21:17:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1834574585","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5tZ3BI","author":{"login":"RPS044"},"authorAssociation":"NONE","body":"@mefellows  alternated is then using extract policy validation?","createdAt":"2023-12-01T05:35:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1835495496","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5tfNbE","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"I'm not sure what that means, sorry, but to work around it you can _not_ using the mapping. See https://swagger.io/specification/v3/#discriminator-object for how it works without mapping.","createdAt":"2023-12-01T23:09:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1836897988","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5xBfqS","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"OpenAPI defines discriminator as tooling support and no-op from validation point of view - actual validation happens as defined in oneOf. Mapping may lead to contradictory schema, so is not supported. You can add it as a custom keyword to be ignored and allowed in schemas. Also, you have to use discriminator option.","createdAt":"2024-01-17T16:56:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1896217234","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5xOK7w","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"Thanks for your response @epoberezkin!\r\n\r\nI'm still a little confused as to why we wouldn't want to support this feature. I appreciate it's not currently supported and it's a limitation (as you had documented already).\r\n\r\n> OpenAPI defines discriminator as tooling support and no-op from validation point of view - actual validation happens as defined in oneOf\r\n\r\nThat's not how I read the spec: https://spec.openapis.org/oas/v3.0.3#discriminator-object. I'm not all that familiar with spec reading and interpretation, so perhaps I'm mistaken. Or should I be looking at the JSON Schema dialect for this?\r\n\r\n>Mapping may lead to contradictory schema, so is not supported. \r\n\r\nIs this something `ajv` must consider in features? Isn't it already possible to create contradictory schemas without `mapping` already? For example the following is illogical:\r\n\r\n```\r\n{\r\n  \"allOf\": [\r\n    { \"type\": \"string\" },\r\n    { \"type\": \"number\" }\r\n  ]\r\n}\r\n\r\n```\r\n\r\n> You can add it as a custom keyword to be ignored and allowed in schemas. Also, you have to use discriminator option.\r\n\r\nThis will have the effect of ignoring the mapping, correct? I'm looking for a solution that would include incorporating the entire mapping and discriminator vocabulary into the parsing of the document. If you know of a workaround, I would be very grateful to hear of it.","createdAt":"2024-01-19T02:25:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2349#issuecomment-1899540208","viewerDidAuthor":false}],"createdAt":"2023-11-29T16:00:50Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"}],"number":2349,"title":"OneOf property is failing during OAS  Schema Validation"},{"body":"\r\n**The version of Ajv you are using**\r\n\r\n\"ajv\": \"^8.10.0\",\r\n\r\n**The environment you have the problem with**\r\n\r\nWindows\r\n\r\nWhen I am using compileSerializer it is reffering different ways in different os\r\n\r\nLike windows it is adding \\r\\n and in ubuntu it is adding \\n when adding a new line.\r\n\r\nHow to fix it?\r\n\r\n","comments":[],"createdAt":"2023-11-09T12:38:48Z","labels":[{"id":"MDU6TGFiZWw0MjMzOTM2NzU=","name":"compatibility","description":"","color":"4121BE"}],"number":2344,"title":"Adding \\r\\n while serializing in Windows and \\n while serializing in Ubuntu"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n## What version of Ajv are you using?\r\n8.11.2\r\n\r\n## What problem do you want to solve?\r\nI need to validate one JSON schema against another to ensure they map onto each other based on their description. I'll be using one schema for output of a process and another for input into another process in my system, which would necessitate a validation check to ensure they align correctly.\r\n\r\n_Note: I considered the idea of doing it dynamically (i.e. checking against the actual output of the process, instead of the schemas). However, I need to detect a possible mismatch before any processing happens._\r\n\r\n## What do you think is the correct solution to the problem?\r\nImplementing a Schema Mapping Validation feature between JSON schemas could do it. For instance:\r\n1. A `string` schema `A` maps onto a `string` schema `B` if it meets the length and pattern requirements of `B`.\r\n2. An `object` schema `A` fits onto `object` schema `B` if it encompasses at least the same `required` properties as `B`.\r\n3. A `null` schema `A` maps onto any schema `B` if `B` also includes `null` as an allowable type.\r\n\r\n## Will you be able to implement it?\r\nI might be able to implement it, although I am unsure about the complexity within the library's framework. However, I am certainly willing to give it a shot!\r\n","comments":[],"createdAt":"2023-10-17T09:36:38Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2338,"title":"Schema Mapping Validation Between JSON Schemas"},{"body":"Can you support graphql based on the `schema.graphql` or `introspectionSchema.json`?\r\nThey can be usually downloaded from the graphQL playground.\r\n<img width=\"773\" alt=\"Screenshot 2023-10-17 at 5 15 04â€¯pm\" src=\"https://github.com/ajv-validator/ajv/assets/146694518/abbf2c13-9bd6-4dd4-a3d0-dc063b30c524\">\r\n","comments":[],"createdAt":"2023-10-17T06:16:48Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2337,"title":"Support for graphQL schema.graphql or introspectionSchema.json"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv you are you using?**\r\n\r\nv8.12.0\r\n\r\n**What problem do you want to solve?**\r\n\r\nCurrently AJV doesn't support the `coerceTypes` option when using JSON type definitions. When you import from `ajv/dist/jdt` and try to pass `coerceTypes` to the constructor you get a \"not assignable to undefined\" type error.\r\n\r\n![image](https://github.com/ajv-validator/ajv/assets/31548851/0779cf5d-087f-4c81-adb2-fd234ebf3f8f)\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nI think it would be good to implement support for this since it is already supported when using JSON schemas. A simple use case is coercing the values from url query parameters.\r\n\r\n**Will you be able to implement it?**\r\n\r\nProbably not.","comments":[],"createdAt":"2023-09-19T18:14:15Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2328,"title":"Coercion support for JTD"},{"body":"**What version of Ajv you are you using?**\r\nv8.12\r\n\r\n**What problem do you want to solve?**\r\nValidate messages with dynamic subschemas.\r\n\r\nOur systems process many different kinds of event with different schemas. However, all the events are packaged into a single envelope. Roughly, the envelope looks like this:\r\n\r\n```jsonc\r\n{  // envelope\r\n  \"payload\" : {  // payload\r\n    // the actual event data is in here\r\n  },\r\n  \"payloadSchema\": \"\", // this is the $id of the payload's expected schema\r\n  // additional envelope data like timestamps, source system, etc\r\n}\r\n```\r\n\r\nWe want to be able to validate the entire event (both the envelope and payload) in one shot. Right now, we have to validate the event stages. First we validate the envelope, then the code validates `payload` using the schema indicated in `payloadSchema`\r\n\r\nIn addition, a subset of the events also have nested payload, which requires \r\n\r\n```jsonc\r\n{  // envelope\r\n  \"payload\" : {  // payload for a \"run\" event\r\n     \"data\" : { // run data \r\n      },\r\n     \"dataSchema\" : \"\" // this is the $id of the run data's expected schema\r\n      // additional run data like runId, user, etc\r\n  },\r\n  \"payloadSchema\": \"\", // this is the $id of the payload's expected schema\r\n  // additional envelope data like timestamps, source system, etc\r\n}\r\n```\r\n\r\nI wanted to use the $data keyword to write a schema\r\n\r\n```jsonc\r\n{  // envelope schema\r\n  \"type\" : \"object\"\r\n  \"payload\" : { \r\n    \"$ref\" :  {\r\n      \"$data\" : \"/payloadSchema\" // JSONPointer to the payloadSchema property\r\n    },\r\n  },\r\n  \"payloadSchema\": {\r\n    \"type\", \"string\"\r\n  }\r\n}\r\n```\r\n\r\nFor the run schema\r\n\r\n```jsonc\r\n{  // run schema\r\n  \"type\" : \"object\"\r\n  \"data\" : { \r\n    \"$ref\" :  {\r\n      \"$data\" : \"/dataSchema\" // JSONPointer to the dataSchema property\r\n      },\r\n  },\r\n  \"dataSchema\": {\r\n    \"type\", \"string\"\r\n  }\r\n}\r\n```\r\n\r\nHowever, the `$ref` keyword does not currently support `$data`.\r\n\r\n**What do you think is the correct solution to problem?**\r\nSupport usage of `$data` in `$ref` keyword.\r\n\r\n**Will you be able to implement it?**\r\nWe have resources to implement but need guidance. I've looked over the code, but unsure where to start.","comments":[],"createdAt":"2023-07-28T17:55:03Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2314,"title":"Support $data keyword in $ref"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\n\r\nThis template is for issues about missing or incorrect type definition and other typescript-related issues.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.12.0\r\n\r\n**Your typescript code**\r\n\r\n<!--\r\nPlease make it as small as possible to reproduce the issue\r\n-->\r\n\r\n```typescript\r\nimport type { JSONSchemaType } from \"ajv\";\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\n\r\nHello everyone! First of all, thanks to all the maintainers for your contribution!\r\n\r\nI would just like to know why ajv contains its own definitions for JSON Schema. JSON Schema is a Standard, so its types should be the same in different applications. Common types would help to glue different packages. It may look like this:\r\n\r\n```typescript\r\nimport Ajv from \"ajv\";\r\nimport schemaBuilder from \"some-schema-builder-package\";\r\n\r\nimport type { JSONSchemaType } from \"some-common-schema-package\";\r\n\r\nconst ajv = new Ajv();\r\n\r\nconst mySchema: JSONSchemaType<MyEntity> = schemaBuilder<MyEntity>(/* ... */);\r\nconst validate = ajv.compile(mySchema);\r\n```\r\n\r\nBut now I have to redefine package typings to make types from ajv and different packages \"match\" to each other.\r\n\r\nOn the [json-schema.org website](https://json-schema.org/implementations.html#from-code) I found [typescript-json-schema package](https://github.com/YousefED/typescript-json-schema/blob/v0.59.0/package.json#L44), which imports types from [@types/json-schema](https://www.npmjs.com/package/@types/json-schema) package.\r\n\r\nWhy doesn't ajv use `@types/json-schema` package?\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nApparently, this is an ideological issue, so Iâ€™m not able to solve it.\r\n","comments":[{"id":"IC_kwDOAiQBJM6GT1oO","author":{"login":"heath-freenome"},"authorAssociation":"NONE","body":"@isqua From what I can tell `@types/json-schema` only goes up to JSON Schema version 7. There are two more version since then, which AJV supports. I have already created an [issue](https://github.com/ajv-validator/ajv/issues/2129) to at least export their types to a separate, installable package.","createdAt":"2024-07-26T19:31:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/ajv-validator/ajv/issues/2312#issuecomment-2253347342","viewerDidAuthor":false}],"createdAt":"2023-07-25T21:39:25Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2312,"title":"Why does AJV contain its own types for JSON Schema instead of using an external package"},{"body":"**What version of Ajv you are you using?**\r\nv8\r\n\r\n**What problem do you want to solve?**\r\nI want the `compileParser` function to be smarter (including `compileSerializer` too)\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nAdding the following overload to the function:\r\n```\r\ncompileParser<R = unknown, T = JTDDataType<R>>(schema: R): JTDParser<T>;\r\n```\r\n\r\n**Will you be able to implement it?**\r\nMaybe, I leave for vacation July 22nd-Aug 15th. I may be able to get a PR done today/tomorrow, but won't be available until after Aug 15th to complete it.\r\n","comments":[],"createdAt":"2023-07-20T20:16:04Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2309,"title":"Smart compile functions using `JTDDataType`"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports. For other issues please use:\r\n- security vulnerability: https://tidelift.com/security)\r\n- a new feature/improvement: https://ajv.js.org/contributing/#changes\r\n- browser/compatibility issues: https://ajv.js.org/contributing/#compatibility\r\n- JSON-Schema standard: https://ajv.js.org/contributing/#json-schema\r\n- Ajv usage questions: https://gitter.im/ajv-validator/ajv\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nAjv Version:8.12.0\r\n**Ajv options object**\r\nconst ajv = new Ajv({useDefaults: true, strict: false})\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\n\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n  \"type\": \"object\",\r\n  \"properties\": {\r\n    \"foo\": {\r\n      \"type\": \"number\",\r\n      \"default\": 5\r\n    },\r\n    \"yyy\": {\r\n      \"type\": \"array\",\r\n      \"items\": [\r\n        {\r\n          \"type\": \"object\",\r\n          \"default\": {\r\n            \"xyz\": \"testValue\",\r\n            \"ssms\": [\r\n              5\r\n            ]\r\n          },\r\n          \"properties\": {\r\n            \"ssms\": {\r\n              \"type\": \"array\",\r\n              \"items\": [\r\n                {\r\n                  \"type\": \"array\",\r\n                  \"default\": [\r\n                    2\r\n                  ]\r\n                },\r\n                {\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"type\": \"string\",\r\n                  \"default\": \"abcdef\"\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    },\r\n    \"bar\": {\r\n      \"type\": \"object\",\r\n      \"default\": {\r\n        \"abc\": \"abc-outer\"\r\n      },\r\n      \"properties\": {\r\n        \"efg\": {\r\n          \"type\": \"number\",\r\n          \"default\": 88\r\n        }\r\n      }\r\n    },\r\n    \"prop1\": {\r\n      \"type\": \"array\",\r\n      \"default\": [],\r\n      \"items\": [\r\n        {\r\n          \"type\": \"array\",\r\n          \"default\": [\r\n            5\r\n          ],\r\n          \"items\": {\r\n            \"type\": \"number\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n//input for first test case\r\n{\r\n  \"foo\": 6\r\n}\r\n```\r\n```json\r\n//input for second test case\r\n\r\n{\r\n  \"foo\": 6,\r\n  \"yyy\":[]\r\n}\r\n```\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\nconst ajv = new Ajv({useDefaults: true, strict: false})\r\nconst validate = ajv.compile(schema)\r\nconsole.log(JSON.stringify(data))\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n{\"foo\":6,\"bar\":{\"abc\":\"abc-outer\",\"efg\":88},\"prop1\":[[5]]}-- Output for first test case\r\n{\"foo\":6,\"yyy\":[{\"xyz\":\"testValue\",\"ssms\":[5,null,\"abcdef\"]}],\"bar\":{\"abc\":\"abc-outer\"},\"prop1\":[]}--output for second test case\r\n```\r\n\r\n**What results did you expect?**\r\n{\"foo\":6,\"bar\":{\"abc\":\"abc-outer\",\"efg\":88},\"prop1\":[[5]]}-- Output for first test case is fine and works as expected\r\n{\"foo\":6,\"yyy\":[{\"xyz\":\"testValue\",\"ssms\":[5,null,\"abcdef\"]}],\"bar\":{\"abc\":\"abc-outer\",\"efg\":88},\"prop1\":[[5]]} -- This is what i expected for second test case.\r\nThe output for first test case is as expected but the output for second test case is not expected. I was expecting \r\n{\"foo\":6,\"yyy\":[{\"xyz\":\"testValue\",\"ssms\":[5,null,\"abcdef\"]}],\"bar\":{\"abc\":\"abc-outer\",\"efg\":88},\"prop1\":[[5]]}\r\nwhy does the output for  \"bar\"  and \"prop1\"  change when an empty array is provided for a different field (yyy) \r\n**Are you going to resolve the issue?**\r\n","comments":[],"createdAt":"2023-07-05T06:25:32Z","labels":[],"number":2304,"title":"useDefaults option produces incorrect result with different inputs"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nUsed version: 8.12.0\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\nconst ajv = new Ajv({\r\n  schemas: {\r\n    'foo-schema': FooSchema\r\n  }\r\n})\r\n\r\n```\r\n\r\n**JSON Schema**\r\n\r\n\r\n```javascript\r\nconst FooSchema: JSONSchemaType<Foo> = {\r\n  $id: 'foo-schema',\r\n  type: \"object\",\r\n  properties: {foo: {type: \"number\"}},\r\n  required: [\"foo\"],\r\n  additionalProperties: false,\r\n}\r\n\r\n```\r\n\r\n**Sample data**\r\n\r\n```javascript\r\nconst foo = {\r\n  foo: true\r\n}\r\n\r\n```\r\n\r\n**Your code**\r\n\r\n```typescript\r\nimport Ajv, { JSONSchemaType } from 'ajv';\r\n\r\ninterface Foo {\r\n  foo: number\r\n}\r\n\r\ninterface Bar {\r\n  foo: boolean\r\n}\r\n\r\nconst foo: Bar = {\r\n  foo: true\r\n}\r\n\r\nconst FooSchema: JSONSchemaType<Foo> = {\r\n  $id: 'foo-schema',\r\n  type: \"object\",\r\n  properties: {foo: {type: \"number\"}},\r\n  required: [\"foo\"],\r\n  additionalProperties: false,\r\n}\r\n\r\nconst ajv = new Ajv({\r\n  schemas: {\r\n    'foo-schema': FooSchema\r\n  }\r\n})\r\n\r\n\r\n\r\nconst validate = ajv.getSchema<Foo>('foo-schema')\r\nif (!validate) {\r\n  throw new Error()\r\n}\r\n\r\nif (validate(foo)) {\r\n  console.log(foo) // [1]\r\n} else {\r\n  console.log(foo)\r\n}\r\n```\r\n\r\n**What results did you expect?**\r\nThere is a change in the way the `validate` function narrows the type of its parameter.\r\n\r\nUsing typescript until 5.0, the type of `foo` at the bookmark [1] in the above example, matches the type passed as a generic to the `getSchema` function.\r\n\r\nUsing typescript 5.1, the type of foo at the bookmark [1] does not change and stay `Bar`\r\n\r\nI have checked the Typescript Changelog but I have not found any lead on what might have changed\r\n\r\nHere is a [repo](https://github.com/Baptiste-Garcin/issue-ajv-typescript) with the minimal code to reproduce. If you switch the version of typescript between 5.0 and 5.1, you will notice the change in the narrowing behaviour line 37 of the Validator.ts file.\r\n\r\n**Are you going to resolve the issue?**\r\nI don't think I have the skills to do this but I will check ajv source code.","comments":[{"id":"IC_kwDOAiQBJM5vWpUl","author":{"login":"Dashron"},"authorAssociation":"NONE","body":"in case it helps, I came across this issue from a different angle and found some interesting behavior. I've got an example [here](https://github.com/Dashron/issue-ajv-typescript/tree/main) that works fine.\r\n\r\nKey differences:\r\n- I added `as const` to the `FooSchema`.\r\n- I use `compile`, not `getSchema`. I suspect the `as const` is lost somewhere inside of `getSchema`\r\n- I changed the `Bar` type to accept numbers or booleans, so that we can more easily see that the type guard is working\r\n\r\nNow the above example works great, and I hope many people stuck on this can use it to move forward. But in addition to `getSchema` not working, I'm finding `compile` doesn't consistently work. I created [a separate ticket](https://github.com/ajv-validator/ajv/issues/2360) for that, because my example seems different enough that these might be unrelated.","createdAt":"2023-12-23T05:02:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_DOWN","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2293#issuecomment-1868207397","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6XTHpv","author":{"login":"tamaroning"},"authorAssociation":"NONE","body":"any update on this?\r\nType guards always do not work when `getSchema` is used.","createdAt":"2024-12-12T09:38:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2293#issuecomment-2538371695","viewerDidAuthor":false}],"createdAt":"2023-06-20T14:41:12Z","labels":[{"id":"MDU6TGFiZWw0MjMzOTM2NzU=","name":"compatibility","description":"","color":"4121BE"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2293,"title":"Validate function narrowing behavior not working with typescript 5.1"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.12.0\r\n\r\n**Ajv options object**\r\n\r\nexport const ajv = new Ajv({ strict: true })\r\n\r\nI'm using Typescript\r\n\r\n```typescript\r\ninterface MyType {\r\n  id: string\r\n  value: string | null\r\n}\r\n\r\nconst MySchema: JSONSchemaType<MyType> = {\r\n  type: \"object\",\r\n  properties: {\r\n    id: { type: \"string\" },\r\n    value: { type: \"string\", nullable: true },\r\n  },\r\n}\r\nexport const validateMySchema = ajv.compile<MyType>(MySchema)\r\n```\r\n\r\nI'm getting this issue:\r\n\r\n```\r\nsrc/user/validation.ts:13:7 - error TS2322: Type '{ type: \"object\"; properties: { id: { type: \"string\"; }; value: { type: \"string\"; nullable: true; }; }; }' is not assignable to type 'JSONSchemaType<MyType>'.\r\n  The types of 'properties.value' are incompatible between these types.\r\n    Type '{ type: \"string\"; nullable: true; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<string | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ({ ...; } & ... 1 more ... & { ...; }) | ({ ...; } & ... 2...'.\r\n      Types of property 'nullable' are incompatible.\r\n        Type 'true' is not assignable to type 'false'.\r\n\r\n13 const MySchema: JSONSchemaType<MyType> = {\r\n```\r\n\r\nAlso adding null as type:\r\n\r\n```typescript\r\nconst MySchema: JSONSchemaType<MyType> = {\r\n  type: \"object\",\r\n  properties: {\r\n    id: { type: \"string\" },\r\n    value: { type: [\"string\", \"null\"], nullable: true },\r\n  },\r\n}\r\nexport const validateMySchema = ajv.compile<MyType>(MySchema)\r\n\r\n```\r\n\r\nI have the same error:\r\n\r\n```\r\nsrc/user/validation.ts:13:7 - error TS2322: Type '{ type: \"object\"; properties: { id: { type: \"string\"; }; value: { type: (\"string\" | \"null\")[]; nullable: true; }; }; }' is not assignable to type 'JSONSchemaType<MyType>'.\r\n  The types of 'properties.value' are incompatible between these types.\r\n    Type '{ type: (\"string\" | \"null\")[]; nullable: true; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<string | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ({ ...; } & ... 1 more ... & { ...; }) | ({ ...; } & ... 2...'.\r\n      Types of property 'nullable' are incompatible.\r\n        Type 'true' is not assignable to type 'false'.\r\n\r\n13 const MySchema: JSONSchemaType<MyType> = {\r\n```\r\n\r\nalso removing the `nullable`, same issue:\r\n\r\n```typescript\r\nconst MySchema: JSONSchemaType<MyType> = {\r\n  type: \"object\",\r\n  properties: {\r\n    id: { type: \"string\" },\r\n    value: { type: [\"string\", \"null\"] },\r\n  },\r\n}\r\nexport const validateMySchema = ajv.compile<MyType>(MySchema)\r\n```\r\n\r\n\r\n```\r\nType '{ type: \"object\"; properties: { id: { type: \"string\"; }; value: { type: (\"string\" | \"null\")[]; }; }; }' is not assignable to type 'JSONSchemaType<MyType>'.\r\n  The types of 'properties.value' are incompatible between these types.\r\n    Type '{ type: (\"string\" | \"null\")[]; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<string | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ({ ...; } & ... 1 more ... & { ...; }) | ({ ...; } & ... 2...'.\r\n      Type '{ type: (\"string\" | \"null\")[]; }' is not assignable to type '{ type: \"string\"; } & StringKeywords & { allOf?: readonly UncheckedPartialSchema<string | null>[] | undefined; anyOf?: readonly UncheckedPartialSchema<string | null>[] | undefined; ... 4 more ...; not?: UncheckedPartialSchema<...> | undefined; } & { ...; } & { ...; }'.\r\n        Type '{ type: (\"string\" | \"null\")[]; }' is not assignable to type '{ type: \"string\"; }'.\r\n          Types of property 'type' are incompatible.\r\n            Type '(\"string\" | \"null\")[]' is not assignable to type '\"string\"'.\r\n\r\n13 const MySchema: JSONSchemaType<MyType> = {\r\n\r\n```","comments":[{"id":"IC_kwDOAiQBJM5ivrJX","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"JSONSchemaType equates \"nullable\" to optional property definition, `string | null` is not supported (I think)\r\n\r\ncc @erikbrinkman am I right?","createdAt":"2023-07-29T09:08:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2283#issuecomment-1656664663","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5iwIpD","author":{"login":"erikbrinkman"},"authorAssociation":"COLLABORATOR","body":"Yes, for ajv 8, nullable actually means undefined not null. the v9 branch has a version of the schema capable of recognizing the difference that you can patch in if you want if you really want. Also note, that `JSONSchemaType` requires that you use the `required` keyword, which you probably want to specify in this case.\r\n\r\nSee:\r\nhttps://github.com/ajv-validator/ajv/blob/490eb8c0eba8392d071fef005e16d330f259d0ba/lib/types/json-schema.ts#L175-L187","createdAt":"2023-07-29T16:36:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2283#issuecomment-1656785475","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6FJxeP","author":{"login":"VasylCherniatin"},"authorAssociation":"NONE","body":"Guys, is it connected to the next error?\r\n\r\n`JSONSchemaCannotBeCompiledError: JSON schema for response: POST | https://mock.com/ | 200 is found, but cannot be used since AJV cannot compile schema. This is OpenApi spec issue. Got AJV error Error with message: \"nullable\" cannot be used without \"type\". Validation cannot be done`\r\n\r\nHere is a part of my schema, the main problem in Brand property validation\r\n![image](https://github.com/user-attachments/assets/2f1042c2-d44f-4fe3-b322-c159298acd02)\r\n\r\nBased on Swagger documentation, null is not allowed as a type value\r\n![image](https://github.com/user-attachments/assets/b9708204-b053-4303-bfb9-bf4c4c3ac7ef)\r\n![image](https://github.com/user-attachments/assets/ecb1bbc7-7ea9-490f-bb79-0d2285cfdf14)\r\n\r\nhttps://swagger.io/docs/specification/data-models/data-types/?sbsearch=nullable\r\n\r\nDo you plan to update your logic according specification?","createdAt":"2024-07-17T18:08:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2283#issuecomment-2233931663","viewerDidAuthor":false}],"createdAt":"2023-05-26T17:58:00Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw0MjMzOTA5NjY=","name":"usage","description":"","color":"1d76db"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2283,"title":"JSONSchemaType fails wiht type when a field is declared nullable"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.12.0\r\n\r\n**JSON Schema**\r\n\r\n```json\r\n{\r\n  \"type\": \"object\",\r\n  \"discriminator\": {\r\n    \"propertyName\": \"type\"\r\n  },\r\n  \"oneOf\": [\r\n    {\r\n      \"allOf\": [\r\n        {\r\n          \"$ref\": \"#/components/schemas/A\"\r\n        },\r\n        {\r\n          \"type\": \"object\",\r\n          \"required\": [\"type\"],\r\n          \"properties\": {\r\n            \"method\": {\r\n              \"type\": \"string\",\r\n              \"enum\": [\"a\"]\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"allOf\": [\r\n        {\r\n          \"$ref\": \"#/components/schemas/B\"\r\n        },\r\n        {\r\n          \"type\": \"object\",\r\n          \"required\": [\"type\"],\r\n          \"properties\": {\r\n            \"method\": {\r\n              \"type\": \"string\",\r\n              \"enum\": [\"b\"]\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nWhen accessing the schema from above, I get this error:\r\n`Error: discriminator: oneOf subschemas (or referenced schemas) must have \"properties/type\"`\r\n\r\nFor me this Schema seems to be valid, but there seems to be a problem with this nested oneOf / allOf structure. \r\nIs there a way to solve this, because I would like to stay with this Schema which is autogenerated from the backend.\r\n\r\n","comments":[{"id":"IC_kwDOAiQBJM5dJBn_","author":{"login":"codekie"},"authorAssociation":"NONE","body":"Looks like a duplicate of #2261 ","createdAt":"2023-05-25T10:14:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2281#issuecomment-1562647039","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5dJJG1","author":{"login":"wcloete"},"authorAssociation":"NONE","body":"You may need to add the definitions for `\"#/components/schemas/A\"` and `\"#/components/schemas/B\"` to your example, because currently there is no property named `type`. You have a property named `method`, was this a typo?","createdAt":"2023-05-25T10:38:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2281#issuecomment-1562677685","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5ivrvE","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Yes, it's a limitation, as documented. For it to work it should have discriminator tag property defined on the top level in subschema.","createdAt":"2023-07-29T09:09:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2281#issuecomment-1656667076","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM57Ypfn","author":{"login":"Grafikart"},"authorAssociation":"NONE","body":"I encountered the same limitation (thanks for explaining these limitations in the documentation) and I understand the complexity of solving this issue. \r\n\r\nCould it be possible to add an arbitrary property to discriminate ? \r\n\r\n```diff\r\n{\r\n  \"type\": \"object\",\r\n  \"discriminator\": {\r\n    \"propertyName\": \"type\"\r\n  },\r\n  \"oneOf\": [\r\n    {\r\n+     \"discriminatorValue\": [\"a\"],\r\n      \"allOf\": [\r\n        {\r\n          \"$ref\": \"#/components/schemas/A\"\r\n        },\r\n        {\r\n          \"type\": \"object\",\r\n          \"required\": [\"type\"],\r\n          \"properties\": {\r\n            \"method\": {\r\n              \"type\": \"string\",\r\n              \"enum\": [\"a\"]\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    },\r\n    {\r\n+     \"discriminatorValue\": [\"b\"],\r\n      \"allOf\": [\r\n        {\r\n          \"$ref\": \"#/components/schemas/B\"\r\n        },\r\n        {\r\n          \"type\": \"object\",\r\n          \"required\": [\"type\"],\r\n          \"properties\": {\r\n            \"method\": {\r\n              \"type\": \"string\",\r\n              \"enum\": [\"b\"]\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```","createdAt":"2024-04-22T16:09:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2281#issuecomment-2070058983","viewerDidAuthor":false}],"createdAt":"2023-05-23T12:22:48Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"}],"number":2281,"title":"Discriminator-Property not working in `allOf`"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv you are you using?**\r\n\r\n8.10.0\r\n\r\n**What problem do you want to solve?**\r\n\r\nAllow `if`/`then`/`else` validation failures to return more meta in the error to derive what the underlying failure condition was.\r\n\r\nHere's an example schema that validates if a `messageId` property exists, then `topic` should _not_ exist\r\n\r\n```js\r\n/* ... */\r\nallOf: [\r\n  {\r\n    if: {\r\n      anyOf: [\r\n        {\r\n          properties: {messageId: {}},\r\n        },\r\n      ],\r\n    },\r\n    then: {\r\n      properties: {\r\n        topic: {\r\n          not: {},\r\n        },\r\n      },\r\n    },\r\n  },\r\n]\r\n/* ... */\r\n```\r\n\r\nThe failure message for this error is as follows: \"Bad Request: data/topic must NOT be valid, data must match \"then\" schema\". The \"data must match \"then\" schema\" part is the problematic piece for us. We would like for ajv to return info so that we can populate something like \"If messageId exists, then topic must NOT exist\" (this is potentially an oversimplified error text given the complexities deriving it from the sub-schemas, but it hopefully conveys my point)\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nIt seems like the error string for `if`/`then`/`else` is defined [here](https://github.com/ajv-validator/ajv/blob/a27f78264ab1c3951d5131f27181d0a50e54aed0/lib/vocabularies/applicator/if.ts#L15), with meta [here](https://github.com/ajv-validator/ajv/blob/a27f78264ab1c3951d5131f27181d0a50e54aed0/lib/vocabularies/applicator/if.ts#L55-L56) that tells ajv to ignore subsequent errors. I have not dug deep enough into the code otherwise to know how best to pull out these errors, but my initial take:\r\n1. The error string should allow for returning more info other than what `if`/`then`/`else` schema errored. This could potentially be as simple as returning the `if` sub-schema for consumption in error population logic outside of ajv, though it's possible there are other patterns elsewhere in ajv that would make more sense to follow\r\n2. `allErrors` property should be configurable based on the top-level `allErrors` property passed to ajv in its constructor (that is, [this](https://ajv.js.org/options.html#allerrors))\r\n\r\n**Will you be able to implement it?**\r\n\r\nIf I can get direction and sign off on an approach to use, yes! I am not sure if what I proposed would have weird side effects, so any thoughts would be appreciated!","comments":[],"createdAt":"2023-05-15T17:40:06Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2278,"title":"Allow `if`/`then`/`else` validation failures to return more meta in the error to derive what the underlying failure condition was."},{"body":"**What version of Ajv you are you using?**\r\n8.12.0\r\n\r\n**What problem do you want to solve?**\r\nCurrently is not possible to assign different compilation options to each specific schema. For example turning type coercing or allErrors.\r\n\r\nI'm building a Vite/rollup plugin to compile json schemas using Ajv and I want to allow users to define different options on each schema on the same Ajv instance(so references can work)\r\n\r\n**What do you think is the correct solution to problem?**\r\nI could think of two solutions for this but all has their own drawbacks and IMO this will not work well in my usecase\r\n- I could set ajv.options on each compile call and assign the old options back. This will works with refs but all the refs will have the same options(even if the referenced schema has different options)\r\n- Creating a new ajv instance with different options but this will not work completely with refs and I will have to sync the different instances\r\n\r\n**Will you be able to implement it?**\r\nOf course I will help if it's necessary","comments":[{"id":"IC_kwDOAiQBJM5bxRh2","author":{"login":"qurafi"},"authorAssociation":"NONE","body":"So taking a peak on how to implement this. I noticed that every compilation happens in https://github.com/ajv-validator/ajv/blob/45583fde112f80c06ba6ad5583b744ef22d0640a/lib/compile/index.ts#L111\r\n\r\nI do a little experiment by overwriting this function module:\r\n```javascript\r\n\r\nconst compile_index = require(\"ajv/dist/compile/index\");\r\nconst instance_opts = new WeakMap();\r\nconst schema_opts = new WeakMap();\r\n\r\nconst compileSchema = compile_index.compileSchema;\r\n\r\ncompile_index.compileSchema = function (sch) {\r\n    const opts = schema_opts.get(sch.schema);\r\n    if (opts) {\r\n        if (!instance_opts.has(this)) {\r\n            instance_opts.set(this, this.opts);\r\n        }\r\n\r\n        this.opts = { ...this.opts, ...opts };\r\n\r\n        try {\r\n            return compileSchema.call(this, sch);\r\n        } finally {\r\n            this.opts = instance_opts.get(this);\r\n        }\r\n    }\r\n\r\n    return compileSchema.call(this, sch);\r\n};\r\n```\r\n\r\nSo any user could add different options to `schema_opts`\r\n```javascript\r\n/** @param {import(\"ajv\").Options} opts */\r\nfunction addWithOptions(schema, opts) {\r\n    opts && schema_opts.set(schema, opts);\r\n    return ajv.addSchema(schema);\r\n}\r\n```\r\n\r\nI tested this on multiple schemas including references. It worked well but there's some points about this:\r\n- This modify the module directly but it does not change the function interface but once changing or moving this function, it will eventually breaks so it's very unsafe approach for live server but could work with build tools like in my case.\r\n-  I didn't test it on esm yet\r\n- This does not work with inlineRefs option(probably because ajv inline the referenced schema with the original?)\r\n- Finally, this is just a temporarily solution until we have a native way in the core","createdAt":"2023-05-09T08:02:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2269#issuecomment-1539643510","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM57HXfU","author":{"login":"errodrigues"},"authorAssociation":"NONE","body":"This would be very useful","createdAt":"2024-04-19T00:22:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2269#issuecomment-2065528788","viewerDidAuthor":false}],"createdAt":"2023-05-09T04:12:32Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2269,"title":"Support different ajv options for each schema"},{"body":"Hi,\r\n\r\nI have the example like below,\r\n```\r\n\"obj2\": \r\n{\r\n    {\r\n      \"prop1\": \"baz\", \"prop2\": 999\r\n     },\r\n    {\r\n      \"prop1\": \"qux\", \"prop2\": 555\r\n     }\r\n }\r\n```\r\n\r\ni.e object containing objects, now in this i need '**_prop1_**' field to have unique values. \r\n\r\n**_Note:_**:  I know this is possible when it is array of object, but i dont think there is any solution for the same case when object containing objects.\r\n","comments":[],"createdAt":"2023-05-05T14:30:02Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2267,"title":"Validate object containing object for uniqueness"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nversion : 8.12.0\r\n\r\n**Typescript code**\r\n\r\n```typescript\r\ninterface Data {\r\n  hobbies: string[];\r\n}\r\n\r\nconst schema: JSONSchemaType<Data> = {\r\n  type: \"object\",\r\n  properties: {\r\n    hobbies: {\r\n      type: \"array\",\r\n      uniqueItems: true,\r\n      prefiexItems: [\r\n        { type: \"string\" },\r\n        { type: \"string\" },\r\n        { type: \"string\" },\r\n        { type: \"string\" },\r\n      ],\r\n      items: false,\r\n    },\r\n  },\r\n};\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nThe types of 'properties.hobbies' are incompatible between these types.\r\n    Type '{ type: \"array\"; uniqueItems: true; prefiexItems: { type: string; }[]; items: boolean; }' is not assignable to type '{ $ref: string; } | (UncheckedJSONSchemaType<string[], false> & { nullable?: false | undefined; const?: string[] | undefined; enum?: readonly string[][] | undefined; default?: string[] | undefined; })'.\r\n      Types of property 'items' are incompatible.\r\n        Type 'boolean' is not assignable to type 'UncheckedJSONSchemaType<string, false>'.ts(2322)\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\nAs from [NEW: draft 2020-12](https://ajv.js.org/json-schema.html#prefixitems) prefixItems is new addition and [additionalItems is not supported in JSON Schema draft-2020-12](https://ajv.js.org/json-schema.html#additionalitems) i want to disable additional items but vscode does not provide intellisense for `prefixItem`\r\n\r\n**Are you going to resolve the issue?**\r\nno","comments":[],"createdAt":"2023-05-05T07:17:48Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2265,"title":"vscode intellisense for prefixItems"},{"body":"Hi,\r\n\r\nmy object is like below as per schema:\r\n\r\n```\r\n    {\r\n      \"name\": \"new_york\",       // new_york\r\n      \"address\": {\r\n        \"type\": \"type1\",\r\n        \"title\": \"adsas sadfd\",\r\n        \"propertyValue\": {\r\n          \"new_york\":          // need to access dynamic value 'new_york' by refering to \"name\" field available on top\r\n           {\r\n           type: 'type2'\r\n          }\r\n        },\r\n        \"key\": \"new_york\"\r\n      }\r\n    }\r\n```\r\n\r\nand My schema is as follows:\r\n\r\n```\r\n{\r\n  name: {\r\n    type: 'string'\r\n  },\r\n  address: {\r\n    type: 'object',\r\n    properties: {\r\n      title: {\r\n        const: { $data: '2/label' },\r\n        errorMessage: {\r\n          const: 'must be equal to ${2/label}'\r\n        }\r\n      },\r\n      key: {\r\n        const: { $data: '2/name' },\r\n        errorMessage: {\r\n          const: 'must be equal to ${2/name}'\r\n        }\r\n      },\r\n      propertyValue: {\r\n        type: 'object',                                         // here that dynamic validation must happen\r\n        additionalProperties: true\r\n      },\r\n    },\r\n    required: ['type', 'title', 'key', 'properties', 'required'],\r\n    additionalProperties: {\r\n      not: true,\r\n      errorMessage: 'must NOT have additional property ${0#}'\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nSo, _**propertyValue**_ object contains _name_ field value(i.e **new_york**) in the object which is dynamic\r\n    \"propertyValue\": {\r\n          \"**new_york**\": {\r\n           type: 'type2'\r\n          }\r\n      }\r\n\r\nBut How can validate in json schema that _**propertyValue**_ object contains _name_ field value(i.e **new_york**) like i have done under _key_ field object i.e $data: '2/name'?\r\n","comments":[{"id":"IC_kwDOAiQBJM6Hj85X","author":{"login":"jasoniangreen"},"authorAssociation":"COLLABORATOR","body":"Sorry but I don't think this is supported by AJV or JSON Schema. I have looked at the docs for [$data](https://ajv.js.org/guide/combining-schemas.html#data-reference) and can't see any way it could be used to link to a property name / key.","createdAt":"2024-08-07T21:07:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2264#issuecomment-2274348631","viewerDidAuthor":false}],"createdAt":"2023-05-03T14:01:00Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"}],"number":2264,"title":"Referencing to key's value within schema"},{"body":"**What version of Ajv you are you using?**\r\n8.12.0\r\n\r\n**What problem do you want to solve?**\r\nIf the discrimantor property needs to be evaluated in a object which contains a allOf instead of direct properties, the discriminator can not be evaluated. Also the mapping param should be used if one exists.\r\n\r\nExample of such a mapping:\r\n```\r\n    Song:\r\n      description: A song\r\n      type: object\r\n      oneOf:\r\n        - $ref: '#/components/schemas/InstrumentalSongObject'\r\n        - $ref: '#/components/schemas/PopSongObject'\r\n      discriminator:\r\n        propertyName: type\r\n        mapping:\r\n          INSTRUMENTAL: '#/components/schemas/InstrumentalSongObject'\r\n          POP: '#/components/schemas/PopSongObject'\r\n    BaseSong:\r\n      description: Base object\r\n      type: object\r\n      required:\r\n        - title\r\n      properties:\r\n        title:\r\n          description: The title\r\n          type: string\r\n    InstrumentalSong:\r\n      description: 'Instrumental Song'\r\n      required:\r\n        - type\r\n      type: object\r\n      properties:\r\n        type:\r\n          type: string\r\n          description: Song type\r\n          enum:\r\n            - INSTRUMENTAL\r\n          example: INSTRUMENTAL\r\n        band:\r\n          description: The band\r\n          type: string\r\n    PopSong:\r\n      description: 'Pop song'\r\n      required:\r\n        - type\r\n      type: object\r\n      properties:\r\n        type:\r\n          type: string\r\n          description: Song type\r\n          enum:\r\n            - POP\r\n          example: POP\r\n        artist:\r\n          description: The artist\r\n          type: string\r\n    InstrumentalSongObject:\r\n      description: A instrumental song\r\n      type: object\r\n      allOf:\r\n        - $ref: '#/components/schemas/BaseSong'\r\n        - $ref: '#/components/schemas/InstrumentalSong'\r\n    PopSongObject:\r\n      description: A pop song\r\n      type: object\r\n      allOf:\r\n        - $ref: '#/components/schemas/BaseSong'\r\n        - $ref: '#/components/schemas/PopSong'\r\n```\r\n\r\n**What do you think is the correct solution to problem?**\r\nthe getMapping function in the package discriminator needs to be extended tu support allOf for evaluation of the discriminator in the props of these subobjects.\r\n\r\n**Will you be able to implement it?**\r\nyes, PR will follow","comments":[{"id":"IC_kwDOAiQBJM5bK939","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Semantics of discriminator mean that oneOf should be used, not anyOf. Why is it needed?\r\n\r\nDiscriminator in itself is no-op, but it is used as an optimisation for faster oneOf validation, requiring that the schema itself is consistent with \"discriminator\" semantics - that only one of the branches can be valid, and each branch requires a specific different value of discriminator tag.","createdAt":"2023-05-01T11:22:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1529601533","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5bK-sx","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"I see, the issue is not named correctly - it's about looking up the name in the referenced schemas.\r\n\r\nI don't think that it needs to be supported to be honest given the complexity. A simple workaround is to either construct the schema programmatically, so that it's included as the whole object, or to repeat the tag value on the top level.","createdAt":"2023-05-01T11:27:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1529604913","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5bK-2m","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"but happy to look at PR, if it's simple enough it might be ok... The traversal would simply stop then at the first schema that defines the tag value.","createdAt":"2023-05-01T11:28:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1529605542","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5bLfZO","author":{"login":"z6n9n"},"authorAssociation":"NONE","body":"The problem comes from the practices, that this is a valid schema definition for OAS. Repeating the \"Base\" object properties instead of using allOf would work, but results later in ugly code from the code generators based on this schema. This, because polymorphism then can not be used anymore and all objects get generated as own interface definitions. That's why such practices (combine oneOf with allOf) are preferred.","createdAt":"2023-05-01T14:00:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1529738830","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5uWGjl","author":{"login":"mefellows"},"authorAssociation":"NONE","body":"Hi team,\r\n\r\nI'd like to see this (mapping) supported also. In trivial examples, working around mapping is straightforward. When handling an OAS it's a little more complicated as the referenced schemas can't just be renamed. At the very least, it would make it difficult to present useful errors back to users as the schema would have been transformed.\r\n\r\nIs the PR https://github.com/ajv-validator/ajv/pull/2262 something you would consider and does it address the problem?","createdAt":"2023-12-12T04:37:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1851287781","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5v2aZw","author":{"login":"cdm-2012"},"authorAssociation":"NONE","body":"Hi @epoberezkin, supporting OAS mapping would be really helpful because it becomes more and more common application in the projects that I participated in. I will vote for it as well.\r\n","createdAt":"2024-01-04T07:00:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-1876534896","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6lFZz2","author":{"login":"chrisolson443"},"authorAssociation":"NONE","body":"I'm also interested in this issue. Here's a very simplified schema to reproduce. I just want my instance object to be `oneOf` a few different sub-types(schemas), where each sub-schema \"extends\" properties from another (not shown below for simplicity)\n```\n{\n  \"components\": {\n    \"schemas\": {\n      \"MySchema\": {\n        \"type\": \"object\",\n        \"oneOf\": [\n          {\n            \"$ref\": \"#/components/schemas/FooSubschema\"\n          }\n        ],\n        \"discriminator\": {\n          \"propertyName\": \"myType\"\n        }\n      },\n      \"FooSubschema\": {\n        \"type\": \"object\",\n        \"allOf\": [\n         // { } imagine a $ref here\n          {\n            \"properties\": {\n              \"myType\": {\n                \"type\": \"string\",\n                \"enum\": [\n                  \"fooType\"\n                ]\n              }\n            }\n          }\n        ],\n        \"additionalProperties\": false,\n        \"required\": [\n          \"myType\"\n        ]\n      }\n    }\n  }\n}\n```","createdAt":"2025-04-01T14:55:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2261#issuecomment-2769657078","viewerDidAuthor":false}],"createdAt":"2023-05-01T09:50:02Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2261,"title":"Support for discriminator tag lookup in referenced schemas"},{"body":"**What version of Ajv you are you using?**\r\n8.11.0\r\n\r\n**What problem do you want to solve?**\r\nI have a schema with a `not` clause which, on failure, returns a very unhelpful/confusing message: `my-schema.json/thing must NOT be valid`\r\n\r\n```json\r\n\"thing\": {\r\n    \"type\": \"number\",\r\n    \"not\": {\r\n        \"exclusiveMinimum\": -0.25,\r\n        \"exclusiveMaximum\": 0.25\r\n    }\r\n}\r\n```\r\n\r\n**What do you think is the correct solution to problem?**\r\nI think the correct messaging would be something along the line of what it would say if the criteria was not wrapped in a `not`. Something like:\r\n```\r\nmy-schema.json/thing must NOT be < 0.25, my-schema.json/thing must NOT be > -0.25\r\n```\r\n\r\n**Will you be able to implement it?**\r\nUnsure","comments":[{"id":"IC_kwDOAiQBJM5acool","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"What you are effectively asking is converting schema to English. That is certainly out of scope for Ajv. In general, such negative rules are better avoided in schemas - it makes it non-declarative. You may also consider using JTD.\r\n\r\nYou can also try ajv-errors that allows you to supply your own errors.","createdAt":"2023-04-21T08:16:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2255#issuecomment-1517455909","viewerDidAuthor":false}],"createdAt":"2023-04-12T22:01:51Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2255,"title":"Better error messaging for NOT"},{"body":"**What version of Ajv you are you using?**\r\n\r\n8.12.0\r\n\r\n**What problem do you want to solve?**\r\n\r\n```\r\ntype MyData = JTDDataType<typeof schema>\r\n```\r\n\r\nfor this\r\n\r\n```\r\ntype MyData = JSONSchemaDataType<typeof schema>\r\n```\r\n\r\nso i don't need to write it multiple times.\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nimplement JSONSchemaDataType for JSONSchemaType\r\n\r\n**Will you be able to implement it?**\r\n\r\nI think no","comments":[{"id":"IC_kwDOAiQBJM5aco8c","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"The problem is that in general case it is not possible to map JSON schema to data type, unlike JTD.","createdAt":"2023-04-21T08:18:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2253#issuecomment-1517457180","viewerDidAuthor":false}],"createdAt":"2023-04-06T13:49:49Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2253,"title":"TypeScript Construct type for JSONSchemaType"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\nHey, I am not entirely sure whether this is the right place to ask this, sorry if not.\r\n\r\n**What version of Ajv you are you using?**\r\n8.12.0\r\n\r\n**What problem do you want to solve?**\r\nI want to define a schema containing multiple schema definitions.\r\n\r\nTo be specific, I need to write a validation schema for the variables possible to pass to a serverless plugin specifying that the user can pass schemas to compile before packaging to the plugin.\r\nIn the end, it would look like the following:\r\n```typescript\r\n{\r\n    myPlugin: {\r\n        schemas: [\r\n            schema1,\r\n            schema2\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\n**What do you think is the correct solution to problem?**\r\nMaybe there is already something like this, I tried \r\n```typescript\r\n{\r\n    type: \"object\",\r\n    properties: {\r\n      schemas: {\r\n        type: \"array\",\r\n        items: {\r\n          $ref: \"http://json-schema.org/draft-07/schema\"\r\n        },\r\n      },\r\n}\r\n```\r\nbut received the error `Error: Unsupported reference http://json-schema.org/draft-07/schema`\r\n\r\n**Will you be able to implement it?**\r\nNo","comments":[],"createdAt":"2023-04-04T15:56:19Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2251,"title":"Type for JsonSchema"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nI'm using latest Ajv version as of now (8.12.0)\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\nconst options = { allErrors: true };\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n  \"$id\": \"https://www.example.com/schemas/test\",\r\n  \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\r\n  \"description\": \"A schema for unit testing\",\r\n  \"type\": \"object\",\r\n  \"properties\": {\r\n    \"foo\": {\r\n      \"type\": \"string\",\r\n      \"minLength\": 2\r\n    },\r\n    \"bar\": {\r\n      \"type\": \"number\",\r\n      \"minimum\": 0\r\n    },\r\n    \"baz\": {\r\n      \"type\": \"array\",\r\n      \"items\": { \"type\": \"string\" },\r\n      \"minItems\": 2,\r\n      \"prefixItems\": [{ \"const\": \"test\" }]\r\n    }\r\n  },\r\n  \"required\": [\"foo\", \"baz\"]\r\n}\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```json\r\n{\r\n  \"foo\": \"foo\",\r\n  \"bar\": 1,\r\n  \"baz\": [\"test\", \"ok\"]\r\n}\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```javascript\r\nimport Ajv from 'ajv/dist/2020';\r\nconst ajv = new Ajv();\r\nconst validate = ajv.compile(schema);\r\nconst valid = validate(data); // warn: strict mode: \"prefixItems\" is 2-tuple, but minItems or maxItems/items are not specified or different at path \"#/properties/baz\"\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```javascript\r\n{\r\n  errors: null,\r\n  schema: {\r\n    '$id': 'https://www.example.com/schemas/test',\r\n    '$schema': 'https://json-schema.org/draft/2020-12/schema',\r\n    description: 'A schema for unit testing',\r\n    type: 'object',\r\n    properties: { foo: [Object], bar: [Object], baz: [Object] },\r\n    required: [ 'foo', 'baz' ]\r\n  },\r\n  schemaEnv: <ref *1> SchemaEnv {\r\n    refs: {},\r\n    dynamicAnchors: {},\r\n    schema: {\r\n      '$id': 'https://www.example.com/schemas/test',\r\n      '$schema': 'https://json-schema.org/draft/2020-12/schema',\r\n      description: 'A schema for unit testing',\r\n      type: 'object',\r\n      properties: [Object],\r\n      required: [Array]\r\n    },\r\n    schemaId: '$id',\r\n    root: [Circular *1],\r\n    baseId: 'https://www.example.com/schemas/test',\r\n    schemaPath: undefined,\r\n    localRefs: {},\r\n    meta: undefined,\r\n    '$async': undefined,\r\n    validateName: ValueScopeName {\r\n      str: 'validate20',\r\n      prefix: 'validate',\r\n      value: [Object],\r\n      scopePath: [_Code]\r\n    },\r\n    validate: [Circular *2]\r\n  },\r\n  evaluated: {\r\n    props: { foo: true, bar: true, baz: true },\r\n    items: undefined,\r\n    dynamicProps: false,\r\n    dynamicItems: false\r\n  }\r\n}\r\n```\r\n\r\n**What results did you expect?**\r\nNo warning. The spec has specifically [changed the way to declare tuples and arrays](https://json-schema.org/draft/2020-12/release-notes.html#changes-to-items-and-additionalitems) to avoid this sort of confusion and I'm not sure the warning is still needed\r\n\r\n**Are you going to resolve the issue?**\r\nYou mean through an PR? I can certainly do that if that's wanted","comments":[{"id":"IC_kwDOAiQBJM5acsdm","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"it's a possible enhancement to make strictTuples behave differently in draft2020-12. You still can define open tuples in 2020-12, and the idea of this option is to prevent you from using open tuples as they are better avoided in JSON. A stronger opinion that JTD enforces is that any tuples are better avoided in JSON as there is no cross-platform support for them, but it's another story.","createdAt":"2023-04-21T08:30:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2241#issuecomment-1517471590","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5k7czz","author":{"login":"coderextreme"},"authorAssociation":"NONE","body":"I can't figure out an incantation for draft 2020-12 for a 4x4 matrix which doesn't throw an error in strict mode.  Thrown error is below, with ajv 8.12.0.   Suggestions are welcome.\r\n\r\n            \"@matrix\": {\r\n              \"$comment\": \"SFMatrix4f inputOutput\",\r\n              \"type\": \"array\",\r\n              \"prefixItems\": [\r\n                {\r\n                  \"default\": 1,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 1,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 1,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 0,\r\n                  \"type\": \"number\"\r\n                },\r\n                {\r\n                  \"default\": 1,\r\n                  \"type\": \"number\"\r\n                }\r\n              ],\r\n\t      \"items\": { \"type\": \"number\" },\r\n              \"minItems\": 16,\r\n              \"maxItems\": 16\r\n            },\r\n\r\n\r\nError thrown is:\r\n\r\nError: strict mode: \"prefixItems\" is 16-tuple, but minItems or maxItems/items are not specified or different at path \"#/oneOf/1/properties/%40matrix\"\r\n    at checkStrictMode (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\util.js:174:15)\r\n    at checkStrictTuple (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\vocabularies\\applicator\\items.js:46:40)\r\n    at validateTuple (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\vocabularies\\applicator\\items.js:24:5)\r\n    at Object.code (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\vocabularies\\applicator\\prefixItems.js:9:46)\r\n    at keywordCode (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\validate\\index.js:464:13)\r\n    at C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\validate\\index.js:222:17\r\n    at CodeGen.code (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\codegen\\index.js:439:13)\r\n    at CodeGen.block (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\codegen\\index.js:568:18)\r\n    at iterateKeywords (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\validate\\index.js:219:9)\r\n    at groupKeywords (C:\\Users\\john\\x3dvalidate\\node_modules\\ajv\\dist\\compile\\validate\\index.js:200:13)\r\n\r\n\r\nThe JSON being evaluated doesn't even have @matrix property.\r\n\r\nI would love to use strict mode, but it's fouling up my user's logs with nonsense. I am getting older, and my vision may be failing!\r\n\r\nThanks!\r\n\r\n","createdAt":"2023-08-25T12:48:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2241#issuecomment-1693306099","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6LzRMf","author":{"login":"sinclairzx81"},"authorAssociation":"NONE","body":"> it's a possible enhancement to make strictTuples behave differently in draft2020-12.\r\n\r\n@epoberezkin It would be great to have the current strict warning reviewed. I am actually in the process of trying to upgrade to 2020-12, but these strict warnings are proving to be a bit awkward. The main reason for wanting 2020-12 is to be able to represent data structures such as the following.\r\n\r\n```typescript\r\n// typescript\r\ntype T = [string, number, ...boolean[]]\r\n\r\n// typebox\r\nconst T = Type.Tuple([\r\n   Type.String(),\r\n   Type.Number(),\r\n   Type.Rest(Type.Boolean())\r\n])\r\n\r\n// json schema\r\nconst T = {\r\n  type: \"array\",    \r\n  prefixItems: [    \r\n    { type: \"string\" },\r\n    { type: \"number\" }\r\n  ],\r\n  \"minItems\": 2,\r\n  \"items\": { type: \"boolean\" }\r\n}\r\n```\r\nWhich unfortunately results in the warning\r\n```\r\nstrict mode: \"prefixItems\" is 2-tuple, but minItems or maxItems/items are not specified or different at path \"#\"\r\n```\r\nThere doesn't appear to be way to express the above data structure without warning, but is there a technical reason why this schematic needs to warn in strict?\r\n\r\n\r\n\r\n","createdAt":"2024-09-12T07:27:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2241#issuecomment-2345472799","viewerDidAuthor":false}],"createdAt":"2023-03-15T10:10:35Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2241,"title":"strictTuples warning when using 2020-12 draft prefixItems with optional"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n \"ajv\": \"^8.11.0\",\r\n\r\n**Your javascript code**\r\n```javascript\r\n{\r\n        type: \"object\",\r\n        properties: {\r\n              userDataProcessing: {\r\n                  type: \"boolean\", const: true, nullable: false\r\n              }\r\n       },\r\n       required: [\"userDataProcessing\"]\r\n    }\r\n```\r\n\r\n\r\nbody :\r\n\r\n{\r\n}\r\n\r\n\r\nHow to validate  boolean isTrue. Why const is not working?  Maybe it is possible but it is not documented.  \r\n\r\n","comments":[{"id":"IC_kwDOAiQBJM6SHWy-","author":{"login":"minons1"},"authorAssociation":"NONE","body":"Also looking solution for this, my validation using if then, also does not work\r\n\r\n```\r\n{\r\n  type: 'object',\r\n  properties: {\r\n    is_value_enabled: { type: 'boolean' },\r\n    value_type: { enum: ['a', 'b'] }\r\n  },\r\n  if: {\r\n    properties: {\r\n      is_value_enabled: {\r\n        const: true\r\n      }\r\n    }\r\n  },\r\n  then: {\r\n    required: ['value_type']\r\n  }\r\n}\r\n```\r\n\r\nthrowing error `Error: strict mode: required property \"value_type\" is not defined at \"#/properties/then\" (strictRequired)`","createdAt":"2024-11-01T06:58:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2236#issuecomment-2451401918","viewerDidAuthor":false}],"createdAt":"2023-03-09T19:23:54Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2236,"title":"Boolean \"is true\" validation?"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports. For other issues please use:\r\n- security vulnerability: https://tidelift.com/security)\r\n- a new feature/improvement: https://ajv.js.org/contributing/#changes\r\n- browser/compatibility issues: https://ajv.js.org/contributing/#compatibility\r\n- JSON-Schema standard: https://ajv.js.org/contributing/#json-schema\r\n- Ajv usage questions: https://gitter.im/ajv-validator/ajv\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.12.0\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```\r\n{ verbose: true }\r\n```\r\n\r\n**JSON Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```\r\nconst schema = {\r\n    $schema: \"https://json-schema.org/draft/2020-12/schema\",\r\n    $id: \"main_schema\",\r\n    title: \"Main List\",\r\n    type: \"array\",\r\n    items: {\r\n      type: \"object\",\r\n      properties: {\r\n        route: {\r\n          type: [\"string\", \"null\"],\r\n          title: \"Route\",\r\n          description: \"Route\",\r\n          $ref: \"shared_schema#/definitions/routes\",\r\n        }\r\n      },\r\n      required: [\"route\"]\r\n    }\r\n  };\r\n\r\nconst shared_schema = {\r\n  $id: \"shared_schema\",\r\n  title: \"MyProject shared values\",\r\n  definitions: {\r\n    routes: {\r\n      enum: [\r\n        \"ROUTE1\",\r\n        \"ROUTE2\",\r\n        \"ROUTE3\"\r\n      ],\r\n      errorMessage:\r\n        \"Route must be an allowed value: ${/definitions.routes.enum.join(', ')}\"\r\n    }\r\n  }\r\n};\r\n\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```\r\nconst data = [{route: \"INVALID\"}]\r\n\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```\r\nconst ajv = ajvError(new Ajv({ verbose: true }));\r\najv.addSchema(shared_schema, \"shared_schema\").compile(shared_schema);\r\nconst valid = ajv.validate(schema, data);\r\n\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nRoute must be an allowed value: undefined\r\n\r\n```\r\n\r\n**What results did you expect?**\r\n```\r\nRoute must be an allowed value: ROUTE1, ROUTE2, ROUTE3\r\n```\r\n**Are you going to resolve the issue?**\r\n```\r\nNo\r\n```\r\n\r\nI am unable to get list of allowed values. Tried a lot of things, this might now be the correct syntax to get the reference but that's what i want to figure out.","comments":[],"createdAt":"2023-03-03T17:15:40Z","labels":[],"number":2234,"title":"Question: how to get enum definition values from referenced schema"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for compatibility issues.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**The version of Ajv you are using**\r\n\r\nLatest available on npm (8.12.0)\r\n\r\n**The environment you have the problem with**\r\n\r\nDeno 1.31.1 (latest as of today)\r\n\r\n**Your code (please make it as small as possible to reproduce the issue)**\r\nI use the 'standard' idiom to for Ajv2019 and various formats with node+Typescript:\r\n\r\n```\r\nimport Ajv2019, { ErrorObject} from 'ajv/dist/2019';\r\nimport addFormats from 'ajv-formats';\r\n...\r\n        const ajv = new Ajv2019({allErrors: true, verbose: true});\r\n        addFormats(ajv);\r\n```\r\n\r\nand that works well. One would expect that with the latest version of deno (which can use npm directly), one could\r\nsimply say\r\n\r\n```\r\nimport Ajv2019, { ErrorObject} from 'npm:ajv/dist/2019';\r\nimport addFormats from 'npm:ajv-formats';\r\n```\r\n\r\nbut deno complains on not finding `dist/2019` and that `addFormat` cannot be used as function. I have tried other CDNs, but did not work. Note that the \"default\" Ajv access seems to work.\r\n\r\nIs there any way to access Ajv2019?","comments":[],"createdAt":"2023-03-01T15:07:41Z","labels":[{"id":"MDU6TGFiZWw0MjMzOTM2NzU=","name":"compatibility","description":"","color":"4121BE"}],"number":2231,"title":"Using Ajv2019 and format does not seem to work with deno"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nlatest\r\n\r\n**Ajv options object**\r\n```{}```\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\nimport {JSONSchemaType} from 'ajv'\r\n\r\ntype Schema<T> = JSONSchemaType<T>;\r\n\r\ntype Foo = {                                          \r\n  name: 'FOO';                                                                                                                                                                                   \r\n};\r\n\r\ntype Bar = Foo & {\r\n  field: string;\r\n}\r\n\r\nconst FooSchema: Schema<Foo> = {\r\n  $id: '/foo',\r\n  type: 'object',\r\n  properties: {\r\n    name: {\r\n      type: 'string'\r\n    }\r\n  },\r\n  required: []\r\n}\r\n\r\nconst BarSchema: Schema<Bar> = {\r\n  allOf: [\r\n    { $ref: '/foo' },\r\n    {\r\n      type: 'object',\r\n      properties: {\r\n        field: {\r\n          type: 'string'\r\n        }\r\n      },\r\n      required: []\r\n    }\r\n  ],\r\n  definitions: {\r\n    foo: FooSchema\r\n  }\r\n}\r\n\r\nconsole.log(BarSchema)\r\n```\r\n\r\n[Here](https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAbwFIGUDyA5FBjAFgUxAEMAVATzHwF84AzKCEOAciICsA3ZgKG5gvxwcBYgB4SAPjgBeOKkzDCpAeIkBuXv0pwAYhAgzEcYydNnzFy+e7GAdkRD4AXCx1o0zNVe8-ff-wGBQcEhoWbcVBp8AnAAQkRQhnoGAGSINnTA+AA2ACYuAM4wUMC2AOYaVLzYELZFuvqKxC5NRKLJUrIIGQAkwPksAPS0+swANBlaziwQAEZs+Ngw4xlgDJSwWQUu3ab2jjsZplMuzEUl5TymVcZUE8ZQ+ACOAK7AjwMA2gC6EdW19XiUFaLTwSlEQM66WMRGy2TQtBcnyORh6j0RQxGEGYcDuKN2ZhOM3mi2W9zMawgGxgW0OlloWTydKsRLOxVKZSuFhuZjx5ker3e+C+v2uGW+5Ny+AZtmANIBzOMWJcyVaGSqVW4NTqEGy+AAdNkIGUABRA1oASiAA) is the TS Playground\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nType '{ allOf: ({ $ref: string; } | { type: \"object\"; properties: { field: { type: \"string\"; }; }; required: never[]; })[]; definitions: { foo: { type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 8 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; }...' is not assignable to type 'Schema<Bar>'.\r\n  Type '{ allOf: ({ $ref: string; } | { type: \"object\"; properties: { field: { type: \"string\"; }; }; required: never[]; })[]; definitions: { foo: { type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 8 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; }...' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }'.\r\n    Property 'type' is missing in type '{ allOf: ({ $ref: string; } | { type: \"object\"; properties: { field: { type: \"string\"; }; }; required: never[]; })[]; definitions: { foo: { type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 8 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; }...' but required in type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; }'.\r\n```\r\n\r\n**What results did you expect?**\r\nNo compilation error\r\n\r\n**Are you going to resolve the issue?**\r\nDepends on what the issue is\r\n","comments":[{"id":"IC_kwDOAiQBJM5WJ1yn","author":{"login":"theahura"},"authorAssociation":"NONE","body":"Digging into the actual types, it looks like there is no type for a lone `allOf` schema. So instead it defaults to the last option (object) which results in this cryptic type error. \r\n\r\nIs there a reason there are anyOf and oneOf ternary branches but not allOf? should be pretty easy to fix, just add an equivalent allOf branch to the top of json-schema.ts\r\n\r\n(that said, switching to anyOf does not fix the issue)","createdAt":"2023-02-26T17:55:57Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2227#issuecomment-1445420199","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5WJ2DP","author":{"login":"theahura"},"authorAssociation":"NONE","body":"This issue was spurred on by a broader question, which is: given a type that is an intersection with a union type, what is the right json schema that ajv and typescript will both properly accept? For example:\r\n```\r\ntype BarBaz = Bar | Baz;\r\n\r\ntype Foo = BarBaz & { ... }\r\n```\r\nnaively, I would represent BarBaz with a `oneOf` and Foo with a `allOf` but both of these seem to fail when they are top level schemas.\r\n\r\nNote that for many intersection types it is possible to simply use the spread operator over the properties fields of the relevant schemas. That is not possible here because it's an intersection of a union.","createdAt":"2023-02-26T18:00:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2227#issuecomment-1445421263","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5WJ3Uo","author":{"login":"theahura"},"authorAssociation":"NONE","body":"Seems related: https://github.com/YousefED/typescript-json-schema/issues/359\r\n\r\nAlso: https://github.com/ajv-validator/ajv/issues/2000","createdAt":"2023-02-26T18:20:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2227#issuecomment-1445426472","viewerDidAuthor":false}],"createdAt":"2023-02-26T17:54:41Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2227,"title":"JSONSchema with allOf throws unexpected typescript compiler error"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\nlatest, yes\r\n\r\n**Ajv options object**\r\n{}\r\n\r\n```javascript\r\nimport {JSONSchemaType} from \"ajv\"\r\n\r\ninterface Foo {\r\n  foo?: string;\r\n}\r\n\r\nconst FooSchema: JSONSchemaType<Foo> = {\r\n  type: 'object',\r\n  properties: {\r\n    foo: {\r\n      type: 'string',\r\n      nullable: true\r\n    }\r\n  },\r\n  required: []\r\n}\r\n\r\ninterface Bar {\r\n  bar: Foo\r\n}\r\n\r\nconst BarSchema: JSONSchemaType<Bar> = {\r\n  type: 'object',\r\n  properties: {\r\n    bar: {\r\n      type: 'object',\r\n      $ref: '#/definitions/Foo'\r\n    }\r\n  },\r\n  required: [],\r\n  definitions: {\r\n    Foo: FooSchema\r\n  }\r\n}\r\n\r\nconsole.log(FooSchema, BarSchema)\r\n```\r\n\r\n\r\n**Sample data**\r\nNA\r\n\r\n**Your code**\r\nSee above, also a [TS Playground](https://www.typescriptlang.org/play?ts=4.7.2#code/JYWwDg9gTgLgBAbwFIGUDyA5FBjAFgUxAEMAVATzHwF84AzKCEOAIiICsA3ZgKG+ADsY+KLSLZ8cAGIQIibnDoyA-AC44AZxhQBAcwDc3Kr2wR+mqTJwFia1JiuFSFfAB5pEAHxwAvHIUxnNQByCAAjNnxsGCCAGnk4MAZKWGB8dTUEeIVaGQyshTgAymDNbX4dWPyFfgBXABs6olC6-DUtGvx8owUqOIUofABHGuABgBM1AG0AXUNeASERMQkAISIoPzhQ9bV3Oe4TM3g1qAcbODssPEdyShcTr19M-0C4EPDI6L6EpOEYVPSmwU2ygeQKBSKrTeYQiUUq4IUABIBrRggBiAD0Y3wtAEwH+pnUGPcQS68V68QGw1G+AmcBm32xuP4+OAhLBBXcu0s12I5P2h3UEBaADo6hAdAAKdxnIgxOAnWUASm4QA)\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nType '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }' is not assignable to type 'UncheckedJSONSchemaType<Known, true>'.\r\n  Type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }' is not assignable to type '{ type: \"object\" | undefined; additionalProperties?: boolean | UncheckedJSONSchemaType<Known, false> | undefined; unevaluatedProperties?: boolean | ... 1 more ... | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }'.\r\n    Type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }' is not assignable to type '{ type: \"object\" | undefined; additionalProperties?: boolean | UncheckedJSONSchemaType<Known, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<...> | undefined; ... 7 more ...; maxProperties?: number | undefined; }'.\r\n      Types of property 'properties' are incompatible.\r\n        Type 'UncheckedPropertiesSchema<Foo> | undefined' is not assignable to type 'Partial<UncheckedPropertiesSchema<{ [key: string]: Known; }>> | undefined'.\r\n          Type 'UncheckedPropertiesSchema<Foo>' is not assignable to type 'Partial<UncheckedPropertiesSchema<{ [key: string]: Known; }>>'.\r\n            Property 'foo' is incompatible with index signature.\r\n              Type '{ $ref: string; } | (UncheckedJSONSchemaType<string | undefined, false> & { nullable: true; const?: null | undefined; enum?: readonly (string | null | undefined)[] | undefined; default?: string | ... 1 more ... | undefined; })' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<Known, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ... 9 more ... | undefined'.\r\n                Type '{ anyOf: readonly UncheckedJSONSchemaType<string | undefined, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<Known, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ... 9 more ... | undefined'.\r\n                  Type '{ anyOf: readonly UncheckedJSONSchemaType<string | undefined, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }' is not assignable to type '{ $ref: string; }'.\r\n                    Types of property '$ref' are incompatible.\r\n                      Type 'string | undefined' is not assignable to type 'string'.\r\n                        Type 'undefined' is not assignable to type 'string'.\r\n```\r\n\r\nFor some reason, typescript/ajv cannot handle nullable fields in nested schemas. The above example is a minimum repro where Foo has a nullable field, and is then referenced inside Bar. \r\n\r\nIf I remove the nullable field, i.e.\r\n```\r\ninterface Foo {\r\n  foo: string\r\n}\r\n```\r\nand adjust the schema accordingly, everything compiles. \r\n\r\n**What results did you expect?**\r\nNo compilation issues\r\n\r\n**Are you going to resolve the issue?**\r\n","comments":[{"id":"IC_kwDOAiQBJM5VxgM4","author":{"login":"theahura"},"authorAssociation":"NONE","body":"Note that the issue I actually _wanted_ to report was one in which the same setup above would report a TS compilation error like the following:\r\n```\r\n [tsl] ERROR in /home/soot/code/soot/frontend/ui-v1/src/api/rest/objects.ts(159,5)\r\n        TS2322: Type 'Schema<RawStore>' is not assignable to type 'UncheckedJSONSchemaType<Known, true>'.\r\n    Type '{ anyOf: readonly UncheckedJSONSchemaType<RawStore, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, Unche\r\nckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }' is not assignable to type 'UncheckedJSONSchemaType<Kno\r\nwn, true>'.                                                                   \r\n      Type '{ anyOf: readonly UncheckedJSONSchemaType<RawStore, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, Unc\r\nheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }' is not assignable to type '{ type: \"array\" | undefin\r\ned; items: UncheckedJSONSchemaType<Known, false>; contains?: UncheckedPartialSchema<Known> | undefined; minItems?: number | undefined; maxItems?: number | undefined; minContains?: num\r\nber | undefined; maxContains?: number | undefined; uniqueItems?: true | undefined; additionalItems?: undefined; } & { allOf?: readonly UncheckedPartialSchema<Known>[] | undefined; any\r\nOf?: readonly UncheckedPartialSchema<Known>[] | undefined; oneOf?: readonly UncheckedPartialSchema<Known>[] | undefined; if?: UncheckedPartialSchema<Known> | undefined; then?: Uncheck\r\nedPartialSchema<Known> | undefined; else?: UncheckedPartialSchema<Known> | undefined; not?: UncheckedPartialSchema<Known> | undefined; } & { [keyword: string]: any; $id?: string | und\r\nefined; $ref?: string | undefined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undef\r\nined; }'.                                                                     \r\n        Type '{ anyOf: readonly UncheckedJSONSchemaType<RawStore, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<string, U\r\nncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; }' is missing the following properties from type '{ t\r\nype: \"array\" | undefined; items: UncheckedJSONSchemaType<Known, false>; contains?: UncheckedPartialSchema<Known> | undefined; minItems?: number | undefined; maxItems?: number | undefi\r\nned; minContains?: number | undefined; maxContains?: number | undefined; uniqueItems?: true | undefined; additionalItems?: undefined; }': type, items\r\n```\r\nwhere for some reason it thinks an object type is an array?\r\n\r\nbut i was not able to replicate this error on the TS Playground. \r\n\r\nThis error is caused by AJV / Typescript behaving differently when importing a schema from a different file vs having the schema in the same file. So there are potentially two different bugs here, both related to the `nullable` type","createdAt":"2023-02-21T20:16:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1439040312","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V3pMT","author":{"login":"theahura"},"authorAssociation":"NONE","body":"Note that in both errors reported above, there is actually a commonality: typescript seems to think that the type of the passed in schema is: \r\n```\r\n Type '{ anyOf: readonly UncheckedJSONSchemaType<ModelKey | null | undefined, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | unde\r\nfined; $defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined; definitions?: Record<string, UncheckedJSONSchemaType<Known, false>> | undefined; } & { nullable: true;\r\n const?: null | undefined; enum?: readonly (ModelKey | null | undefined)[] | undefined; default?: ModelKey | null | undefined; }'\r\n```\r\nI think this is totally wrong -- there are no anyOf fields on any of these schemas. For some reason, typescript/ajv are not properly going down the type ternaries located in json-schema.d.ts; it's just stopping at the first type in the union :thinking: ","createdAt":"2023-02-22T19:09:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440650003","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V3sdq","author":{"login":"ntippie"},"authorAssociation":"NONE","body":"I ran into this issue when trying to cast a generated schema to the SomeJSONSchema type. My root object had only `$schema` and `definitions`, and it was mistakenly thinking the `definitions` object was an array (and asking for `type, items`). When I separately cast each definition value, it worked.\r\n\r\nUsing `typescript@4.8.4` and `ajv@8.12.0`.","createdAt":"2023-02-22T19:20:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440663402","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V3tY8","author":{"login":"theahura"},"authorAssociation":"NONE","body":"@ntippie what do you mean by `separately cast each definition value`?","createdAt":"2023-02-22T19:23:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440667196","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V3ufz","author":{"login":"ntippie"},"authorAssociation":"NONE","body":"```js\r\nimport { SomeJSONSchema } from 'ajv/dist/types/json-schema';\r\nimport AppSchema from './schema.json';\r\n\r\n// TODO for some reason can't pass in whole AppSchema because TS thinks definitions is an array\r\n// https://github.com/ajv-validator/ajv/issues/2223\r\n// export default AppSchema as SomeJSONSchema;\r\nexport default {\r\n  ...AppSchema,\r\n  definitions: Object.fromEntries(\r\n    Object.entries(AppSchema.definitions).map(([key, val]) => {\r\n      return [key, val as SomeJSONSchema];\r\n    })\r\n  ),\r\n};\r\n\r\n```","createdAt":"2023-02-22T19:25:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440671731","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V3xDN","author":{"login":"theahura"},"authorAssociation":"NONE","body":"Interesting, so by casting to `SomeJSONSchema` you lose the template, so typescript just doesn't go past the first layer of indirection. I guess this is a fix, but it's more of a hack :sweat_smile: it doesn't really explain why this thing is failing with nullable types...\r\n\r\nbut, practically speaking, you're right -- updating the [TS Playground](https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAbwFIGUDyA5FBjAFgUxAEMAVATzHwF84AzKCEOAciICsA3ZgKFElkRwUjfKkw4CxODXqMW7DgHoAJsADOMRTAr41itmogA7ALRq8hIswDc3O9spCLxADwkAfHAC8cMVmekOm7uttz4AB788A74cADCEAA20ACiiYnAYGr4AIJQUERGAOaE+EYwAApEBSD4MPhQat6CcK1t7R2dXd0d3K0xAFwscWgAMmgASgD6KaOjAJIVKCk2PWvrG5tb2zu7a317h10HiopwAOq4wHhwIBDK+IlwMBBwAK7Zz69Qb0ZwaqBgIlqsBtAA6OAAcTKDSI6TIcCIcDAUDqBWARnwylu90eEKOBMJROJBzuD0SAGl8GQAPxDDRQDFFOAAHzgRje6WsxJ5x15hxOZ3mtGeBFRcHU7NeZMecAA1tSADSiyUgD7wABGsWy0VeMHRf0KiLAKIgKOARHqOPJ+P5dvtAtapzg8yKRmgWIlIqRMsp1IlTR1todJNaRiItTUYCI2HwVLIajp-31TIA2gBdVnszmJbkhzYHfPrQVwHJwbDGWjAZm0aCi2JvYhga2yrVM54GrEQ13u1HY4Delt+hGSoNF8cT9qk3GJKo1NT0lPFPOT4ur7ol4X-OrKptNGAEOAQN4wMAnr6IqWmB60Iic+BqXBESjB9dv9-7VrYdWMFBPyjxkmDJMiuH4bNwVChBEUTlsYGjxEkqTpJk2R5AUxSlOUc4RnUDRqBIlhDARrgJMkUBpBkWS5PkhQlLUWHVDh9SNJ4XgHAghbPDoQzMBAGpsPg2AwMwiqcaalCwMAuhDBxnSDIgnHtPJzDAcUImKW0FZGBoPEjOM0yzAsSwrKJnRUKZHS+vGMkaf03EsKpRTqd0HLpEQGqJPgQz6m8+AWe05kaeGkbRrG8YLgp3TKdUBRkM5XSgoQEWyT0ymOfFZn+R0rnAh5Xkdr5WWtIFnS+thIDJbZXGUDx6VFdI9Xfhov7-nG1I2VF9kqUuTn1WGObuZ53k-H5GklW042tKiACObzAH2QwZhZkF2NB0DwGUjaljRGH0TA5COAgYHHSdPIHHpkwzHMizLM0zAXQZ13GSJp2vW970fZ99oQV9v1-byVX-UDwP7GtAgxNt6F0WUlSMbUzFND4pFIZRqE7dDDE1LhjQg7jBZhJE63VbE5XY2oABi0BobRmEwIjLR44zBIHKmMU03tEp-NTu0wwd+DpkmKThPqMYwC43MY7DWMI8qR3yWzPPlNIIRM6rwMQVBhMCFp8GkwjlNQBLtP4QEREBC4et4QbRt7WorHsZxyl8QJQkZciDASTAUmVZ0D1XUZywdV0Tv8YJwl9XAAAkqK0DxADEKj4FWRigsAcGKMj5HIVRbvFVlk1wDNc2orbi3pllN4YqncFB+0mcUSh+X19naNQ7TluNMRSJEE0wi1H4Xf58tthAA) with this does fix the issue","createdAt":"2023-02-22T19:30:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440682189","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V31Wv","author":{"login":"ntippie"},"authorAssociation":"NONE","body":"Yes, I think something is still wrong here and I am just working around it for now. I'm only narrowly using this package for now, so I have only seen this one of the errors you've seen.\r\n\r\nFor me the issue is [this line](https://github.com/ajv-validator/ajv/blob/45583fde112f80c06ba6ad5583b744ef22d0640a/lib/types/json-schema.ts#L85) evaluating as true for a JSON object like this:\r\n\r\n```json\r\n{\r\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\r\n  \"definitions\": {\r\n    \"Model1\": { ... },\r\n    \"Model2\": { ... }\r\n  }\r\n}\r\n```","createdAt":"2023-02-22T19:44:40Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1440699823","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5acxpj","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"typescript type utility JSONSchemaType cannot traverse #refs, it's not a bug and it cannot be resolved - typescript simply cannot do it. Your choices is to either not use this utility type or not to use #refs (and instead construct schema as a single object).","createdAt":"2023-04-21T08:48:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2223#issuecomment-1517492835","viewerDidAuthor":false}],"createdAt":"2023-02-21T20:11:50Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2223,"title":"JSONSchemaType does not correctly handle nullable fields when referenced using $ref"},{"body":"**What version of Ajv you are you using?**\r\n`8.11.0`\r\n\r\n**What problem do you want to solve?**\r\nI have a type with an optional field, and as we know from other issues (e.g. https://github.com/ajv-validator/ajv/issues/1375 and https://github.com/ajv-validator/ajv/issues/1664) the current version of `ajv` requires the associated schema to mark that field as nullable.  This means if the json source includes a `null` value, the resulting post-guarded object will have a `null` value coming from ajv's type guard.\r\n\r\nAs the ajv team already knows this can result in type errors (since `null` is not an expected value according to TypeScript).  I don't want to propose anything related to the `nullable` field issue -- that's already been discussed plenty and I know decisions have been made.  I want to instead suggest that we allow a coercion setting that will convert `null` to `undefined` -- thus removing nulls from the resulting object.\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nTypescript's [coding guidelines](https://github.com/Microsoft/TypeScript/wiki/Coding-guidelines#null-and-undefined) is explicit in its suggestion to never use null.  I think this means it would be reasonable for ajv to allow a developer adhering to thoseÂ guidelines to instruct ajv to to do the same, and to always convert `null` to `undefined` when parsing a json object.\r\n\r\n**Will you be able to implement it?**\r\n\r\nIf this is of interest to the ajv team I think I'd be able to add it as an option; I imagine it would be in the form of a configuration flag (thus non-breaking).  Maybe something like `convertNullToUndefined`.","comments":[],"createdAt":"2023-02-21T15:38:05Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2222,"title":"Allow coersion from `null` to `undefined`"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.12.0, yes\r\n\r\n**Ajv options object**\r\n\r\n```{}```\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\nimport {JSONSchemaType} from \"ajv\"\r\n\r\nconst toSchema = <T extends Record<string, any>>(properties: { [key: string]: any}): JSONSchemaType<T> => {\r\n  return {\r\n    type: 'object',\r\n    properties,\r\n    required: []\r\n  }\r\n}\r\n```\r\n\r\n**JSON Schema**\r\nNA\r\n\r\n**Sample data**\r\nNA\r\n\r\n**Your code**\r\n[TS Playground](https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAbwFIGUDyA5FBjAFgUxAEMAVATzHwF84AzKCEOAIiICsA3ZgKG+wgB2AZ3gwIOAsTgBeOAB4ScfAA8Y+AQBMhcAEr5+UDXJFRgAgOYAaOEQFkAfPYAUYBpVjB8QgFyI4AbQBrfDJfEzNzAF1fWzIqAEpfVEwJQlIKfAV7GWyEbjg4KHwYAFcoAUR8grgYDN8AcggAIzZ9GHrLKoLXCHcYTyFO6sL8AEcS4CKNX39IqqpuKiA)\r\n\r\n```javascript\r\nimport {JSONSchemaType} from \"ajv\"\r\n\r\nconst toSchema = <T extends Record<string, any>>(properties: { [key: string]: any}): JSONSchemaType<T> => {\r\n  return {\r\n    type: 'object',\r\n    properties,\r\n    required: []\r\n  }\r\n}\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\nType '{ type: \"object\"; properties: { [key: string]: any; }; required: never[]; }' is not assignable to type 'UncheckedJSONSchemaType<T, false>'.\r\n  Object literal may only specify known properties, and 'type' does not exist in type 'never'.\r\n```\r\n\r\n**What results did you expect?**\r\nI expected the type to compile without issue. It looks like the UncheckedJSONSchemaType is not correctly parsing the various if/else statements, so it ends up falling back to `never`. The error messaging here is pretty bad, but even when explicitly extending the generic from `Record` ajv fails, which is surprising.\r\n\r\n**Are you going to resolve the issue?**\r\nMaybe","comments":[{"id":"IC_kwDOAiQBJM5VckqW","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Not sure if â€œanyâ€ is supported - itâ€™s almost never needed, when you do data validationâ€¦","createdAt":"2023-02-16T18:41:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2219#issuecomment-1433553558","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5VdJIL","author":{"login":"theahura"},"authorAssociation":"NONE","body":"What is the correct way to construct generics like the function above? If you remove the explicit record extension it still fails with the same error","createdAt":"2023-02-16T20:55:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2219#issuecomment-1433702923","viewerDidAuthor":false}],"createdAt":"2023-02-14T00:14:30Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"}],"number":2219,"title":"JSONSchemaType incorrectly parsing generic type as never"},{"body":"**What version of Ajv you are you using?**\r\n8.12.0\r\n\r\n**What problem do you want to solve?**\r\nI want to create utility libraries to make working with JSONSchema easier. For example, I want to be able to create a basic `toSchema` function that looks something like:\r\n```\r\nconst toSchema = <T>(properties: UncheckedPropertiesSchema<T>): JSONSchemaType<T> => {\r\n  return {\r\n    type: 'object',\r\n    properties,\r\n    required: []\r\n  }\r\n}\r\n```\r\n\r\n**What do you think is the correct solution to problem?**\r\nExporting more of the types used to construct JSONSchemaType\r\n\r\n**Will you be able to implement it?**\r\nyep, pretty sure this is a one line change\r\n","comments":[],"createdAt":"2023-02-13T22:36:46Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2218,"title":"Export UncheckedPropertiesSchema"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.12.0. Yes. \r\n\r\n**Your code**\r\n\r\nSee: https://stackoverflow.com/questions/75395134/ajv-does-not-throw-type-errors-when-given-incorrect-schema-for-a-union-type-in-t\r\nand [typescript playground](https://www.typescriptlang.org/play?jsx=0&ts=4.7.2#code/JYWwDg9gTgLgBAKjgQwM4oFYDc4DMoQhwDky2xA3AFBUCmAdgK5ECiTIAYsLQDYAmcAN5U4cAPIA5FnAC8JSS2IAaEXAAqAdTGySmscSoBfGsHoxaUXMgDGtOBwgQAQmjvDRAI2RQAXHFQwUKYA5tSeyABefgFB9KGqAPQJcCDI9ACecBAwABYWeNz8qEYmZhZWtvaOYvR2tAAe5vR86A7OrkKqDMxcvHx+bD2FfAB0Cl2NUMi9-NGBISVUpuaWNnZtagDuEHANTS1V7ahuXewz-XCDnMMjeosw6WDrjjptNXYAPodbENRU1hB6AFDgBlax5VJ+MhYEYAKRBkjBEOQaketAAPG0AHw6dxwB5PPzECAeDC0awwZSqMAEJ6wbioPx48K+Tqidn4tFEmIhAwcwwqDleKJsjmcwkkHlxPnsgWqUTda59Jny9kE2jc+bS1XGURy0RQWgAR0YwENFwA2gBdRYAoHwNpI2ipNQ5ZAwVAAEVouFMwHMPHSGgIcSh2DhCIkTpdaMxjhxcjx6qJJLJFKpohpEDpMAZKqF3nzYuTkq1wRlesF7OFRY5JeIUvLOqrCrOw1raq5pdiTf5Ld2k2m7dFda7xHYHgsFbgupnVcNJrNtEtNuM-0BqAgPFoIx4EGCAApHeDncgAJTroFbnd7w-H5Gu91en1+gNBkPBM9AA)\r\n\r\n```javascript\r\nimport * as ajv from 'ajv';\r\n\r\nenum EnumField {\r\n  ONE = 'ONE',\r\n  TWO = 'TWO'\r\n}\r\n\r\ninterface FooBase {\r\n  bar: string;\r\n  baz: string;\r\n  // many other fields\r\n}\r\n\r\ninterface FooOne extends FooBase {\r\n  enumField: EnumField.ONE\r\n  extraField: string\r\n}\r\n\r\ninterface FooTwo extends FooBase {\r\n  enumField: EnumField.TWO\r\n}\r\n\r\ntype Foo = FooOne | FooTwo;\r\n\r\nconst FooSchema: ajv.JSONSchemaType<Foo> = {\r\n  type: 'object',\r\n  properties: {\r\n    bar: {\r\n      type: 'string'\r\n    },\r\n    baz: {\r\n      type: 'string'\r\n    },\r\n    enumField: {\r\n      type: 'string'  // underspecified, this should be an enum but AJV does not complain\r\n    }\r\n  },\r\n  required: []\r\n}\r\n\r\nconst FooSchemaThatsDefinitelyWrong: ajv.JSONSchemaType<Foo> = {\r\n  type: 'object',\r\n  properties: {\r\n    bar: {\r\n      type: 'string'\r\n    },\r\n    baz: {\r\n      type: 'string'\r\n    },\r\n    enumField: {\r\n      type: 'string'\r\n    },\r\n    extraField: {\r\n      type: 'number'  // this is definitely wrong, it should at least be string\r\n    }\r\n  },\r\n  required: []\r\n}\r\n\r\nconsole.log(FooSchema)\r\nconsole.log(FooSchemaThatsDefinitelyWrong)\r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\nNA\r\n\r\n**What results did you expect?**\r\nI want to use ajv and JSONSchema to construct a validator for Foo, above. I want ajv to tell me when my schema does not match the type. For a straightforward non-union interface, ajv will tell me if I have properties missing or have an incomplete or incorrect type. However, with the union, it seems like ajv is getting tripped up.\r\n\r\nI expected AJV to throw a type error, as the jsonschema types clearly do not match with the provided typescript interfaces. However, it compiles without issue for both cases. \r\n\r\nI would have expected ajv to tell me to use a oneOf to resolve this, but instead it just ignores any issues. What's going on here? Is this just a fundamental limitation of ajv?\r\n\r\n**Are you going to resolve the issue?**\r\nMaybe, depends on the answers to the above","comments":[],"createdAt":"2023-02-09T06:56:06Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2211,"title":"AJV does not throw type errors when given incorrect schema for a Union type in TypeScript"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for compatibility issues.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**The version of Ajv you are using**\r\n8.12\r\n\r\n**The environment you have the problem with**\r\nnode v16.16.0, ESM project (`{type: module}`)\r\n\r\n**Your code (please make it as small as possible to reproduce the issue)**\r\n\r\nCode to compile AJV schema:\r\n\r\n```\r\n// compile.js\r\n\r\nimport Ajv from \"ajv\";\r\nimport standaloneCode from \"ajv/dist/standalone/index.js\";\r\nimport { writeFile } from \"fs/promises\";\r\n\r\nconst ajvOptions = {\r\n    strict: true,\r\n    allErrors: true,\r\n    messages: true,\r\n    code: {\r\n        source: true,\r\n        esm: true, // ESM support\r\n    },\r\n};\r\n\r\nconst ajv = new Ajv(ajvOptions);\r\n\r\nconst exampleSchema = {\r\n    type: \"object\",\r\n    properties: {\r\n        body: {\r\n            type: \"object\",\r\n            properties: {\r\n                firstName: {\r\n                    type: \"string\",\r\n                    minLength: 1,\r\n                },\r\n                lastName: {\r\n                    type: \"string\",\r\n                },\r\n            },\r\n            required: [\"firstName\", \"lastName\"],\r\n            additionalProperties: false,\r\n        },\r\n    },\r\n};\r\n\r\ncompileJsonSchema(exampleSchema);\r\n\r\n// Note: excluded code that runs this function\r\nasync function compileJsonSchema(schema) {\r\n    try {\r\n        // Compile schema via AJV\r\n        const compiled = ajv.compile(schema);\r\n\r\n        // Build output module file content via AJV's standalone\r\n        let moduleCode = standaloneCode(ajv, compiled);\r\n\r\n        // Write file to parent directory of source file\r\n        await writeFile(\"./schema.js\", moduleCode, \"utf-8\");\r\n    } catch (err) {\r\n        console.error(err);\r\n    }\r\n}\r\n```\r\n\r\n**Results in node.js v8+**\r\nAble to successfully compile standalone code; unable to import in ESM project\r\n\r\n**Results and error messages in your platform**\r\n\r\nI am using the [standalone validation code](https://ajv.js.org/standalone.html#using-the-defaults-es6-and-cjs-exports) functionality to generate compiled schema files at build time. I am compiling the code with the AJV library in a JS script and specifying `esm: true` to compile the standalone code for ESM. The compilation works and I am writing the compiled schema to a JS file, but I am unable to import the standalone code from this schema file in my ESM project because it imports the `ucs2length` utility via a `require` statement (`const func2 = require(\"ajv/dist/runtime/ucs2length\").default`). \r\n\r\nHere is an example schema compiled via standalone for ESM support (generated with the above script:\r\n\r\n```\r\n\"use strict\";export const validate = validate10;export default validate10;const schema11 = {\"type\":\"object\",\"properties\":{\"body\":{\"type\":\"object\",\"properties\":{\"firstName\":{\"type\":\"string\",\"minLength\":1},\"lastName\":{\"type\":\"string\"}},\"required\":[\"firstName\",\"lastName\"],\"additionalProperties\":false}}};const func2 = require(\"ajv/dist/runtime/ucs2length\").default;function validate10(data, {instancePath=\"\", parentData, parentDataProperty, rootData=data}={}){let vErrors = null;let errors = 0;if(data && typeof data == \"object\" && !Array.isArray(data)){if(data.body !== undefined){let data0 = data.body;if(data0 && typeof data0 == \"object\" && !Array.isArray(data0)){if(data0.firstName === undefined){const err0 = {instancePath:instancePath+\"/body\",schemaPath:\"#/properties/body/required\",keyword:\"required\",params:{missingProperty: \"firstName\"},message:\"must have required property '\"+\"firstName\"+\"'\"};if(vErrors === null){vErrors = [err0];}else {vErrors.push(err0);}errors++;}if(data0.lastName === undefined){const err1 = {instancePath:instancePath+\"/body\",schemaPath:\"#/properties/body/required\",keyword:\"required\",params:{missingProperty: \"lastName\"},message:\"must have required property '\"+\"lastName\"+\"'\"};if(vErrors === null){vErrors = [err1];}else {vErrors.push(err1);}errors++;}for(const key0 in data0){if(!((key0 === \"firstName\") || (key0 === \"lastName\"))){const err2 = {instancePath:instancePath+\"/body\",schemaPath:\"#/properties/body/additionalProperties\",keyword:\"additionalProperties\",params:{additionalProperty: key0},message:\"must NOT have additional properties\"};if(vErrors === null){vErrors = [err2];}else {vErrors.push(err2);}errors++;}}if(data0.firstName !== undefined){let data1 = data0.firstName;if(typeof data1 === \"string\"){if(func2(data1) < 1){const err3 = {instancePath:instancePath+\"/body/firstName\",schemaPath:\"#/properties/body/properties/firstName/minLength\",keyword:\"minLength\",params:{limit: 1},message:\"must NOT have fewer than 1 characters\"};if(vErrors === null){vErrors = [err3];}else {vErrors.push(err3);}errors++;}}else {const err4 = {instancePath:instancePath+\"/body/firstName\",schemaPath:\"#/properties/body/properties/firstName/type\",keyword:\"type\",params:{type: \"string\"},message:\"must be string\"};if(vErrors === null){vErrors = [err4];}else {vErrors.push(err4);}errors++;}}if(data0.lastName !== undefined){if(typeof data0.lastName !== \"string\"){const err5 = {instancePath:instancePath+\"/body/lastName\",schemaPath:\"#/properties/body/properties/lastName/type\",keyword:\"type\",params:{type: \"string\"},message:\"must be string\"};if(vErrors === null){vErrors = [err5];}else {vErrors.push(err5);}errors++;}}}else {const err6 = {instancePath:instancePath+\"/body\",schemaPath:\"#/properties/body/type\",keyword:\"type\",params:{type: \"object\"},message:\"must be object\"};if(vErrors === null){vErrors = [err6];}else {vErrors.push(err6);}errors++;}}}else {const err7 = {instancePath,schemaPath:\"#/type\",keyword:\"type\",params:{type: \"object\"},message:\"must be object\"};if(vErrors === null){vErrors = [err7];}else {vErrors.push(err7);}errors++;}validate10.errors = vErrors;return errors === 0;}\r\n```\r\n\r\nI'm able to import and use the schema file by manually replacing the `require` with an `import` statement. Am I overlooking something to generate standalone validation code that is fully ESM-compatible?\r\n\r\n","comments":[{"id":"IC_kwDOAiQBJM5aFAh_","author":{"login":"pmorch"},"authorAssociation":"NONE","body":"FYI: This is only a problem for JSON Schema generation. If I instead `import Ajv from \"ajv/dist/jtd.js\"` for JTD schemas, the code compiles fine.","createdAt":"2023-04-17T12:39:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-1511262335","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5dOpfk","author":{"login":"ericmorand"},"authorAssociation":"NONE","body":"Any news on this one? This is a big issue that actually prevents using AJV to generate ESM validation modules.","createdAt":"2023-05-26T09:48:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":8}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-1564121060","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5u-Vmk","author":{"login":"Weffe"},"authorAssociation":"NONE","body":"It's not just ucs2length. I also noticed it's requiring the `equal` module to be used when you have a schema like this:\r\n\r\n```\r\n{ \r\n  \"type\": \"string\",\r\n  \"const\": \"my_value\"\r\n}\r\n```\r\n\r\n```diff\r\n  const func1 = require('ajv/dist/runtime/ucs2length').default;\r\n+ const func0 = require('ajv/dist/runtime/equal').default;\r\n```\r\n\r\n> Any news on this one? This is a big issue that actually prevents using AJV to generate ESM validation modules.\r\n\r\n@ericmorand\r\n\r\nOur fix for now is to configure Vite to transform the standalone validation files so that CJS Require statements get modified to look like ES import syntax.\r\n\r\n```\r\nimport commonjs from 'vite-plugin-commonjs';\r\n\r\nconst config = defineConfig({\r\n    plugins: [\r\n        commonjs({\r\n            filter: (id) => {\r\n                const fileRegex = /precompiled.*validations\\.js$/;\r\n                return fileRegex.test(id);\r\n            },\r\n        }),\r\n    ],\r\n    // ...\r\n```\r\n\r\nThe same approach can be done for Rollup users. ","createdAt":"2023-12-18T23:09:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-1861835172","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5zZrYA","author":{"login":"patiboh"},"authorAssociation":"NONE","body":"I solved this issue in vite using this in `vite.config.js`:\r\n\r\n```\r\nimport commonjs from '@rollup/plugin-commonjs';\r\n\r\nconst config = {\r\n\tbuild: {\r\n\t\trollupOptions: {\r\n\t\t\t//... other options\r\n\t\t\tplugins: [commonjs({ transformMixedEsModules: true })],\r\n\t\t}\r\n\t}\r\n};\r\n```\r\n\r\nAs mentioned beforehand, you could also use `{ transformMixedEsModules: true }`  in a rollup config","createdAt":"2024-02-09T15:16:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-1936111104","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6G_-My","author":{"login":"hschletz"},"authorAssociation":"NONE","body":"The workaround with the \"commonjs\" plugin did not work for me, maybe because I don't compile the validation code to a file, but in-memory via the \"virtual\" plugin. I had to monkey-patch the generated code and replace the require() lines with proper imports:\r\n````ts\r\nimport func2 from 'ajv/dist/runtime/ucs2length'\r\nimport {fullFormats} from 'ajv-formats/dist/formats'\r\nconst formats0 = fullFormats.date\r\n````\r\nActual code may vary depending on used features. Needless to say, this is a fragile hack and no substitute for a proper fix.","createdAt":"2024-08-02T09:04:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2264916786","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6XJAie","author":{"login":"meness"},"authorAssociation":"NONE","body":"I'm still having this issue while ESM is enabled, I see `require()` in the compiled file","createdAt":"2024-12-11T11:47:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2535721118","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6XJeZu","author":{"login":"meness"},"authorAssociation":"NONE","body":"A workaround is compiling it in CJS format and then importing it in an ESM file like this.\r\n\r\n```\r\nimport { createRequire } from 'module';\r\n\r\nconst require = createRequire(import.meta.url);\r\n\r\nconst { yourFunction } = require('compiled.cjs');\r\n```\r\n\r\n**Note:** Absolute paths don't work with this solution, you should use relative paths.\r\n\r\nImporting the CJS like `import { yourFunction } from 'compiled.cjs'` doesn't work in AWS Lambda.\r\n\r\n","createdAt":"2024-12-11T12:21:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2535843438","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6ZJCux","author":{"login":"mirismaili"},"authorAssociation":"NONE","body":"It's 2025 and the issue still exists with AJV `v8.17.1`.\r\n\r\n To reproduce just execute:\r\n```ts\r\nimport Ajv from 'ajv'\r\nimport standaloneCode from 'ajv/dist/standalone'\r\n\r\nconst ajv = new Ajv({code: {source: true, esm: true},})\r\nconsole.log(standaloneCode(ajv, {validateJsonSchemaV7: 'http://json-schema.org/draft-07/schema#'}))\r\n```\r\nAnd then unfortunately you can see this in the produced code:\r\n```js\r\nconst func0 = require(\"ajv/dist/runtime/equal\").default;\r\n```\r\nThat causes this runtime error:\r\n```\r\nReferenceError: require is not defined\r\n```","createdAt":"2025-01-03T14:16:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}},{"content":"CONFUSED","users":{"totalCount":2}},{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2569284529","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6ZJE4O","author":{"login":"mirismaili"},"authorAssociation":"NONE","body":"The other issue is, isn't the produced code **standalone**? Then what is `require` (or even `import`) inside it from `node_modules` (`\"ajv/dist/runtime/equal\"` or `\"ajv/dist/runtime/ucs2length\"`)?!","createdAt":"2025-01-03T14:23:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":12}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2569293326","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Zj5S2","author":{"login":"PopGoesTheWza"},"authorAssociation":"NONE","body":"> isn't the produced code **standalone**?\r\n\r\nAs is, no it isn't if your schema has rules which requires (pun intended) the `ajv/dist/runtime/equal` and `ajv/dist/runtime/ucs2length` functions. Independently of generating `commonjs` or (incorrect) `esm` code, the `ajv` module will be needed as a dependency","createdAt":"2025-01-07T22:10:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2576323766","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Zj8zM","author":{"login":"PopGoesTheWza"},"authorAssociation":"NONE","body":"We have an awfully kludgy fix where we replace `require(\"ajv/dist/runtime/equal\").default` and `require(\"ajv/dist/runtime/ucs2length\").default` within the esm code with standalone function derived from the original `ajv` source code.\r\n\r\nI'd gladfully assist on a PR, implementing a proper solution, if needed.","createdAt":"2025-01-07T22:19:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2576338124","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Zno43","author":{"login":"adamschoenemann"},"authorAssociation":"NONE","body":"I had the misfortune of running into this problem as well. I tried with the various vite/rollup common-js plugins but to no avail, and I think it's because `ajv` outputs `require`s but `ajv-formats` is even worse and generates straight-out invalid code ala\r\n\r\n```javascript\r\nconst formats96 = {\"_items\":[\"require(\\\"ajv-formats/dist/formats\\\").\",{\"str\":\"fullFormats\"},\"\"]}[\"date-time\"];\r\n```\r\n\r\nTo workaround this, I (also) had to do a bunch of regex'ing. I've pasted the crux of it here in the hope that someone else does not waste as much time as I have on this.\r\n\r\n```typescript\r\n// assume `moduleCode` is generated from `standaloneCode(ajv, {...})`\r\nconst preamble = [\r\n  `// @ts-nocheck`,\r\n  `\"use strict\";`,\r\n  `import { fullFormats } from \"ajv-formats/dist/formats\";`,\r\n].join(\"\\n\");\r\nconst imports = new Set<string>();\r\nconst formatsRegex = /const (formats\\d+)\\s*=\\s\\{.+\\}(.+);/g;\r\nconst requireRegex = /const (\\S+)\\s*=\\s*require\\((.+)\\)\\.(\\S+);/g;\r\nconst replaced = moduleCode\r\n  .replaceAll(\r\n    formatsRegex,\r\n    (_match, p1, p2) => `const ${p1} = fullFormats${p2}`\r\n  )\r\n  .replace(requireRegex, (_match, p1, p2, p3) => {\r\n    imports.add(`import { ${p3} as ${p1} } from ${p2};`);\r\n    return \"\";\r\n  })\r\n  // since `use strict` should be the first non-comment line, and we're adding\r\n  // more lines in the preamble, we have moved it into the preamble.\r\n  .replace(`\"use strict\";\\n`, \"\");\r\n\r\nconst uglyOut = [preamble, Array.from(imports).join(\"\\n\"), \"\", replaced].join(\r\n  \"\\n\"\r\n);\r\n\r\nprocess.stdout.write(\r\n  // prettify the generated code (not that it really matters).\r\n  await prettier.format(uglyOut, { parser: \"babel\" }),\r\n  \"utf-8\"\r\n);\r\n```\r\n\r\nThe code above also formats the output with prettier, which is of course not necessary.","createdAt":"2025-01-08T10:17:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":4}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2577305143","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6ZylCn","author":{"login":"mirismaili"},"authorAssociation":"NONE","body":"I tackled two different scenarios using separate approaches:\r\n\r\n1. **Pre-build environment** (with access to Node.js, `node_modules`, etc.):\r\n\r\n    This was the easier case. I used [esbuild][1] to bundle the generated source:\r\n    ```ts\r\n    import Ajv from 'ajv'\r\n    import standaloneCode from 'ajv/dist/standalone'\r\n    import {build} from 'esbuild'\r\n\r\n    const originalSource = standaloneCode(/* ... */)\r\n    const {outputFiles} = await build({\r\n      bundle: true,\r\n      write: false,\r\n      format: 'esm',\r\n      sourcemap: false,\r\n      stdin: {\r\n        contents: originalSource,\r\n        resolveDir: '/',\r\n        sourcefile: 'input.js', // Virtual source file name\r\n        loader: 'js',\r\n      },\r\n    })\r\n    const bundledSource = outputFiles[0].text\r\n    ```\r\n\r\n2. **Browser environment** (specifically in a service-worker, without access to Node.js, [esbuild][1], etc.):\r\n\r\n    This was more challenging. To resolve the issue, I manually replaced `require()` calls ðŸ˜•:\r\n\r\n    ```ts\r\n    /**\r\n     * Workaround for the issue of {@link import('ajv/dist/standalone').default AJV's `standaloneCode()`}.\r\n     * @see https://github.com/ajv-validator/ajv/issues/2209\r\n     */\r\n    const UNRESOLVED_SOURCES_OF_AJV_STANDALONE = {\r\n      /** @see https://www.unpkg.com/fast-deep-equal@3.1.3/es6/index.js */\r\n      ' require(\"ajv/dist/runtime/equal\").default;': `\r\n        function equal(a, b) {\r\n          if (a === b) return true;\r\n    \r\n          if (a && b && typeof a == 'object' && typeof b == 'object') {\r\n            if (a.constructor !== b.constructor) return false;\r\n    \r\n            var length, i, keys;\r\n            if (Array.isArray(a)) {\r\n              length = a.length;\r\n              if (length != b.length) return false;\r\n              for (i = length; i-- !== 0;)\r\n                if (!equal(a[i], b[i])) return false;\r\n              return true;\r\n            }\r\n    \r\n    \r\n            if ((a instanceof Map) && (b instanceof Map)) {\r\n              if (a.size !== b.size) return false;\r\n              for (i of a.entries())\r\n                if (!b.has(i[0])) return false;\r\n              for (i of a.entries())\r\n                if (!equal(i[1], b.get(i[0]))) return false;\r\n              return true;\r\n            }\r\n    \r\n            if ((a instanceof Set) && (b instanceof Set)) {\r\n              if (a.size !== b.size) return false;\r\n              for (i of a.entries())\r\n                if (!b.has(i[0])) return false;\r\n              return true;\r\n            }\r\n    \r\n            if (ArrayBuffer.isView(a) && ArrayBuffer.isView(b)) {\r\n              length = a.length;\r\n              if (length != b.length) return false;\r\n              for (i = length; i-- !== 0;)\r\n                if (a[i] !== b[i]) return false;\r\n              return true;\r\n            }\r\n    \r\n    \r\n            if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\r\n            if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\r\n            if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\r\n    \r\n            keys = Object.keys(a);\r\n            length = keys.length;\r\n            if (length !== Object.keys(b).length) return false;\r\n    \r\n            for (i = length; i-- !== 0;)\r\n              if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\r\n    \r\n            for (i = length; i-- !== 0;) {\r\n              var key = keys[i];\r\n    \r\n              if (!equal(a[key], b[key])) return false;\r\n            }\r\n    \r\n            return true;\r\n          }\r\n    \r\n          // true if both NaN, false otherwise\r\n          return a!==a && b!==b;\r\n        };\r\n      `.trim(),\r\n    \r\n      /** @see https://www.unpkg.com/ajv@8.17.1/dist/runtime/ucs2length.js */\r\n      ' require(\"ajv/dist/runtime/ucs2length\").default;': `\r\n        function ucs2length(str) {\r\n            const len = str.length;\r\n            let length = 0;\r\n            let pos = 0;\r\n            let value;\r\n            while (pos < len) {\r\n                length++;\r\n                value = str.charCodeAt(pos++);\r\n                if (value >= 0xd800 && value <= 0xdbff && pos < len) {\r\n                    // high surrogate, and there is a next character\r\n                    value = str.charCodeAt(pos);\r\n                    if ((value & 0xfc00) === 0xdc00)\r\n                        pos++; // low surrogate\r\n                }\r\n            }\r\n            return length;\r\n        };\r\n      `.trim(),\r\n    }\r\n    \r\n    let validatorSource = standaloneCode(ajv, idNameMap) // https://ajv.js.org/standalone.html#generating-functions-s-for-multiple-schemas-using-the-js-library-es6-and-esm-exports\r\n\r\n    // Patch `validatorSource` to work around AJV's `standaloneCode` issue: https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2569293326\r\n    for (const [toBeResolved, resolvedSource] of Object.entries(UNRESOLVED_SOURCES_OF_AJV_STANDALONE))\r\n       validatorSource = validatorSource.replace(toBeResolved, resolvedSource)\r\n    ```\r\n\r\n  [1]: https://esbuild.github.io/","createdAt":"2025-01-09T13:34:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2580172967","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6lEXEX","author":{"login":"s-di-cola"},"authorAssociation":"NONE","body":"@mirismaili  tried your approach, but got this error from esbuild\n\n```\nError: Build failed with 3 errors:\n../../../../../../../input.js:1:38114: ERROR: Could not resolve \"ajv/dist/runtime/ucs2length\"\n../../../../../../../input.js:1:104921: ERROR: Could not resolve \"ajv/dist/runtime/equal\"\n../../../../../../../input.js:1:104980: ERROR: Could not resolve \"ajv-formats/dist/formats\"\n    at failureErrorWithLog (/Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:1477:15)\n    at /Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:946:25\n    at /Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:898:52\n    at buildResponseToResult (/Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:944:7)\n    at /Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:971:16\n    at responseCallbacks.<computed> (/Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:623:9)\n    at handleIncomingPacket (/Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:678:12)\n    at Socket.readFromStdout (/Users/simone.dicola2/WebstormProjects/publishing-tools/node_modules/esbuild/lib/main.js:601:7)\n    at Socket.emit (node:events:517:28)\n    at addChunk (node:internal/streams/readable:368:12) {\n  errors: [Getter/Setter],\n  warnings: [Getter/Setter]\n}\n\nNode.js v18.20.6\n\n```","createdAt":"2025-04-01T13:34:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2769383703","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6lOYQA","author":{"login":"s-di-cola"},"authorAssociation":"NONE","body":"this is my solution without any additional dependency: \n\n```\nfunction generateStandaloneCode(ajv: Ajv, outputPath: string): void {\n    // @ts-ignore\n    let ajvStandAlone = standaloneCode(ajv, idMap);\n\n    ajvStandAlone = ajvStandAlone.replace('const func0 = require(\"ajv/dist/runtime/equal\").default;', `import func0 from \"ajv/dist/runtime/equal\";`)\n        .replace('const formats0 = require(\"ajv-formats/dist/formats\").fullFormats.uri;', `import { fullFormats } from \"ajv-formats/dist/formats\";  const formats0 = fullFormats.uri;`)\n        .replace('const func3 = require(\"ajv/dist/runtime/ucs2length\").default;', `const func3 = (str) => {\n                                                                                                            const len = str.length\n                                                                                                            let length = 0\n                                                                                                            let pos = 0\n                                                                                                            let value\n                                                                                                            while (pos < len) {\n                                                                                                                length++\n                                                                                                                value = str.charCodeAt(pos++)\n                                                                                                                if (value >= 0xd800 && value <= 0xdbff && pos < len) {\n                                                                                                                    // high surrogate, and there is a next character\n                                                                                                                    value = str.charCodeAt(pos)\n                                                                                                                    if ((value & 0xfc00) === 0xdc00) pos++ // low surrogate\n                                                                                                                }\n                                                                                                            }\n                                                                                                            return length\n                                                                                                        }`);\n    fs.writeFileSync(outputPath, ajvStandAlone);\n}\n\nfunction compileSchemas(): void {\n    const ajv = new Ajv({\n        allErrors: true,\n        verbose: true,\n        strict: false,\n        allowUnionTypes: true,\n        code: {source: true, esm: true},\n    });\n \n    Logger.info('Adding schemas...');\n    addSchemas(ajv, path.resolve(dirname(import.meta), '../managed'));\n    Logger.info('Generating standalone code...');\n    generateStandaloneCode(ajv, path.resolve(dirname(import.meta), './validator.mjs'));\n}\n\ncompileSchemas();\n\n```","createdAt":"2025-04-02T09:41:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2772009984","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6o5P4H","author":{"login":"shmolf"},"authorAssociation":"NONE","body":"The only way I was able to get the Ajv module to work within TypeScript, was rather than importing the `default` module, I imported the named module. This is already supported in [the exports](https://github.com/ajv-validator/ajv/blob/82735a15826a30cc51e97a1bbfb59b3d388e4b98/lib/ajv.ts#L11) (you can confirm this in the `node_modules/ajv/dist/ajv.d.ts` file of your local project).\n\n```ts\nimport { Ajv, ErrorObject } from 'ajv';\n\n// This AJV is typescript-ready\nconst ajv = new Ajv({ allErrors: true });\n```\n\n---\n\nUnrelated to above, but I also wanted to use `ajv-formats` library as well. Which also has it's issues.\nIt is not handled well by TypeScript, and it doesn't export the named module in addition to the `default`.\nBut it does export the type of the default module. So I ended up needed a hacky solution as:\n```ts\nimport formatsPlugin, { FormatsPlugin } from 'ajv-formats';\n\nconst addFormats = (formatsPlugin as unknown as FormatsPlugin);\naddFormats(ajv);\n```\n\nHappy Coding ðŸ˜¸ ","createdAt":"2025-04-27T18:19:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2209#issuecomment-2833579527","viewerDidAuthor":false}],"createdAt":"2023-02-07T19:13:27Z","labels":[{"id":"MDU6TGFiZWw0MjMzOTM2NzU=","name":"compatibility","description":"","color":"4121BE"}],"number":2209,"title":"Unable to generate ESM-compatible standalone code"},{"body":"Ajv version `8.12.0`\r\n\r\nTypescript 4.9 allows us to use the `satisfies` operator, which can be used to enforce the correctness of a schema through `SomeJTDSchemaType` before sending it to `JTDDataType`:\r\n\r\n```typescript\r\nconst schema1 = { type: 'string' } as const satisfies SomeJTDSchemaType;\r\n\r\ntype Schema1 = JTDDataType<typeof schema1>;\r\n\r\n// No error, Schema1 = string as expected\r\n\r\n\r\nconst schema2 = { type: 'something_else' } as const satisfies SomeJTDSchemaType;\r\n\r\ntype Schema2 = JTDDataType<typeof schema2>;\r\n\r\n// Error on the `satisfies SomeJTDSchemaType`, as expected:\r\n//   Type '{ readonly type: \"something_else\"; }' does not satisfy the expected type 'SomeJTDSchemaType'.\r\n//   Types of property 'type' are incompatible.\r\n//   Type '\"something_else\"' is not assignable to type '\"boolean\" | NumberType | StringType | undefined'.\r\n```\r\n\r\nThis feature does not work properly with `enum` types:\r\n\r\n```typescript\r\nconst schema3 = { enum: ['apple', 'banana'] } as const satisfies SomeJTDSchemaType;\r\n\r\ntype Schema3 = JTDDataType<typeof schema3>;\r\n\r\n// Although this should be fine, we have an unexpected error on `satisfies SomeJTDSchemaType`:\r\n//   Type '{ readonly enum: readonly [\"apple\", \"banana\"]; }' does not satisfy the expected type 'SomeJTDSchemaType'.\r\n//   Types of property 'enum' are incompatible.\r\n//   The type 'readonly [\"apple\", \"banana\"]' is 'readonly' and cannot be assigned to the mutable type 'string[]'.\r\n```\r\n\r\nIn fact, in `types/jtd-schema.ts:14`, we see that `SomeJTDSchemaType` contains `{enum: string[]}`, to which `readonly [...]` cannot be assigned to.\r\n\r\nThis seems fixable by simply changing the enum type in this file to `{enum: readonly string[]}`.\r\n\r\nCan I open a PR for that?","comments":[{"id":"IC_kwDOAiQBJM5TrrZU","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"I don't see any downside to it, should be ok. Thank you.\r\n\r\ncc @erikbrinkman ","createdAt":"2023-01-25T17:15:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2205#issuecomment-1403958868","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Trr9P","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"if it works ok, probably worth adding to tests / examples (once 4.9 is not the latest version:)","createdAt":"2023-01-25T17:16:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2205#issuecomment-1403961167","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5TtC2M","author":{"login":"sinderw"},"authorAssociation":"NONE","body":"Sorry, I meant that `satisfies` was added in 4.9, but the bug is reproduced here in 4.9.4, latest typescript version\r\n\r\nAs this bug is purely related to typescript types, unless I am mistaken, I don't see a place to add relevant tests?\r\n\r\n`JTDDataType` was not really documented in the doc, so I added a presentation with examples the same way it was done for `JTDSchemaType`; in which I documented the use of `satisfies`","createdAt":"2023-01-25T22:36:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2205#issuecomment-1404317068","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM52OhgU","author":{"login":"entropitor"},"authorAssociation":"NONE","body":"@epoberezkin Is there anything that still needs to be done to merge this in? It would be a super useful addition.","createdAt":"2024-03-07T13:33:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2205#issuecomment-1983518740","viewerDidAuthor":false}],"createdAt":"2023-01-25T15:38:23Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2205,"title":"Typescript 4.9 `satisfies` does not properly enforce enum on `SomeJTDSchemaType`"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.12.0\r\n\r\n**Your typescript code**\r\n\r\n[Playground](https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAbzgKQMoHkByqDGALAUxAEMAVATzALgF84AzKCEOAcmICsA3VgKF4IA7AK4sAolyHwEvOHLgAxdOjgBeNvQgRWAGlnyAQgEEASmrYAjYlF28a-YIJgEo9YjmoAFYuQA2EYgATRH05AG0JKQA6JXQAXQAuEPkUuGJfYA8kgGcYKEcAcz0UmgBuULgIySco4xNE5NS5CwgLHLzC4vkyu34YSi8ffyDcQhJzGRSwgmr4RzhIpwa0LFGiMgGAHm8-AMDp2biAPnKe3hwIQVy4MCG9tZIkneHAh+IJiqro2IbJprh+lQkqxWhwCDgYLZ-jcmFRYMACNkkn9oXJ0pkCMiAQNgbl8oICqxaF0mjQSakoAQAI7CYCUwJJMLsDIeVhxclkz6LGC1Uy-CopQGYtig8GQ8kpMCwlwwBFIxqouAtNqIbFAth4wpEznQnX-Sk0ukEBmVVjKtkcvT2XiOZyudzUACyiOyxAKBE2YjgBAAHs5BIFsgtZkcFd7ZkkxOVJXcgk9Y698OsInFTn0BnBndlXe63p7vX6hIHg1JQ+oVtgkyQKFRNlmcx6xEcTvxfZBYHALld4O6YPW3QQ3uZ877-cXuUcABQVGZSGvCsS8ACUSX7uarxE9ZdDKLglJgwiggjDgpxIosYIhUP+UogcNliORAv+s6cWKFuI6BN03pEIEZr4wPOcTEs+TS3LscY3AmbwHHOAzsmBoHQgatL0oyrCAT+rAQS8FoVD0PRAA)\r\n\r\n```typescript\r\nimport { JSONSchemaType } from 'ajv'\r\n\r\nenum Event {\r\n    FOO = 'foo',\r\n    BAR = 'bar',\r\n}\r\n\r\ninterface Payload {\r\n    [Event.FOO]: {\r\n        alice: string,\r\n    };\r\n    [Event.BAR]: {\r\n        bob: string,\r\n    };\r\n}\r\n\r\ntype PayloadSchema = {\r\n    [event in Event]: JSONSchemaType<Payload[event]>;\r\n};\r\n\r\nconst payloadSchema: PayloadSchema = {\r\n    [Event.FOO]: {\r\n        type: 'object',\r\n        properties: {\r\n            alice: { type: 'string' },\r\n        },\r\n        required: ['alice'],\r\n    },\r\n    [Event.BAR]: {\r\n        type: 'object',\r\n        properties: {\r\n            bob: { type: 'string' },\r\n        },\r\n        required: ['bob'],\r\n    },\r\n}\r\n\r\ninterface Message<E extends Event> {\r\n    event: E;\r\n    payload: PayloadSchema[E];\r\n}\r\n\r\ntype MessageSchema<E extends Event> = JSONSchemaType<Message<E>>;\r\n\r\nexport const getMessageSchema = <E extends Event>(\r\n    eventType: E\r\n): MessageSchema<E> => {\r\n    return {\r\n        type: 'object',\r\n        properties: {\r\n            event: { type: 'string', enum: [eventType] },\r\n            payload: payloadSchema[eventType],\r\n        },\r\n        required: ['event', 'payload'],\r\n    };\r\n};\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nType '{ type: \"object\"; properties: { payload: PayloadSchema[E]; }; required: \"payload\"[]; }' is not assignable to type 'MessageSchema<E>'.\r\n  Object literal may only specify known properties, and 'type' does not exist in type 'never'.\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\n\r\n`JSONSchemaType` should recognize that the type `Message<E>` is an object type.\r\n\r\nAdding the following test:\r\n\r\n```typescript\r\ntype Test<E extends Event> = MessageSchema<E> extends Record<string, any> ? true : false;\r\n\r\nexport const getMessageSchema = <E extends Event>(\r\n    eventType: E\r\n): MessageSchema<E> => {\r\n    const test: Test<E> = true;\r\n    ...\r\n}\r\n```\r\n\r\nreveals that the constraint `MessageSchema<E> extends Record<string, any>` is satisfied, and I expect the branch of `UncheckedJSONSchemaType` that checks `T extends Record<string, any>` to match and result in the schema type for records and dictionaries.\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nNot yet.","comments":[{"id":"IC_kwDOAiQBJM5ac0mV","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"I was never supported.","createdAt":"2023-04-21T08:57:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2202#issuecomment-1517504917","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5ac0tI","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"closed accidentally. don't think it's possible to support though.","createdAt":"2023-04-21T08:57:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2202#issuecomment-1517505352","viewerDidAuthor":false}],"createdAt":"2023-01-10T17:56:23Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2202,"title":"JSONSchemaType<T> fails compilation when T is a generic type"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\n\r\nThis template is for issues about missing or incorrect type definition and other typescript-related issues.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n`8.12.0`, which is the latest version at the moment.\r\n\r\nIt might also be worth noting that I've tried the latest TypeScript compiler (`4.9.4`) and the previous minor version (`4.8.4`)\r\n\r\n**Your typescript code**\r\n\r\n<!--\r\nPlease make it as small as possible to reproduce the issue\r\n-->\r\n\r\n```typescript\r\nimport Ajv from 'ajv'\r\nimport {AsyncSchema, AsyncValidateFunction} from 'ajv/dist/types'\r\nimport {JTDDataType, SomeJTDSchemaType} from 'ajv/dist/types/jtd-schema'\r\n\r\nconst ajv = new Ajv()\r\n\r\nexport abstract class MyExampleClass {\r\n  protected abstract schema: SomeJTDSchemaType\r\n  private _validate?: Promise<AsyncValidateFunction<JTDDataType<typeof this.schema>>>\r\n\r\n  private get validate(): Promise<AsyncValidateFunction<JTDDataType<typeof this.schema>>> {\r\n    this._validate ??= ajv.compileAsync<JTDDataType<typeof this.schema>>({...this.schema, $async: true} as AsyncSchema)\r\n\r\n    return this._validate\r\n  }\r\n}\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nerror TS2589: Type instantiation is excessively deep and possibly infinite.\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\nI am unsure. I've spent the better half of today trying to figure out what the issue is here and have not made much progress.\r\n\r\n**Are you going to resolve the issue?**\r\nI have not been able to.\r\n\r\n________________\r\n\r\nHi all ðŸ‘‹\r\n\r\nI'm new to ajv so it's possible this is user error. I'm trying to add a generic JTD schema property to an abstract class, and I'm attempting to use the `SomeJTDSchemaType` and `AsyncValidateFunction` types to do so. This borks the TypeScript compiler, I'm assuming due to the recursive nature of `SomeJTDSchemaType`. Any ideas?","comments":[{"id":"IC_kwDOAiQBJM5R9XCf","author":{"login":"mattwebbio"},"authorAssociation":"NONE","body":"Update: after some adjustments to the code I was basing the above example on, I've realized that the issue is not inherently with the `SomeJTDSchemaType` but maybe the `JTDDataType` as well? I've updated the above a little, but here is another example that similarly borks:\r\n```typescript\r\nimport Ajv from 'ajv'\r\nimport {AsyncSchema, AsyncValidateFunction} from 'ajv/dist/types'\r\nimport {JTDDataType, SomeJTDSchemaType} from 'ajv/dist/types/jtd-schema'\r\n\r\nconst ajv = new Ajv()\r\n\r\nexport abstract class MyExampleClass {\r\n  protected abstract schema: SomeJTDSchemaType\r\n  private _validate?: Promise<AsyncValidateFunction>\r\n\r\n  private get validate(): Promise<AsyncValidateFunction> {\r\n    this._validate ??= ajv.compileAsync({...this.schema, $async: true} as AsyncSchema)\r\n\r\n    return this._validate\r\n  }\r\n\r\n  public async fromObject(obj: unknown): Promise<void> {\r\n    await (await this.validate)(obj) as JTDDataType<typeof this.schema>\r\n  }\r\n}\r\n```\r\n\r\n_________\r\n\r\nAnother failing example:\r\n```typescript\r\nexport function create<T extends SomeJTDSchemaType>({schema, parser}: { schema: SomeJTDSchemaType, parser: (obj: JTDDataType<T>) => Promise<Action[]> }):  (obj: JTDDataType<T>) => Promise<Action[]> {\r\n  const validate = ajv.compile<JTDDataType<T>>({...schema, $async: true} as AsyncSchema)\r\n\r\n  return async (obj: JTDDataType<T>) => {\r\n    return parser(await validate(obj))\r\n  }\r\n}\r\n```","createdAt":"2023-01-09T02:43:42Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2200#issuecomment-1375039647","viewerDidAuthor":false}],"createdAt":"2023-01-09T02:24:37Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2200,"title":"Using `SomeJTDSchemaType ` as a class property type fails TS compilation"},{"body":"**What version of Ajv are you using?**\r\n\r\nv8.11.2 ( latest )\r\n\r\n**Your typescript code**\r\n\r\n```typescript\r\n    import Ajv, { JSONSchemaType } from \"ajv\";\r\n\r\n    interface MyType {\r\n    \tmyProp?: OtherType;\r\n    }\r\n    \r\n    interface OtherType {\r\n    \tfoo: string;\r\n    \tbar: number;\r\n    }\r\n    \r\n    const otherSchema: JSONSchemaType<OtherType> = {\r\n    \ttype: 'object',\r\n    \tproperties: {\r\n    \t\tfoo: { type: 'string', minLength: 1 },\r\n    \t\tbar: { type: 'number' },\r\n    \t},\r\n    \trequired: ['foo', 'bar'],\r\n    \tadditionalProperties: false\r\n    };\r\n    \r\n    const mySchema: JSONSchemaType<MyType> = {\r\n    \ttype: 'object',\r\n    \tproperties: {\r\n    \t\tmyProp: otherSchema,\r\n    \t},\r\n    \trequired: [],\r\n    \tadditionalProperties: false,\r\n    };\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\napp.ts:22:7 - error TS2322: Type '{ type: \"object\"; properties: { myProp: { type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | ... 1 more ... | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }; }; required: never[]; a...' is not assignable to type 'UncheckedJSONSchemaType<MyType, false>'.\r\n  The types of 'properties.myProp' are incompatible between these types.\r\n    Type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }' is not assignable to type '{ $ref: string; } | (UncheckedJSONSchemaType<OtherType | undefined, false> & { nullable: true; const?: null | undefined; enum?: readonly (OtherType | null | undefined)[] | undefined; default?: OtherType | ... 1 more ... | undefined; })'.\r\n      Type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }' is not assignable to type '{ $ref: string; }'.\r\n        Types of property '$ref' are incompatible.\r\n          Type 'string | undefined' is not assignable to type 'string'.\r\n            Type 'undefined' is not assignable to type 'string'.\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\n\r\nI'm not sure but I think this error occurs because TS doesn't know that `myProp` in `mySchema` might be *undefined*. The *required*  array does not contain `myProp`.\r\n\r\nI could try to assign `{ nullable: true }` to `myProp` but there is no field for `schema` so this is not possible\r\n\r\n`myProp: { schema: otherSchema, nullable: true }`\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nUnfortunately I don't know how.","comments":[{"id":"IC_kwDOAiQBJM5Q5oN6","author":{"login":"matthiashermsen"},"authorAssociation":"NONE","body":"Not sure if this is a correct solution but this removes the compile errors\r\n\r\n`myProp: { ...otherSchema, nullable: true }`","createdAt":"2022-12-19T08:35:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2180#issuecomment-1357284218","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Q7TaA","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Yes, typescript utility type expects nullable in the schema for optional fields. This decision is caused by the idea that APIs should not differentiate between absent and null fields (which is an opinion, of course).","createdAt":"2022-12-19T14:06:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2180#issuecomment-1357723264","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Q8BqR","author":{"login":"matthiashermsen"},"authorAssociation":"NONE","body":"> Yes, typescript utility type expects nullable in the schema for optional fields. This decision is caused by the idea that APIs should not differentiate between absent and null fields (which is an opinion, of course).\r\n\r\nWould you mind telling me if my suggested approach is a \"good\" one? Maybe there are other ways to achieve it","createdAt":"2022-12-19T16:20:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2180#issuecomment-1357912721","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Q8GeM","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"I am not an authority on that... There is usually some difference between the types that are convenient for your application (e.g., not allow nulls, as it's an object in JS) and the types that are convenient for the API, as it is just JSON and other languages call it... So in some cases it's convenient to have types that fit API definition (that is to allow null) and treat it in the application correctly, and in some cases you may end up having some API-facing types that get \"parsed\" (transformed) into some more narrow internal types.\r\n\r\nI very much agree with \"[parse don't validate](https://lexi-lambda.github.io/blog/2019/11/05/parse-don-t-validate/)\" philosophy (which is somewhat ironic), so I've been using JTD for quite some time, and not JSON schema, as it doesn't support \"parsing\" approach, being mostly incompatible with type systems...\r\n\r\nThere is definitely an argument to challenge that decision (that optional properties must be nullable in JSON) and either revise it in the next major version or make it optional, but the number of various options is very large already, so not sure...","createdAt":"2022-12-19T16:35:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2180#issuecomment-1357932428","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5RLal5","author":{"login":"Tofandel"},"authorAssociation":"NONE","body":"I also find it weird that `nullable` is required for optional fields, I've been migrating to TS and an otherwise very long valid schema, I need to add `nullable` almost everywhere or `type` or empty `required` in some very specific places that you can only find in a very hard to read error message..\r\n\r\nThere is the same issue with the `required` field on objects\r\n\r\n```js\r\ntype Options = {\r\n  renderer?: Record<string, unknown> // It's a class but simpliying for example\r\n}\r\n\r\n// This fails TS\r\n/* TS2322: Type '{ properties: { renderer: { type: \"object\"; description: string; }; }; }' is not assignable to type \r\n'GenericSchema<Options>'. Â Â Type '{ properties: { renderer: { type: \"object\"; description: string; }; }; }'\r\n is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; \r\nunevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: \r\nnumber | undefined; } & { ...; } & { ...; } & { ...; } & Extend'. Â Â Â Â Property 'type' is missing in type '{ properties: { renderer: { type: \r\n\"object\"; description: string; }; }; }' but required in type '{ type: \"object\"; additionalProperties?: boolean | \r\nUncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | \r\nUncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; }'. */\r\nexport const schema1: JSONSchema<Options> = {\r\n  properties: {\r\n    renderer: {\r\n      type: 'object',\r\n      description: 'The renderer class or instance to use',\r\n    },\r\n  },\r\n}\r\n\r\n// Only way to get it to pass\r\nexport const schema2: JSONSchema<Options> = {\r\n  type: 'object',\r\n  properties: {\r\n    renderer: {\r\n      type: 'object',\r\n      description: 'The renderer class or instance to use',\r\n      nullable: true,\r\n      required: [],\r\n    },\r\n  },\r\n}\r\n```\r\n\r\nBut clearly those properties are not required as this doesn't seem to change anything in the behavior of the validation (eg: required is by default empty, nullable is by default true)\r\n\r\nEdit - another one: using `instanceOf` requires the `type: 'object'` to be defined, which does not work if using `instanceOf: 'Function'` (the type should not be declared in this case)\r\n\r\nAnd another one with the `unknown` or `any` type, if I set a variable with type `unkown` or `any` in typescript I expect not to have to specify a type for `avj` or the validation will not be correct, but avj's typing still enforces an `anyOf` or `type` property to be present\r\n\r\nMakes it impossible to convert to TS","createdAt":"2022-12-21T19:11:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2180#issuecomment-1361947001","viewerDidAuthor":false}],"createdAt":"2022-12-16T09:45:44Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2180,"title":"TS is not able to infer that an optional field might be undefined"},{"body":"\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.19.2\r\n\r\nIMO this is not fine:\r\n```javascript\r\nimport Ajv2020 from 'ajv/dist/2020';\r\n\r\ntype AOrBType = 'a' | 'b';\r\nconst aOrBSchema: JSONSchemaType<AOrBType> = {\r\n  type: 'string',\r\n  enum: ['FOO'],\r\n};\r\n```\r\nThe validator never produces a value that is truly `AOrBType`. However, there's no error with this definition. I think there should be.\r\n","comments":[],"createdAt":"2022-12-14T12:54:44Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2179,"title":"Enum type allows no overlap with typescript type"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.11\r\n\r\n**Ajv options object**\r\nUsing these:\r\n```\r\nimport ajvErrors from 'ajv-errors'\r\nimport addFormats from 'ajv-formats'\r\nimport betterAjvErrors from 'better-ajv-errors'\r\n```\r\n\r\ndefault options.\r\n\r\n**Problem**\r\n\r\nI want to have a type definition like \r\n\r\n```typescript\r\ntype Test2<T> = T extends undefined ? undefined : JSONSchemaType<T>\r\n```\r\n\r\nHowever, this fails for types where `T` is a union type. Here is a complete example highlighting the problem:\r\n\r\n```typescript\r\nimport { JSONSchemaType } from 'ajv'\r\n\r\ntype ExampleStringBody = {\r\n  foo: string\r\n}\r\n\r\ntype ExampleNumberBody = {\r\n  bar: number\r\n}\r\n\r\ntype ExampleBody = ExampleStringBody | ExampleNumberBody\r\n\r\nconst exampleNumberBodySchema: JSONSchemaType<ExampleNumberBody> = {\r\n  type: 'object',\r\n  required: ['bar'],\r\n  properties: {\r\n    bar: {\r\n      type: 'number',\r\n    },\r\n  },\r\n}\r\n\r\nconst exampleStringBodySchema: JSONSchemaType<ExampleStringBody> = {\r\n  type: 'object',\r\n  required: ['foo'],\r\n  properties: {\r\n    foo: {\r\n      type: 'string',\r\n    },\r\n  },\r\n}\r\n\r\nconst exampleBodySchema: JSONSchemaType<ExampleBody> = {\r\n  type: 'object',\r\n  oneOf: [exampleNumberBodySchema, exampleStringBodySchema],\r\n}\r\n\r\n// This one does not work. The rest of the example below this one work.\r\n// âœ• | âœ“ conditional type | âœ“ union | âœ“ generic\r\ntype Type1<T> = T extends undefined ? undefined : JSONSchemaType<T>\r\nconst a: Type1<ExampleBody> = exampleBodySchema\r\n\r\n// âœ“ | âœ“ conditional type | âœ• union | âœ“ generic\r\nconst b: Type1<ExampleStringBody> = exampleStringBodySchema\r\n\r\n// âœ“ | âœ• conditional type | âœ“ union | âœ“ generic\r\ntype Type2<T> = JSONSchemaType<T>\r\nconst c: Type2<ExampleBody> = exampleBodySchema\r\n\r\n// âœ“ | âœ“ conditional type | âœ“ union | âœ• generic\r\ntype Test1 = ExampleBody extends undefined\r\n  ? undefined\r\n  : JSONSchemaType<ExampleBody>\r\nconst d: Test1 = exampleBodySchema\r\n\r\n// âœ“ | âœ• conditional type | âœ• union | âœ“ generic\r\nconst e: Type2<ExampleBody> = exampleBodySchema\r\n\r\n// âœ“ | âœ“ conditional type | âœ• union | âœ• generic\r\ntype Type3 = ExampleStringBody extends undefined\r\n  ? undefined\r\n  : JSONSchemaType<ExampleStringBody>\r\nconst f: Type3 = exampleStringBodySchema\r\n```\r\n\r\nFor whatever reason, the specific combination of generics + union + generics is not accepted by typescript. The error I get out is:\r\n\r\n```\r\nconst a: UncheckedJSONSchemaType<ExampleNumberBody, false> | UncheckedJSONSchemaType<ExampleStringBody, false>\r\n\r\nType '{ oneOf: readonly UncheckedJSONSchemaType<ExampleBody, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; }' is not assignable to type 'UncheckedJSONSchemaType<ExampleNumberBody, false> | UncheckedJSONSchemaType<ExampleStringBody, false>'.\r\n  Type '{ oneOf: readonly UncheckedJSONSchemaType<ExampleBody, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; }' is not assignable to type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; } & { ...; } & { ...; } & { ...; }'.\r\n    Property 'type' is missing in type '{ oneOf: readonly UncheckedJSONSchemaType<ExampleBody, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; }' but required in type '{ type: \"object\"; additionalProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; unevaluatedProperties?: boolean | UncheckedJSONSchemaType<unknown, false> | undefined; ... 7 more ...; maxProperties?: number | undefined; }'.ts(2322)\r\njson-schema.d.ts(57, 5): 'type' is declared here.\r\n```\r\n\r\nI've ready all of the threads on union types in here that I can find. ","comments":[],"createdAt":"2022-11-28T20:49:43Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2172,"title":"Conditional type + union + generics not allowed"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.11.2\r\n\r\n**Your typescript code**\r\n\r\n```ts\r\nimport Ajv, {JTDSchemaType} from 'ajv/dist/jtd';\r\nexport interface N8nAssetsNodeData {\r\n  displayName:string;\r\n  icon:string;\r\n  install:string;\r\n  query: {\r\n      [key:string]: string;\r\n  }\r\n}\r\n\r\nexport interface N8nAssetsData {\r\n  [key: string]: N8nAssetsNodeData;\r\n}\r\n  \r\nconst schemaAssetsData:JTDSchemaType<N8nAssetsData> = {\r\n  values: {\r\n    properties: {\r\n      displayName: {\r\n        type: 'string',\r\n      },\r\n      icon: {\r\n        type: 'string',\r\n      },\r\n      install: {\r\n        type: 'string',\r\n      },\r\n      query: {\r\n        values: {\r\n          type: 'string'\r\n        },\r\n      },\r\n    },\r\n    additionalProperties: true\r\n  }\r\n};\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nerror TS2322: Type '{ values: { properties: { displayName: { type: string; }; icon: { type: string; }; install: { type: string; }; query: { values: { type: string; }; }; }; additionalProperties: boolean; }; }' is not assignable to type 'never'.\r\n\r\n22 const schemaAssetsData:JTDSchemaType<N8nAssetsData> = {\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\n\r\nA way to generate typescript key value maps in jtd without it being resolved to \"never\".\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nIf I had the clue, yes. But unfortunately I have no plan.","comments":[{"id":"IC_kwDOAiQBJM5Oxyxx","author":{"login":"lublak"},"authorAssociation":"NONE","body":"I also tried it with this:\r\n\r\n```ts\r\nexport interface N8nAssetsData extends Record<string, N8nAssetsNodeData> {\r\n  \r\n}\r\n```","createdAt":"2022-11-21T08:23:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2169#issuecomment-1321675889","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Ox00E","author":{"login":"lublak"},"authorAssociation":"NONE","body":"Even simple types:\r\n\r\n```ts\r\nexport interface Test extends Record<string, string> {\r\n  \r\n}\r\n  \r\nconst schemaAssetsData:JTDSchemaType<Test> = {\r\n  values: {\r\n    type: 'string'\r\n  }\r\n};\r\n\r\n```","createdAt":"2022-11-21T08:28:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2169#issuecomment-1321684228","viewerDidAuthor":false}],"createdAt":"2022-11-17T11:58:41Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2169,"title":"jtd key value resolves to never"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.11.2 (latest as of this writing)\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```ts\r\nimport Ajv, { JTDSchemaType } from \"ajv/dist/jtd\";\r\nconst ajv = new Ajv();\r\n```\r\n\r\n**JTD Schema**\r\n\r\nFrom https://ajv.js.org/json-type-definition.html#ref-schemas\r\n\r\n```ts\r\n\r\ntype LinkedList = { val: number; next?: LinkedList };\r\n\r\nconst schema: JTDSchemaType<LinkedList, { node: LinkedList }> = {\r\n  definitions: {\r\n    node: {\r\n      properties: {\r\n        val: { type: \"float64\" }\r\n      },\r\n      optionalProperties: {\r\n        next: { ref: \"node\" }\r\n      }\r\n    }\r\n  },\r\n  ref: \"node\"\r\n};\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```ts\r\nconst data = { val: 1 } as LinkedList;\r\n```\r\n\r\n**Your code**\r\n\r\n```ts\r\nconst validate = ajv.compile(schema);\r\n\r\nif (validate(data)) {\r\n  const next: LinkedList | undefined = data.next;\r\n  console.log(next);\r\n}\r\n```\r\n\r\nhttps://replit.com/@ento/IntrepidIndolentOutput#linkedlist.ts\r\n\r\n^`strictNullChecks` is enabled in `tsconfig.json`\r\n\r\n```json\r\n\t\t\"strictNullChecks\": true, \r\n```\r\n\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\n```\r\n// on data.next\r\nProperty 'next' does not exist on type 'never'.\r\n```\r\n\r\n**What results did you expect?**\r\n\r\nI expected the type of `data` to be `LinkedList` after being narrowed by `validate(data)`\r\n\r\n**Are you going to resolve the issue?**\r\n\r\nI was exploring how JTDSchemaType works and noticed that the example in the documentation doesn't seem to work. I'm not in immediate need for this to work.","comments":[],"createdAt":"2022-11-16T05:21:30Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"},{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2168,"title":"LinkedList example in JTD docs gets typed as never after validation"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for bug or error reports.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.11.2 (latest as of this writing)\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```ts\r\nimport Ajv, { JTDSchemaType } from \"ajv/dist/jtd\";\r\nconst ajv = new Ajv();\r\n```\r\n\r\n**JTD Schema**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```ts\r\ntype MyType = {\r\n  referenced: number;\r\n  stringProp: string;\r\n};\r\n\r\nconst schema: JTDSchemaType<MyType, { num: number }> = {\r\n  definitions: {\r\n    num: { type: \"int32\" }\r\n  },\r\n  properties: {\r\n    referenced: { ref: \"num\" },\r\n    stringProp: { type: \"string\" }\r\n  }\r\n} as const;\r\n\r\n```\r\n\r\n**Sample data**\r\n\r\n<!-- Please make it as small as possible to reproduce the issue -->\r\n\r\n```ts\r\nconst data = {} as any;\r\n```\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\n```ts\r\nconst validate = ajv.compile(schema);\r\n\r\nif (validate(data)) {\r\n  const revealType: never = data;\r\n  const stringProp: string = data.stringProp;\r\n  console.log(stringProp);\r\n}\r\n```\r\n\r\nhttps://replit.com/@ento/IntrepidIndolentOutput#index.ts\r\n\r\n^`strictNullChecks` is enabled in `tsconfig.json`\r\n\r\n```json\r\n\t\t\"strictNullChecks\": true, \r\n```\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\nTypeScript's typecheck errors:\r\n\r\n```\r\n// const revealType\r\nType '{ referenced: number; stringProp: unknown; } & {}' is not assignable to type 'never'.\r\n\r\n// const stringProp\r\nType 'unknown' is not assignable to type 'string'.\r\n```\r\n\r\n**What results did you expect?**\r\n\r\nThe type of `stringProp` to be `string` after being narrowed by `validate(data)` \r\n\r\n**Are you going to resolve the issue?**\r\n\r\nMy current workaround is to hold the definition in a const and use it to compose the schema object. (The actual code is a bit more complex than this.)\r\n\r\n```ts\r\nconst numSchema = { type: \"int32\" } as const;\r\n\r\nconst schema: JTDSchemaType<MyType> = {\r\n  properties: {\r\n    referenced: numSchema,\r\n    stringProp: { type: \"string\" }\r\n  }\r\n} as const;\r\n```","comments":[{"id":"IC_kwDOAiQBJM5ivumr","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"you need to pass interface for definitions as a second parameter: https://github.com/ajv-validator/ajv/blob/master/spec/types/jtd-schema.spec.ts#L356","createdAt":"2023-07-29T09:24:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2167#issuecomment-1656678827","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5ivu4Z","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"ah actually it is passed... cc @erikbrinkman ","createdAt":"2023-07-29T09:25:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2167#issuecomment-1656679961","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5iwJ6V","author":{"login":"erikbrinkman"},"authorAssociation":"COLLABORATOR","body":"@ento Thanks for catching this, I'm surprised that that you're the first person to report it!\r\n\r\nThe current code path for compiling existing schemas looks like this:\r\n\r\nhttps://github.com/ajv-validator/ajv/blob/490eb8c0eba8392d071fef005e16d330f259d0ba/lib/core.ts#L374\r\n\r\nDue to the default types, it seems that typescript is reinterpreting `MyType` but as if refs was `Record<string, unknown>` instead of the refs you passed in when creating the schema.\r\n\r\nChanging it to infer the refs like:\r\n```ts\r\ncompile<T = unknown, R extends Record<string, unknown> = Record<string, unknown>>(schema: JTDSchemaType<T, R>, _meta?: boolean): ValidateFunction<T>\r\n```\r\nseems to get typescript to propagate the refs you specified appropriately. I'll create a diff to fix this, hoping that it doesn't break anything else. Unfortunately, the typing of `compile` is pretty complex, and so *small simple* changes like this can sometimes screw with the compiler ðŸ¤ž","createdAt":"2023-07-29T17:05:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2167#issuecomment-1656790677","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5iwOH7","author":{"login":"erikbrinkman"},"authorAssociation":"COLLABORATOR","body":"After writing the fix, I realized that I was a little wrong. It' picking up the ref type appropriately, but not the non-ref type. This fix seems to work and makes sense, so I'm not going to dig into this any more, but it is odd. I'll also note than when I tried to stub out compile on its own, typescript didn't let me without refs, so there's so more complications due to the overloading and member function nature.","createdAt":"2023-07-29T17:58:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2167#issuecomment-1656807931","viewerDidAuthor":false}],"createdAt":"2022-11-16T05:14:22Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"},{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2167,"title":"Type of sibling property of a ref property is unknown when validated via JTDSchemaType"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.11.2 (latest version as of issue creation)\r\n\r\nUsing Typescript 4.8.4\r\n\r\n**Ajv options object**\r\n\r\nUsing defaults\r\n\r\n**Your code**\r\n\r\n<!--\r\nPlease:\r\n- make it as small as possible to reproduce the issue\r\n- use one of the usage patterns from https://ajv.js.org/guide/getting-started.html\r\n- use `options`, `schema` and `data` as variables, do not repeat their values here\r\n- post a working code sample in RunKit notebook cloned from https://runkit.com/esp/ajv-issue and include the link here.\r\n\r\nIt would make understanding your problem easier and the issue more useful to others.\r\nThank you!\r\n-->\r\n\r\nUsing refs with JTD does not produce a type safe object when using `compileParser` or `compileSerializer`. The resulting object is always of type `unknown` in Typescript (this also does not work with recursive refs)\r\n\r\n```javascript\r\n// using the schema provided in the documentation https://ajv.js.org/json-type-definition.html#ref-schemas\r\nconst schema: JTDSchemaType<{val: number}, {num: number}> = {\r\n  definitions: {\r\n    num: {type: \"float64\"},\r\n  },\r\n  properties: {\r\n    val: {ref: \"num\"},\r\n  },\r\n}\r\n\r\nconst ajv = new Ajv()\r\nconst parse = ajv.compileParser(schema)\r\n\r\nconst result = parse(data) // type should be {val: number}, but is unknown\r\n```\r\n\r\n**What results did you expect?**\r\n`compileParser` and `compileSerializer` should produce type-safe results.\r\n\r\n**Are you going to resolve the issue?**\r\nUnsure how to resolve the issue.","comments":[{"id":"IC_kwDOAiQBJM5OWj7h","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"You need to pass the type for definition as a second parameter, see the example in the test.\r\n\r\nit possibly needs to be covered in the docsâ€¦\r\n\r\nsee the test here: https://github.com/ajv-validator/ajv/blob/master/spec/types/jtd-schema.spec.ts#L295","createdAt":"2022-11-14T23:20:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2165#issuecomment-1314537185","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OWkK3","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Ah. I got it now :)","createdAt":"2022-11-14T23:21:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2165#issuecomment-1314538167","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OWklm","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Possibly, it needs one more type overload to accept anything in the definitions parameter when inferring the result type.","createdAt":"2022-11-14T23:23:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2165#issuecomment-1314539878","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6Weqpu","author":{"login":"Vangaorth"},"authorAssociation":"NONE","body":"Any progress on this?","createdAt":"2024-12-06T23:33:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2165#issuecomment-2524621422","viewerDidAuthor":false}],"createdAt":"2022-11-14T21:37:00Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"},{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2165,"title":"Typescript parser/serializer type is unknown when using JTD definitions"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\n\r\nThis template is for issues about missing or incorrect type definition and other typescript-related issues.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.11.2 \r\nThis issue is not present in 8.11.0\r\n\r\n**Your typescript code**\r\n\r\n<!--\r\nPlease make it as small as possible to reproduce the issue\r\n-->\r\n\r\n```typescript\r\nimport { JSONSchemaType } from \"ajv\";\r\n\r\nconst schema: JSONSchemaType<{ foo: string | null }> = {\r\n\ttype: \"object\",\r\n\tproperties: {\r\n\t\tfoo: { type: \"string\", nullable: true },\r\n\t},\r\n\trequired: [\"foo\"],\r\n};\r\n\r\nvoid schema;\r\n```\r\n\r\n**Typescript compiler error messages**\r\n\r\n```\r\nType '{ type: \"object\"; properties: { foo: { type: \"string\"; nullable: true; }; }; required: \"foo\"[]; }' is not assignable to type 'UncheckedJSONSchemaType<{ foo: string | null; }, false>'.\r\n  The types of 'properties.foo' are incompatible between these types.\r\n    Type '{ type: \"string\"; nullable: true; }' is not assignable to type '{ $ref: string; } | ({ anyOf: readonly UncheckedJSONSchemaType<string | null, false>[]; } & { [keyword: string]: any; $id?: string | undefined; $ref?: string | undefined; $defs?: Record<...> | undefined; definitions?: Record<...> | undefined; } & { ...; }) | ({ ...; } & ... 1 more ... & { ...; }) | ({ ...; } & ... 2...'.\r\n      Types of property 'nullable' are incompatible.\r\n        Type 'true' is not assignable to type 'false'.ts(2322)\r\n```\r\n\r\n**Describe the change that should be made to address the issue?**\r\nThere should be no TypeScript errors. As mentioned, this does not give any compiler errors in version 8.11.0\r\n\r\n**Are you going to resolve the issue?**\r\nI'm not familiar with the internals of ajv","comments":[{"id":"IC_kwDOAiQBJM5OVXhs","author":{"login":"juliensnz"},"authorAssociation":"NONE","body":"I get the exact same problem right on my project but I think the new behaviour is closer to [JsonSchema specification](https://json-schema.org/understanding-json-schema/reference/null.html)\r\n\r\nAnd BTW, if I try to put `['string', null]` as a type in my JSONSchemaType I get this error:\r\n\r\n```\r\nType '{ type: (\"number\" | null)[]; }' is not assignable to type '{ type: \"number\" | \"integer\"; }'.\r\n```","createdAt":"2022-11-14T18:52:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1314224236","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5QGyBu","author":{"login":"eddyvy"},"authorAssociation":"NONE","body":"I found the same problem, I downgraded to version 8.11.0 meanwhile","createdAt":"2022-12-09T07:33:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1343955054","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5QrLxQ","author":{"login":"sfc-gh-dgadomski"},"authorAssociation":"NONE","body":"Seem's that this is a bug introduced with the commit https://github.com/ajv-validator/ajv/commit/00b3939ba545e87f585b5ee5e93d26f025454fc6\r\n\r\nIMO it's against the JSON Schema specification.\r\n\r\n `JSON Schema imposes no restrictions on type: JSON Schema can describe any JSON value, including, for example, null` http://json-schema.org/draft/2020-12/json-schema-core.html\r\n\r\nAnd from the link @juliensnz posted `Itâ€™s important to remember that in JSON, null isnâ€™t equivalent to something being absent. `\r\n\r\nWith this change, it became impossible to define a required field that has a null value. \r\n```\r\n{\r\n  type: \"object\",\r\n  properties: {\r\n    foo: { type: \"null\" },\r\n  },\r\n  required: [\"foo\"],\r\n}\r\n```\r\nWhile it should be perfectly fine.\r\n\r\nBy the way, from this commit message \"nullable was enforced for optional parameters\" - I think this is also wrong. I might want to have an optional, string field that can't be null if it's present. In this case only a string should be accepted or undefined value. `null` shouldn't be accepted. `Nullable` and `non-required` are different things similarly as `null` and \"absent\" are different concepts in JSON.","createdAt":"2022-12-15T18:01:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":11}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1353497680","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Rx9nY","author":{"login":"Hourglasser23"},"authorAssociation":"NONE","body":"Same problem with {type: 'integer', nullable: true} \r\n\r\nAny progress? Will this be tackled?","createdAt":"2023-01-05T10:41:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1372051928","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5R88Yp","author":{"login":"thobson"},"authorAssociation":"NONE","body":"Same issue for me:\r\n\r\n```Typescript\r\ntype User = {\r\n    firstName: string | null\r\n}\r\n\r\nconst userSchema: JSONSchemaType<User> = {\r\n    type: \"object\",\r\n    properties: {\r\n        firstName: {\r\n            type: \"string\",\r\n            nullable: true\r\n        }\r\n    },\r\n    required: [\r\n        \"firstName\"\r\n    ]\r\n}\r\n```\r\n\r\n```\r\nThe types of 'properties.firstName' are incompatible between these types.\r\n...\r\nTypes of property 'nullable' are incompatible.\r\nType 'true' is not assignable to type 'false'. \r\n```\r\n\r\nI have to change my type from `string | null` to `string | undefined`, which makes no sense. In both TS and JSON there's a difference between \"set x to nothing\" and \"I didn't mention x\" ;-)\r\n\r\n","createdAt":"2023-01-08T21:23:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1374930473","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5Trm6G","author":{"login":"danielrozenberg"},"authorAssociation":"NONE","body":"As a workaround I found that this works:\r\n```diff\r\n type MyType = {\r\n   field: string | null;\r\n };\r\n \r\n const schema: JSONSchemaType<MyType> = {\r\n   $schema: 'http://json-schema.org/draft-07/schema#',\r\n   type: 'object',\r\n   required: [\r\n     'field',\r\n   ],\r\n   properties: {\r\n     'field': {\r\n-      type: 'string',\r\n-      pattern: '...',\r\n-      nullable: true,\r\n+      oneOf: [\r\n+        {\r\n+          type: 'string',\r\n+          pattern: '...',\r\n+        },\r\n+        {\r\n+          type: 'null',\r\n+          nullable: true,\r\n+        },\r\n+      ],\r\n     },\r\n   },\r\n };\r\n```\r\n\r\n(though I'm not happy about it)","createdAt":"2023-01-25T17:03:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":6}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1403940486","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5V2Tlj","author":{"login":"juliensnz"},"authorAssociation":"NONE","body":"another solution (not prettier) could be to do:\r\n\r\n```\r\ntype: ['string', 'null'] as unknown as 'string',\r\n```","createdAt":"2023-02-22T15:54:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1440299363","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5aFjbq","author":{"login":"piotr-cz"},"authorAssociation":"NONE","body":"For reference, document about migrating from [OpenAPI 3.0 to 3.1](https://www.openapis.org/blog/2021/02/16/migrating-from-openapi-3-0-to-3-1-0) describes it as\r\n\r\n```\r\n// OpenAPI v3.0\r\n{ type: 'string', nullable: true }\r\n\r\n// OpenAPI v3.1\r\n{ type: ['string', 'null'] }\r\n```","createdAt":"2023-04-17T13:57:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1511405290","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5ikqjk","author":{"login":"alesmenzel"},"authorAssociation":"NONE","body":"Hi, I am encountering the same issue on the latest version of AJV (8.12.0). Not only the Types were broken in this minor version, but they are now recommending **WRONG schema structure**, since it **reports errors on all the CORRECT usage**.\r\n\r\nHere is the setup:\r\n\r\n```js\r\nconst Ajv = require('ajv')\r\n\r\nconst ajv = new Ajv({})\r\n\r\nconst schema = /** @type {import('ajv').JSONSchemaType<{ test: string | null }>} */ ({\r\n\ttype: 'object',\r\n\tproperties: {\r\n\t\t// test: { anyOf: [{ type: 'string' }, { const: 'null' }] }, // CORRECT, but AJV reports TS error\r\n\t\t// test: { type: 'string', nullable: true }, // CORRECT, but AJV reports TS error\r\n\t\t// test: { type: ['string', 'null'] }, // CORRECT, but AJV reports TS error\r\n\r\n\t\ttest: { type: 'string', const: null }, // WRONG, but AJV types suggest it\r\n\t},\r\n\trequired: ['test'],\r\n})\r\n\r\nconst validate = ajv.compile(schema)\r\n\r\nconst examples = [{\r\n  test: null\r\n}, {\r\n  test: 'some text'\r\n}]\r\n\r\nfor (const example of examples) {\r\n\tconsole.log()\r\n\tconsole.log('Schema: %o', example)\r\n\tconst valid = validate(example)\r\n\tif (!valid) {\r\n\t\tconsole.log('Error:', validate.errors)\r\n\t} else {\r\n\t\tconsole.log('Valid')\r\n\t}\r\n}\r\n\r\nconsole.log()\r\nconsole.log('All done')\r\n```\r\n\r\nHere is the type generated for `import('ajv').JSONSchemaType<{ test: string | null }>`.\r\n\r\n```ts\r\ntype ComputedSchemaType =\r\n\t| { $ref: string }\r\n\t| ({ anyOf: readonly UncheckedJSONSchemaType<string | null, false>[] } & {\r\n\t\t\t[keyword: string]: any\r\n\t\t\t$id?: string | undefined\r\n\t\t\t$ref?: string | undefined\r\n\t\t\t$defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\tdefinitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t  } & {\r\n\t\t\tnullable?: false | undefined\r\n\t\t\tconst?: string | null | undefined\r\n\t\t\tenum?: readonly (string | null)[] | undefined\r\n\t\t\tdefault?: string | null | undefined\r\n\t  })\r\n\t| ({ oneOf: readonly UncheckedJSONSchemaType<string | null, false>[] } & {\r\n\t\t\t[keyword: string]: any\r\n\t\t\t$id?: string | undefined\r\n\t\t\t$ref?: string | undefined\r\n\t\t\t$defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\tdefinitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t  } & {\r\n\t\t\tnullable?: false | undefined\r\n\t\t\tconst?: string | null | undefined\r\n\t\t\tenum?: readonly (string | null)[] | undefined\r\n\t\t\tdefault?: string | null | undefined\r\n\t  })\r\n\t| ({ type: readonly 'string'[] } & StringKeywords & {\r\n\t\t\t\t[keyword: string]: any\r\n\t\t\t\t$id?: string | undefined\r\n\t\t\t\t$ref?: string | undefined\r\n\t\t\t\t$defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\t\tdefinitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\t} & {\r\n\t\t\t\tnullable?: false | undefined  // WRONG - should allow nullable\r\n\t\t\t\tconst?: string | null | undefined\r\n\t\t\t\tenum?: readonly (string | null)[] | undefined\r\n\t\t\t\tdefault?: string | null | undefined\r\n\t\t\t})\r\n\t| ({ type: 'string' } & StringKeywords & {\r\n\t\t\t\tallOf?: readonly UncheckedPartialSchema<string | null>[] | undefined\r\n\t\t\t\tanyOf?: readonly UncheckedPartialSchema<string | null>[] | undefined\r\n\t\t\t\toneOf?: readonly UncheckedPartialSchema<string | null>[] | undefined\r\n\t\t\t\tif?: UncheckedPartialSchema<string | null> | undefined\r\n\t\t\t\tthen?: UncheckedPartialSchema<string | null> | undefined\r\n\t\t\t\telse?: UncheckedPartialSchema<string | null> | undefined\r\n\t\t\t\tnot?: UncheckedPartialSchema<string | null> | undefined\r\n\t\t\t} & {\r\n\t\t\t\t[keyword: string]: any\r\n\t\t\t\t$id?: string | undefined\r\n\t\t\t\t$ref?: string | undefined\r\n\t\t\t\t$defs?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\t\tdefinitions?: Record<string, UncheckedJSONSchemaType<Known, true>> | undefined\r\n\t\t\t} & {\r\n\t\t\t\tnullable?: false | undefined  // WRONG - should allow nullable\r\n\t\t\t\tconst?: string | null | undefined\r\n\t\t\t\tenum?: readonly (string | null)[] | undefined\r\n\t\t\t\tdefault?: string | null | undefined\r\n\t\t\t})\r\n```","createdAt":"2023-07-27T14:51:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1653778660","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5ikwEo","author":{"login":"alesmenzel"},"authorAssociation":"NONE","body":"As additional information, the typechecking broke in `8.11.1` patch.","createdAt":"2023-07-27T15:00:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1653801256","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5nB9sr","author":{"login":"Renegade334"},"authorAssociation":"NONE","body":"Also ran into this issue. It appears the problem is with [the definition of `Nullable<T>`](/ajv-validator/ajv/blob/9885226beb7691230df41163f7c98348970d0632/lib/types/json-schema.ts#L65-L76):\r\n\r\n```ts\r\ntype Nullable<T> = undefined extends T\r\n  ? {\r\n      nullable: true\r\n      const?: null // any other value here would make `null` fail\r\n      enum?: (T | null)[] // `null` must be explicitely included in \"enum\"\r\n      default?: T | null\r\n    }\r\n  : {\r\n      const?: T\r\n      enum?: T[]\r\n      default?: T\r\n    }\r\n```\r\n\r\nThis type definition matches optional properties rather than nullable ones, and therefore declaring a nullable property [as per the definition in the Ajv JSON Schema documentation](https://ajv.js.org/json-schema.html#nullable) will cause a Typescript compilation error.\r\n\r\nThis was apparently fixed by #1719, but the change was deemed breaking and pushed to the [v9 branch](/ajv-validator/ajv/tree/v9), which has been gathering dust since 2021.","createdAt":"2023-09-20T23:54:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1728568107","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5vGpRv","author":{"login":"marklai1998"},"authorAssociation":"NONE","body":"any update on this?","createdAt":"2023-12-20T07:48:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1864012911","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5xDqjE","author":{"login":"slifty"},"authorAssociation":"NONE","body":"This probably doesn't help but it appears if you make the field optional (e.g. add `?`) then the schema works.\r\n\r\ne.g.\r\n\r\n```\r\nimport { JSONSchemaType } from \"ajv\";\r\n\r\nconst schema: JSONSchemaType<{ foo?: string | null }> = {\r\n\ttype: \"object\",\r\n\tproperties: {\r\n\t\tfoo: { type: \"string\", nullable: true },\r\n\t},\r\n\trequired: [\"foo\"],\r\n};\r\n\r\nvoid schema;\r\n```\r\n\r\nIn my case ajv was coercing `null` values to `0` since the nullable field was an integer -- by adding `?` I was able to add `nullable: true` and ajv also stopped coercing.","createdAt":"2024-01-17T21:22:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-1896786116","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM54Qsxu","author":{"login":"k-kirill-s"},"authorAssociation":"NONE","body":"Hello everyone, who is encountered this issue!\r\nWhat helped me here to get rid of this issue at least temporary:\r\n\r\n1. Use normal scheme links, no need for ? or something else, like it was done in the initial issue message \r\n> ```ts\r\n> import { JSONSchemaType } from \"ajv\";\r\n> \r\n> const schema: JSONSchemaType<{ foo: string | null }> = {\r\n> \ttype: \"object\",\r\n> \tproperties: {\r\n> \t\tfoo: { type: \"string\", nullable: true },\r\n> \t},\r\n> \trequired: [\"foo\"],\r\n> };\r\n> \r\n> void schema;\r\n> ```\r\n3. Use `ajv` version `8.11.0`\r\n4. Use `typescript` version `5.0.4`: for example `typescript 5.2.2` proceeded reproduce this issue even with previously mentioned item.\r\n\r\nOverall, looks like issue connected not only with ajv, but with typescript dependency changes too, unfortunately, there is not enough time for taking deeper look into possible reasons. Hope, that it will help someone to resolve it locally in your projects and maybe found the root cause and fix it in the next update.\r\n\r\n\r\n","createdAt":"2024-03-25T10:09:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2017643630","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM58URhv","author":{"login":"nicemaker"},"authorAssociation":"NONE","body":"I will top this all with this workaround:\r\n```\r\n  { type: 'string', nullable: true as false }\r\n```\r\nJust see it as a Zen Koan","createdAt":"2024-04-30T15:34:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"LAUGH","users":{"totalCount":8}},{"content":"HEART","users":{"totalCount":3}}],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2085689455","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6G_v4L","author":{"login":"StefanR23"},"authorAssociation":"NONE","body":"And if you embed this into another schema within `$defs` you must not use 'nullable' (8.17.1)\r\n\r\ne.g.  \r\n``` \r\n$defs : { \r\n   xyz: {  \r\n      properties:  {\r\n         value : {  oneOf: [schema]  } }\r\n```\r\n\r\nnow I have to duplicate the code \r\n\r\nat least the behavior must be consistent to follow the DRY principle.","createdAt":"2024-08-02T08:32:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2264858123","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6IEdA-","author":{"login":"johanbook"},"authorAssociation":"NONE","body":"Ran into this issue as well using ajv v8.12.0 and Typescript v5.3.3\r\n","createdAt":"2024-08-11T19:46:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2282868798","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6JSK2X","author":{"login":"OzzieOrca"},"authorAssociation":"NONE","body":"I encountered this after following OpenAI's suggestions to use null unions https://platform.openai.com/docs/guides/structured-outputs/all-fields-must-be-required. I'm not sure how to specify the field in the `required` array and also have it be nullable (either with a null union or `nullable: true`) in a way that makes TypeScript happy.","createdAt":"2024-08-21T22:46:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2303241623","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6hmOZ8","author":{"login":"alex-redcan"},"authorAssociation":"NONE","body":"Same issue here, specifically when looking at using AJV to define JSON schemas for OpenAI structured outputs. I downgraded to 8.11.0 and the type error went away.","createdAt":"2025-03-10T16:24:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2711152252","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6rhr2A","author":{"login":"sushmitg"},"authorAssociation":"NONE","body":"Similar issue. Can't figure out what's the issue:\n\n```\nexport type LabelValueType = {\n  value: string;\n  label: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [rest: string]: any;\n};\n\ntype FilterFormData = {\n  tripCodes?: LabelValueType | LabelValueType[] | null;\n};\n\n// Schema for validation\nconst filterSchema: JSONSchemaType<FilterFormData> = {\n  type: 'object',\n  properties: {\n    tripCodes: {\n      type: 'array',\n      items: {\n        type: 'object',\n        properties: {\n          value: { type: 'string' },\n          label: { type: 'string' },\n        },\n        required: ['value', 'label'],\n      },\n      nullable: true,\n    },\n  },\n  required: ['tripCodes'],\n};\n```\n\n<img width=\"966\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/4b89086b-2473-468b-81d0-d2d846504860\" />\n\nWith Nullable: \n\n```\nexport type LabelValueType = {\n  value: string; // <== also tried \"string | null\" here but same error\n  label: string; // <== also tried \"string | null\" here but same error\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  [rest: string]: any;\n};\n\ntype FilterFormData = {\n  tripCodes?: LabelValueType | LabelValueType[] | null;\n};\n\n// Schema for validation\nconst filterSchema: JSONSchemaType<FilterFormData> = {\n  type: 'object',\n  properties: {\n    tripCodes: {\n      type: 'array',\n      items: {\n        type: 'object',\n        properties: {\n          value: { type: 'string', nullable: true },\n          label: { type: 'string', nullable: true },\n        },\n        additionalProperties: true,\n        required: ['value', 'label'],\n      },\n      nullable: true,\n    },\n  },\n  required: ['tripCodes'],\n};\n```\n\nhttps://ibb.co/4gnB2kF7","createdAt":"2025-05-13T19:37:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2163#issuecomment-2877734272","viewerDidAuthor":false}],"createdAt":"2022-11-14T13:07:25Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"}],"number":2163,"title":"JSONSchemaType doesn't infer nullable types "},{"body":"\r\n**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n8.11.0\r\n\r\n**Ajv options object**\r\n\r\n```javascript\r\n{}\r\n```\r\n\r\n**JSON Schema**\r\n```javascript\r\nconst schema = {\r\n  type: 'object',\r\n  properties: {\r\n    notUndefinedString: {\r\n      type: 'string',\r\n    },\r\n  },\r\n  required: [],\r\n};\r\n```\r\n\r\n**Sample data**\r\n\r\n```javascript\r\nconst testObject = {\r\n  notUndefinedString: undefined,\r\n};\r\n```\r\n\r\n**Code, validation result**\r\n\r\n```javascript\r\nconst ajvValid = ajv.validate(schema, testObject);\r\nconsole.log('ajv -> is valid: ', ajvValid); // true, but should be false!\r\n```\r\n\r\n\r\n**What results did you expect?**\r\nI expected the validation to fail.\r\n\r\nIf I analyze an object with explicit undefined fields (even the not required ones), I want the JSON Schema validation to fail.\r\n\r\nIt works as expected using z-schema package or other online JSON schema validators, but not with ajv.\r\n\r\nCan I have the same behavior with ajv?\r\n\r\n\r\nworking code running here: https://stackblitz.com/edit/node-ajv-vs-zschema-example?file=index.js","comments":[{"id":"IC_kwDOAiQBJM5OP7ub","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Undefined fields in most contexts (not all though, there is some inconsistency) are treated as absent.\r\n\r\nThe rationale for this design choice is that the are not converted to JSON so if you do validation of say API results that contain some undefined fields you don't want validation to fail, as it won't make it into JSON anyway.\r\n\r\nIf you mark it as required in the schema the validation will fail.\r\n\r\n","createdAt":"2022-11-13T19:08:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2152#issuecomment-1312799643","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OSHdK","author":{"login":"Giuseppedes"},"authorAssociation":"NONE","body":"It's true that converting it to JSON will not have that property, but in our use case, we use it directly in the code. It would be great if there were an option for handling this.","createdAt":"2022-11-14T09:33:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2152#issuecomment-1313371978","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OSaRc","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"There was a discussion in some other issue about more comprehensive handling of undefined, if this option is added it has to be consistent for all keywords, so it's not a tiny change â€“ can only go in v9 (as currently it's inconsistent already, so it's a breaking change...)","createdAt":"2022-11-14T10:32:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/ajv-validator/ajv/issues/2152#issuecomment-1313449052","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OSal_","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"#937 #1287","createdAt":"2022-11-14T10:33:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2152#issuecomment-1313450367","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5a1xLl","author":{"login":"allegramarie"},"authorAssociation":"NONE","body":"Related to this issue, if the data coming in is `undefined` there's a difference in validation behavior if the schema is of type `object` or not. Is this a limitation as well or something to be addressed in v9? example: https://runkit.com/amb/ajv-issue-913","createdAt":"2023-04-26T21:04:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2152#issuecomment-1524044517","viewerDidAuthor":false}],"createdAt":"2022-11-02T13:14:29Z","labels":[{"id":"MDU6TGFiZWwzMzIwNjE3NDI=","name":"limitation","description":"","color":"fad8c7"}],"number":2152,"title":"fail validation in case of undefined field"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv you are you using?**\r\n8.11.0\r\n**What problem do you want to solve?**\r\nRemove redundancy of in-lining the de-serialized schemas, if only because my codegen setup already in-lines them as a separate module. So I'd rather prefer AJV codegen using references to them, instead of putting everything into the final module. Will also reduce the diffs for codegen operations, as I ended up in a situation where a change in a single utility schema ended up changing 80+ files.\r\n**What do you think is the correct solution to problem?**\r\nAdd an optional `refModuleMap` key to the `CodeOptions` which would involve these types:\r\n```typescript\r\n/**\r\n * A map of `\"$ref\"`s and their related module import data.\r\n * The key is a `\"$ref\"` value.\r\n */\r\ninterface IRefModuleMap extends Map<string, IModuleImport> {}\r\n\r\ninterface IModuleImport {\r\n  /**\r\n   * The imported symbol name.\r\n   */\r\n  name: string\r\n  /**\r\n   * The alias of the symbol.\r\n   */\r\n  alias?: string\r\n  /**\r\n   * The path to the module.\r\n   */\r\n  path: string\r\n}\r\n```\r\n\r\nI don't know the specifics of the AJV codegen, but looking at the output and its indexed symbol names it does look like it keeps track of the scope's namespace to avoid collisions. Due to imports being the first thing in the module, the procedure would only require checking for the existence of the module map at the start. Then it would generate import statements for the related refs to the module and insert the names/aliases to the scope. At this point the rest of the logic won't change.\r\nDue to it being an optional addition I think it will be a minor version increase at most.\r\n**Will you be able to implement it?**\r\nIf it works the way I described above, sure.","comments":[],"createdAt":"2022-10-22T12:15:18Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2141,"title":"Codegen: allow passing import symbols for deserialized schemas"},{"body":"**What version of Ajv you are you using?**\r\n8.11.0\r\n\r\n**What problem do you want to solve?**\r\nIf `compile` function called with same by-value, but not by-ref object, it can cause cache overflow and memory leakage.\r\n```\r\nconst getSchema = () => ({ type: 'object' });\r\nconst schema1 = getSchema();\r\nconst schema2 = getSchema();\r\nconsole.log('schemas are equal by-ref? ', schema1 === schema2);\r\n\r\n// caching is not actually works down here\r\n// Map is growing, nothing cleans it\r\najv.compile(schema1);\r\najv.compile(schema2);\r\najv.compile(getSchema());\r\n...\r\najv.compile(getSchema());\r\n```\r\n\r\n\r\n**What do you think is the correct solution to problem?**\r\nImplement WeakMap instead of Map class.\r\n\r\n**Will you be able to implement it?**\r\nI'll attach the pull request.\r\n","comments":[{"id":"IC_kwDOAiQBJM5MVR59","author":{"login":"stepanho"},"authorAssociation":"NONE","body":"Pull request: https://github.com/ajv-validator/ajv/pull/2135","createdAt":"2022-10-17T10:33:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2134#issuecomment-1280646781","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5NgFom","author":{"login":"sempasha"},"authorAssociation":"NONE","body":"Pull request would be useful to accept. This is good practice to use WeakMap for caching purpose rather then plain Maps. In opposite to plain Map, WeakMap does not hold extra references for its keys, so it does not prevent garbage collector to release memory allocated by keys.\r\n\r\nOf course good practice is to avoid schema object duplication (e.g. single object for single schema). But there are some scenarios where cache is not applicable, for example schema could be variable object with short life time.\r\n\r\nThere are plenty issues caused by Map based cache - #1413 #1879 #1763 #1763.","createdAt":"2022-11-02T12:16:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2134#issuecomment-1300257318","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5OP8Nc","author":{"login":"epoberezkin"},"authorAssociation":"MEMBER","body":"Possibly, a better solution to let users configure which cache to use - as it was in the previous versions...\r\n\r\nThe problem with using WeakMap by default is that it would mask the cases of incorrect schema usages, when the same schema is recompiled, eliminating any benefits of the compilation, while a memory leak helped detecting these issues in most cases.\r\n\r\nAlso, for cases where schema is dynamic and used only once (or maybe a few times) using compilation is suboptimal, it is more efficient to simply use interpreting validator...","createdAt":"2022-11-13T19:19:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2134#issuecomment-1312801628","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM5UYjfq","author":{"login":"sempasha"},"authorAssociation":"NONE","body":"@epoberezkin do you mean cache option introduced by [0.7.0](https://github.com/ajv-validator/ajv/releases/tag/0.7.0)?\r\n\r\n>  If cache instance is supplied it must have put, get and del methods.","createdAt":"2023-02-03T11:10:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2134#issuecomment-1415722986","viewerDidAuthor":false}],"createdAt":"2022-10-17T10:28:54Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2134,"title":"Let users configure Cache to use for compiled schemas"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv you are you using?**\r\n8.11\r\n**What problem do you want to solve?**\r\nIt would be good:  minContains/maxContains keywords to be supported by the $data proposal\r\nAccording to the docs\r\n\r\n> $data reference is supported in the keywords: const, enum, format, maximum/minimum, exclusiveMaximum / exclusiveMinimum, maxLength / minLength, maxItems / minItems, maxProperties / minProperties, formatMaximum / formatMinimum, formatExclusiveMaximum / formatExclusiveMinimum, multipleOf, pattern, required, uniqueItems.\r\n\r\nThis yet doesn't include minContains/maxContains.\r\n\r\n**What do you think is the correct solution to problem?**\r\nImplement support for $data in minContains/maxContains keywords.\r\nFor example:\r\n```typescript\r\n{\r\n    \"type\": \"object\",\r\n    \"properties\": {\r\n        \"data\": {\r\n            \"type\": \"array\",\r\n            \"contains\": {\r\n                \"properties\": {\r\n                    \"foo\": {\r\n                        \"const\": \"bar\"\r\n                    }\r\n                }\r\n            },\r\n            \"minContains\": {\r\n                \"$data\": \"1/params/min_contains\"\r\n            }\r\n        },\r\n        \"params\": {\r\n            \"type\": \"object\",\r\n            \"properties\": {\r\n                \"min_contains\": {\r\n                    \"type\": \"integer\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n```\r\n**Will you be able to implement it?**\r\nNot sure, I'm quite new to this.","comments":[],"createdAt":"2022-10-13T20:44:53Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2130,"title":"$data support for minContains/maxContains"},{"body":"<!--\r\nFrequently Asked Questions: https://ajv.js.org/faq.html\r\nPlease provide all info and reduce your schema and data to the smallest possible size.\r\n\r\nThis template is for change proposals.\r\nFor other issues please see https://ajv.js.org/contributing/\r\n-->\r\n\r\n**What version of Ajv you are you using?**\r\nAJV-8\r\n\r\n**What problem do you want to solve?**\r\nI am a contributor to [React JSON Schema Form](https://github.com/rjsf-team/react-jsonschema-form) and we have a situation where we are using either AJV 6 or 8 in different circumstances. We are currently using `@types/json-schema` for the JSONSchema7 definition. We are wanting to be able to use the schema types from AJV in our Repos without pulling the whole of the AJV implementation\r\n\r\n**What do you think is the correct solution to problem?**\r\n\r\nExtract the Typescript definitions for Schemas (for JSONSchema7, 2019, 2020) into a new repo (e.g. ajv-schema-types, ajv-json-schemas or ajv-types) so that it can be imported without the overhead of the implementations\r\n\r\n**Will you be able to implement it?**\r\nPossibly","comments":[{"id":"IC_kwDOAiQBJM5iGitG","author":{"login":"zbayoff"},"authorAssociation":"NONE","body":"Second this issue as it would help us to fully type our json schema while using the React JSON Schema form library with AJV validation. ","createdAt":"2023-07-21T16:15:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2129#issuecomment-1645882182","viewerDidAuthor":false},{"id":"IC_kwDOAiQBJM6IjvAo","author":{"login":"TheOneTheOnlyJJ"},"authorAssociation":"NONE","body":"Is there any update on this? Having this done would improve the DX of many projects.","createdAt":"2024-08-15T10:55:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/ajv-validator/ajv/issues/2129#issuecomment-2291068968","viewerDidAuthor":false}],"createdAt":"2022-10-13T17:54:23Z","labels":[{"id":"MDU6TGFiZWwyMTM2Mzc5OTM=","name":"enhancement","description":"","color":"84b6eb"}],"number":2129,"title":"Extract Schema types to separate Repo"},{"body":"**What version of Ajv are you using? Does the issue happen if you use the latest version?**\r\n\r\n8.11.0 (latest)\r\n\r\n**Ajv options object**\r\n\r\n<!-- See https://ajv.js.org/options.html -->\r\n\r\n```javascript\r\n{allErrors: true, removeAdditional: true, useDefaults: true}\r\n```\r\n\r\n**JSON Schema**\r\n\r\nSee code example\r\n\r\n**Sample data**\r\n\r\nNot relevant as it's only related to type checking (ajv validation is working properly)\r\n\r\n**Your code**\r\n```ts\r\nimport Ajv, {JSONSchemaType} from 'ajv';\r\n\r\nconst ajv = new Ajv({allErrors: true, removeAdditional: true, useDefaults: true});\r\n\r\ntype Target = {\r\n    type: 'first' | 'second' | 'third';\r\n    commonParameter: string;\r\n}\r\n\r\ntype FirstTarget = Target & {\r\n    type: 'first';\r\n    specialParameter: string\r\n}\r\ntype SecondTarget = Target & {\r\n    type: 'second';\r\n    specialParameter: string\r\n}\r\ntype ThirdTarget = Target & {\r\n    type: 'second';\r\n}\r\n\r\n// Here typescript is complaining because specialParamer is not in the common section of the union\r\nvar schemaA: JSONSchemaType<FirstTarget | SecondTarget> = {\r\n    type: 'object',\r\n    properties: {\r\n        type: {\r\n            type: 'string'\r\n        },\r\n        commonParameter: {\r\n            type: 'string'\r\n        },\r\n        // If I uncomment those lines, typescript is not complaining anymore\r\n        // specialParameter: {\r\n        //     type: 'string'\r\n        // }\r\n    },\r\n    required: ['type', 'commonParameter'],\r\n    oneOf: [\r\n        {\r\n            type: 'object',\r\n            properties: {\r\n                type: {\r\n                    type: 'string',\r\n                    const: 'first',\r\n                },\r\n                specialParameter: {\r\n                    type: 'string'\r\n                }\r\n            },\r\n            required: ['type', 'specialParameter']\r\n        },\r\n        {\r\n            type: 'object',\r\n            properties: {\r\n                type: {\r\n                    type: 'string',\r\n                    const: 'second',\r\n                },\r\n                specialParameter: {\r\n                    type: 'string'\r\n                }\r\n            },\r\n            required: ['type', 'specialParameter']\r\n        }\r\n    ]\r\n}\r\n\r\n// Here typescript is not complaining because thridTarget does not contain \"specialParameter\"\r\nvar schemaB: JSONSchemaType<FirstTarget | SecondTarget | ThirdTarget> = {\r\n    type: 'object',\r\n    properties: {\r\n        type: {\r\n            type: 'string'\r\n        },\r\n        commonParameter: {\r\n            type: 'string'\r\n        }\r\n    },\r\n    required: ['type', 'commonParameter'],\r\n    oneOf: [\r\n        {\r\n            type: 'object',\r\n            properties: {\r\n                type: {\r\n                    type: 'string',\r\n                    const: 'first',\r\n                },\r\n                specialParameter: {\r\n                    type: 'string'\r\n                }\r\n            },\r\n            required: ['type', 'specialParameter']\r\n        },\r\n        {\r\n            type: 'object',\r\n            properties: {\r\n                type: {\r\n                    type: 'string',\r\n                    const: 'second',\r\n                },\r\n                specialParameter: {\r\n                    type: 'string'\r\n                }\r\n            },\r\n            required: ['type', 'specialParameter']\r\n        },\r\n        {\r\n            type: 'object',\r\n            properties: {\r\n                type: {\r\n                    type: 'string',\r\n                    const: 'third',\r\n                }\r\n            },\r\n            required: ['type']\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n**Playground Link:** [Provided](https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAQQFYDcA0cDeApAygeQDlcBjACwFMQBDAFQE8wKBfOAMyghDgHJrUeAbgBQwkhAB2AZ3j8UcALxwJFAO6JUACkzUANroCiUTlCkAuODCgBXChihUIKCggAmr4DGCS9Fq7YxrKQoAEQo2amtdGHNLGxYAShFhGEYKOFpqKABzCnglTGE4Yss0ix42YFMYHjgAH15g8QlXWoaeGDIq1pESuHEQEEkABSzqEDyKKAsZKGAJbJFmUVSmOAAxKplMnLzFDKzc+AAyLCKS1Ypyyuqhc+KpJhJgPVGoccnpuFn57OFly5wXAUZquHZHfbgvanQp9S7lJqSHr3b5PF66N4fGBTGZWX7-FJpDJdKBgw57JRQk5nOFlRogpF3ZbCFBZb7kKjUBAWPBEUiUGgMJgAHk21Sp9SBDJaVIAfPtYRc6TwIAAjJAgmpoFFgThMWDACixRV9Yrwmmmy3mng-BY8FF9Zjay3FAZDCSYibYr4ml1m5W27L2v3LR3OkoOACO1iqFFcFgA2h00jwMDw3SMxl6pjwALrh4qSCj4NiJh0lX1+61qjUkLXly26iD6rxGiyVv1Kpjthud2ndxp4u0Fvsu5oya5beuj01O3t+x4g9Gez49mdVgNDoPzl2h0dzmdRmMOeNwJOXVONNGvLOfPO9g8ujtW5U1zWpnfFJstw3Gz+m81n3Xa1Aw-dcx0kCd6VBMDwLgR9wMXZ4b3ebMfX-DcBxtLdgzgvc+wQzsj1jU9zxTNMkOXW9vXvEMUVzAkWTZKQORoAAhHkCGIVi6DSUUpwlBpgVBQTiW6OUFRRat1XfEdvymVs-0wq4LT7ECcIfEc+gzD1qJxVTO3UuY7QfFFCOIk9E2TJhL3TLh3RXGj8xRIsSzLP0gP7FSVRkutYL7eSDTbAyZ0AjCXSM35-Lg11IJgSdbi0-ckr7SiUKxfTPNHSKTJi-DO0Iv0LLjKyLwo68MT0qBaN3FKQoi19fOnUdAsUtc4LCmKvIRHC6pncd4ugxk+tq8KHgqxzMrGgDN2M7c8v-QqXWK0jrIoWy0sq1C7wYkM6qy-0sLfPyRq-PUFN-drwM6rrDu80DTs7Abyk6bpopnfK9v-FbSpTXbd3o-4gA)\r\n\r\n\r\n**Validation result, data AFTER validation, error messages**\r\n\r\nDon't hesitate to go to the playground as the error is pretty clear.\r\n\r\n**What results did you expect?**\r\n\r\ntypescript should not complain about the fact that \"specialParameter\" is not in the common properties of the union\r\n\r\n**Are you going to resolve the issue?**","comments":[],"createdAt":"2022-10-07T09:27:45Z","labels":[{"id":"MDU6TGFiZWw3MTk3NzEwOTA=","name":"typescript","description":"","color":"8de25f"},{"id":"MDU6TGFiZWwxNDM5MTI2NDY0","name":"bug report","description":"","color":"df2929"}],"number":2122,"title":"Type checking of common parameters in union type is not working properly"}]
